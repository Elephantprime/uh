<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>UNHINGED ‚Äî Chat</title>
<style>
  :root{--red:#E11D2A}
  *{box-sizing:border-box}
  body{margin:0;background:#0f0f12;color:#fff;font:500 16px/1.5 Inter,system-ui}
  a{color:#fff;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .top{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .pill{padding:8px 12px;background:#1a1b22;border:1px solid rgba(255,255,255,.08);border-radius:999px}
  h1{margin:6px 0 2px;font-size:26px;font-weight:900}
  .sub{color:#cfd0de}
  select,button,input{background:#12131a;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:10px}
  button{cursor:pointer;font-weight:800}
  .card{background:#15161b;border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}
  .msgs{height:56vh;overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;background:#0e0f14}
  .msg{margin:8px 0}
  .me{color:#8ff79d} .other{color:#e3e3ea}
  .meta{font-size:12px;color:#9aa0aa}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  .inputbar{display:flex;gap:8px;margin-top:10px}
  .inputbar input{flex:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <a class="pill" href="index.html">‚Üê Home</a>
    <a class="pill" href="badges.html">üèÖ Badges</a>
    <a class="pill" href="redflags.html">üö© Red Flags</a>
    <button id="logout" class="pill" style="border-color:#E11D2A">Logout</button>
  </div>

  <h1>Community Chat</h1>
  <div id="status" class="sub">Connecting‚Ä¶</div>

  <div class="row">
    <select id="room">
      <option value="lobby">#lobby</option>
      <option value="dating">#dating</option>
      <option value="friends">#friends</option>
      <option value="fwb">#fwb</option>
      <option value="vents">#vents</option>
    </select>
  </div>

  <div class="card">
    <div id="feed" class="msgs" aria-live="polite"></div>
    <div class="inputbar">
      <input id="text" placeholder="Type a message‚Ä¶">
      <button id="send">Send</button>
    </div>
  </div>
</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    collection, addDoc, serverTimestamp,
    query, where, orderBy, onSnapshot, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const roomSel = document.getElementById('room');
  const status  = document.getElementById('status');
  const feed    = document.getElementById('feed');
  const text    = document.getElementById('text');
  const sendBtn = document.getElementById('send');

  let room = roomSel.value || 'lobby';
  let displayName = 'Member';
  let stopListen = null;

  function bubble({ text, uid, displayName: dn, createdAt }) {
    const me = auth.currentUser?.uid && uid === auth.currentUser.uid;
    const el = document.createElement('div');
    el.className = 'msg';
    const when = createdAt?.seconds ? new Date(createdAt.seconds*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
    el.innerHTML = `
      <div class="${me?'me':'other'}"><strong>${dn || 'Member'}:</strong> ${text || ''}</div>
      <div class="meta">${when}</div>`;
    return el;
  }

  function listen(channel) {
    stopListen?.();
    feed.innerHTML = '';
    const q = query(
      collection(db, "messages"),
      where("channel","==", channel),
      orderBy("createdAt","asc"),
      limit(200)
    );
    stopListen = onSnapshot(q, (snap) => {
      feed.innerHTML = '';
      snap.forEach(d => feed.appendChild(bubble(d.data())));
      feed.scrollTop = feed.scrollHeight;
    });
  }

  async function send() {
    const v = text.value.trim();
    if (!v || !auth.currentUser) return;
    text.value = '';
    await addDoc(collection(db, "messages"), {
      text: v,
      channel: room,
      uid: auth.currentUser.uid,
      displayName: displayName,
      createdAt: serverTimestamp(),
    });
  }

  sendBtn.addEventListener('click', send);
  text.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') send(); });
  roomSel.addEventListener('change', (e)=>{
    room = e.target.value;
    status.textContent = `Connected as ${displayName} in #${room}`;
    if (auth.currentUser) listen(room);
  });

  onAuthStateChanged(auth, (user)=>{
    if (!user) { location.replace("./login.html"); return; }
    displayName = user.displayName || "Member";
    status.textContent = `Connected as ${displayName} in #${room}`;
    listen(room);
  });
</script>
</body>
</html>
