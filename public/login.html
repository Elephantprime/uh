<!DOCTYPE html>
<html lang="en">
<head>
  <!-- ===== SECTION: Head / Meta ===== -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unhinged — Log In</title>

  <!-- ===== SECTION: Styles (Design System) ===== -->
  <style>
    :root { --bg:#0e0e12; --panel:#15161b; --muted:#cfd0de; --red:#E11D2A; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
    a{color:#9ecbff;text-decoration:none}
    .wrap{width:100%;max-width:480px;padding:16px}
    .card{background:var(--panel);border:1px solid #2a2a2a;border-radius:14px;padding:18px}
    .brand{font-weight:800;margin-bottom:6px}
    .muted{color:var(--muted);font-size:.95rem;margin-bottom:12px}
    label{display:block;margin:.35rem 0 .25rem}
    input[type="email"],input[type="password"]{
      width:100%;padding:12px;border-radius:10px;border:1px solid #2a2a2a;background:#12131a;color:#fff
    }
    .row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .btn{border:none;background:var(--red);color:#fff;border-radius:10px;padding:.6rem 1.1rem;cursor:pointer}
    .btn.secondary{background:#2a2a2a}
    .status{margin-top:10px;font-size:.95rem}
    .ok{color:#9ae6b4}.err{color:#ff8e8e}.prog{color:#ffd27f}
    .foot{display:flex;justify-content:space-between;align-items:center;margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">Welcome back</div>
      <div class="muted">Sign in to continue.</div>

      <!-- ===== SECTION: Form ===== -->
      <form id="loginForm">
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" required />

        <label for="password">Password</label>
        <input id="password" type="password" autocomplete="current-password" required />

        <div class="row" style="margin-top:6px">
          <a id="forgot" href="#" title="Reset password">Forgot password?</a>
          <div></div>
        </div>

        <div class="actions">
          <button class="btn secondary" type="button" onclick="location.href='./index.html'">Cancel</button>
          <button class="btn" id="loginBtn" type="submit">Sign In</button>
        </div>
      </form>

      <div class="status" id="status"></div>

      <div class="foot">
        <span class="muted">No account?</span>
        <a href="./signup.html">Create one</a>
      </div>
    </div>
  </div>

  <!-- ===== SECTION: Scripts ===== -->
  <script type="module">
    /* ===== SECTION: Imports ===== */
    import { auth } from "./js/firebase.js";
    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    /* ===== SECTION: DOM Refs ===== */
    const form = document.getElementById("loginForm");
    const emailEl = document.getElementById("email");
    const pwdEl = document.getElementById("password");
    const statusEl = document.getElementById("status");
    const forgot = document.getElementById("forgot");
    const loginBtn = document.getElementById("loginBtn");

    /* ===== SECTION: Helper (UI) ===== */
    const show = (cls, msg) => statusEl.innerHTML = `<span class='${cls}'>${msg}</span>`;
    const errMap = (code) => ({
      "auth/invalid-email": "That email address looks invalid.",
      "auth/user-disabled": "This account has been disabled.",
      "auth/user-not-found": "No account found with that email.",
      "auth/wrong-password": "Incorrect password.",
      "auth/too-many-requests": "Too many attempts. Try again shortly.",
    }[code] || "Could not sign in. Please try again.");

    /* ===== SECTION: Auth — Auto-redirect if already signed in ===== */
    onAuthStateChanged(auth, (u) => {
      if (u) {
        // already signed in, go straight to profile
        location.replace("./profile.html");
      }
    });

    /* ===== SECTION: Handlers ===== */
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = emailEl.value.trim();
      const password = pwdEl.value;
      if (!email || !password) {
        show("err", "Email and password are required.");
        return;
      }
      loginBtn.disabled = true;
      show("prog", "Signing you in…");
      try {
        await signInWithEmailAndPassword(auth, email, password);
        show("ok", "Success. Redirecting…");
        location.replace("./profile.html");
      } catch (e) {
        show("err", errMap(e?.code));
      } finally {
        loginBtn.disabled = false;
      }
    });

    forgot.addEventListener("click", async (e) => {
      e.preventDefault();
      const email = emailEl.value.trim();
      if (!email) { show("err", "Enter your email first, then click ‘Forgot password?’"); return; }
      show("prog", "Sending reset email…");
      try {
        await sendPasswordResetEmail(auth, email);
        show("ok", "Password reset sent. Check your inbox.");
      } catch (e) {
        show("err", errMap(e?.code));
      }
    });
  </script>
</body>
</html>
