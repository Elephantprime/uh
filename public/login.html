<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Unhinged — Sign In</title>
  <style>
    :root{--bg:#0e0e12;--card:#16171d;--border:#2a2a2a;--fg:#fff;--muted:#cfd0de;--accent:#E11D2A}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:500 16px/1.5 Inter,system-ui}
    .wrap{max-width:420px;margin:0 auto;padding:28px}
    h1{margin:12px 0 18px;font-size:26px;font-weight:900;text-align:center}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:18px}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}
    input,button{width:100%;padding:12px;border-radius:10px;border:1px solid var(--border);background:#12131a;color:#fff}
    button{background:var(--accent);border:none;font-weight:800;cursor:pointer;margin-top:10px}
    button:disabled{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;margin-top:10px}
    .muted{color:var(--muted);font-size:13px;text-align:center;margin-top:10px;min-height:1.3em}
    a{color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Sign In</h1>
    <div class="card">
      <label for="email">Email</label>
      <input id="email" type="email" autocomplete="username" placeholder="you@example.com" />

      <label for="password">Password</label>
      <input id="password" type="password" autocomplete="current-password" placeholder="••••••••" />

      <button id="signin">Sign In</button>
      <div class="row">
        <button id="forgot" type="button" style="background:#1f2028;border:1px solid var(--border);font-weight:600">Forgot Password</button>
        <a href="signup.html" style="display:inline-block;flex:1;text-align:center;padding:12px;border:1px solid var(--border);border-radius:10px;background:#1f2028;font-weight:600">Create Account</a>
      </div>

      <div id="status" class="muted"></div>
    </div>
  </div>

  <script type="module">
    // Uses your shared Firebase bootstrap (must export { app, auth, db })
    import { auth, db } from "./js/firebase.js";
    import {
      onAuthStateChanged,
      signInWithEmailAndPassword,
      sendPasswordResetEmail
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      doc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------- helpers ----------
    const $ = (id)=>document.getElementById(id);
    const email   = $("email");
    const pass    = $("password");
    const signin  = $("signin");
    const forgot  = $("forgot");
    const status  = $("status");

    const busy = (b)=>{
      signin.disabled = b;
      signin.textContent = b ? "Signing in…" : "Sign In";
    };

    const saveProfile = async (user)=>{
      // create/update the user's profile doc on every successful login
      await setDoc(doc(db, "profiles", user.uid), {
        uid: user.uid,
        email: user.email || null,
        displayName: user.displayName || "Member",
        photoURL: user.photoURL || null,
        updatedAt: serverTimestamp()
      }, { merge: true });
    };

    // ---------- actions ----------
    signin.addEventListener("click", async ()=>{
      const em = (email.value || "").trim();
      const pw = pass.value || "";
      if (!em || !pw) { status.textContent = "Enter email and password."; return; }

      try {
        busy(true); status.textContent = "";
        const cred = await signInWithEmailAndPassword(auth, em, pw);
        await saveProfile(cred.user);
        // send to *their* profile page (uid in query)
        location.replace(`profile.html?uid=${encodeURIComponent(cred.user.uid)}`);
      } catch (err) {
        console.error(err);
        status.textContent = err?.message || "Could not sign in.";
      } finally {
        busy(false);
      }
    });

    forgot.addEventListener("click", async ()=>{
      const em = (email.value || "").trim();
      if (!em) { status.textContent = "Enter your email first."; return; }
      try {
        status.textContent = "Sending reset email…";
        await sendPasswordResetEmail(auth, em);
        status.textContent = "Password reset sent. Check your inbox.";
      } catch (err) {
        console.error(err);
        status.textContent = err?.message || "Could not send reset email.";
      }
    });

    // If already signed in, skip this page
    onAuthStateChanged(auth, (user)=>{
      if (user) {
        location.replace(`profile.html?uid=${encodeURIComponent(user.uid)}`);
      }
    });
  </script>
</body>
</html>
