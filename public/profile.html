<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unhinged — Profile</title>
  <style>
    body{font-family:Arial, sans-serif;max-width:700px;margin:0 auto;padding:2rem;background:#0e0e12;color:#fff}
    header{display:flex;justify-content:space-between;align-items:center}
    button{padding:.55rem .9rem;border:none;background:#E11D2A;color:#fff;border-radius:6px;cursor:pointer}
    .card{margin-top:1rem;padding:1rem;border:1px solid #2a2a2a;border-radius:8px;background:#15161b}
    label{display:block;margin:.5rem 0 .25rem}
    input,textarea{width:100%;padding:.6rem;border:1px solid #2a2a2a;border-radius:6px;background:#12131a;color:#fff}
    .muted{color:#cfd0de}
  </style>
</head>
<body>
  <header>
    <h1>Your Profile</h1>
    <div>
      <button id="logout">Sign out</button>
    </div>
  </header>

  <div id="status" class="muted"></div>

  <section class="card">
    <h2 id="name">Loading…</h2>
    <p id="bio" class="muted"></p>
    <p class="muted" id="uidline"></p>
  </section>

  <section class="card">
    <h3>Edit</h3>
    <form id="edit-form">
      <label for="displayName">Display name</label>
      <input id="displayName" type="text" />
      <label for="bioInput">Bio</label>
      <textarea id="bioInput" rows="4"></textarea>
      <button type="submit">Save</button>
      <span id="save-status" class="muted" style="margin-left:.6rem"></span>
    </form>
  </section>

  <script type="module">
    import { auth } from "./js/firebase.js";
    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const $ = id => document.getElementById(id);
    const statusEl = $("status");
    const nameEl = $("name");
    const bioEl = $("bio");
    const uidLine = $("uidline");
    const form = $("edit-form");
    const disp = $("displayName");
    const bioInput = $("bioInput");
    const logoutBtn = $("logout");

    const params = new URLSearchParams(location.search);
    const urlUid = params.get("uid")?.trim() || "";

    const db = getFirestore();

    function toLogin(){ location.replace("./login.html"); }
    function toOwnProfile(uid){
      const here = new URL(location.href);
      if (here.searchParams.get("uid") !== uid) {
        location.replace(`./profile.html?uid=${encodeURIComponent(uid)}`);
      }
    }

    // Load & enforce ownership
    onAuthStateChanged(auth, async (user) => {
      if (!user) { toLogin(); return; }

      // If no uid in URL, normalize to the signed-in user’s page
      if (!urlUid) { toOwnProfile(user.uid); return; }

      // Optionally enforce: only let users view their own profile page
      if (user.uid !== urlUid) {
        // If you want public profiles later, remove this guard.
        toOwnProfile(user.uid);
        return;
      }

      uidLine.textContent = `UID: ${user.uid}`;
      await loadOrCreateProfile(user.uid);
    });

    async function loadOrCreateProfile(uid){
      statusEl.textContent = "Loading profile…";
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        // Create a minimal profile on first visit
        await setDoc(ref, {
          displayName: (auth.currentUser.displayName || "").trim() || "New User",
          bio: ""
        });
      }

      const data = (await getDoc(ref)).data();
      nameEl.textContent = data.displayName || "No name yet";
      bioEl.textContent = data.bio || "No bio yet.";
      disp.value = data.displayName || "";
      bioInput.value = data.bio || "";
      statusEl.textContent = "";
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      $("save-status").textContent = "Saving…";
      const uid = new URLSearchParams(location.search).get("uid");
      const ref = doc(db, "users", uid);
      await updateDoc(ref, {
        displayName: disp.value.trim(),
        bio: bioInput.value.trim()
      });
      nameEl.textContent = disp.value.trim() || "No name yet";
      bioEl.textContent = bioInput.value.trim() || "No bio yet.";
      $("save-status").textContent = "Saved";
      setTimeout(()=> $("save-status").textContent = "", 1200);
    });

    logoutBtn.addEventListener("click", async ()=>{
      await signOut(auth);
      toLogin();
    });
  </script>
</body>
</html>
