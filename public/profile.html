<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unhinged - Profile</title>

    <style>
      :root {
        --bg: #0e0e12;
        --panel: #15161b;
        --muted: #cfd0de;
        --red: #E11D2A;
        --green: #4CAF50;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Buttons */
      .btn {
        border: none;
        background: var(--red);
        color: #fff;
        padding: 0.5rem 0.9rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      /* Lighten the secondary buttons for better contrast */
      .btn.secondary {
        background: #3a3a3a;
        color: #fff;
      }
      /* Lighten ghost button border for contrast */
      .btn.ghost {
        background: transparent;
        border: 1px solid #444;
      }
      .btn.pill {
        border-radius: 16px;
        padding: 0.55rem 1rem;
      }
      .btn.small {
        padding: 0.35rem 0.7rem;
        font-size: 0.9rem;
      }
      .chaos-btn {
        background: var(--red);
        color: #fff;
        border: none;
        border-radius: 16px;
        padding: 8px 16px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Text helpers */
      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* ===== SECTION: Top Bar ===== */
      .topbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--panel);
        border-bottom: 1px solid #2a2a2a;
      }
      .brand {
        font-weight: 700;
      }
      .nav-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      /* ===== SECTION: Content Wrapper ===== */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        gap: 12px;
        width: 100%;
      }

      /* ===== SECTION: Swipe Card ===== */
      .card-frame {
        position: relative;
        width: 92%;
        max-width: 420px;
        height: 72vh;
        border: 2px solid #2a2a2a;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        touch-action: pan-y;
      }
      .main-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        user-select: none;
        -webkit-user-drag: none;
        cursor: pointer;
      }
      .info-overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 14px 16px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.78));
        pointer-events: none;
      }
      .info-overlay h2 {
        margin: 0;
        font-size: 1.4rem;
      }
      .handle {
        font-size: 0.95rem;
        color: #cfd0de;
        margin-top: 2px;
      }
      .sub {
        font-size: 0.9rem;
        color: #ddd;
        margin-top: 2px;
      }
      .badges,
      .flags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }
      .badges img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #4cafef;
        background: #2a2a3a;
        padding: 2px;
      }
      .flags .flag-pill {
        font-size: 0.75rem;
        border: 1px solid #3a3b44;
        border-radius: 999px;
        padding: 2px 8px;
        background: #14151a;
      }
      .indicator {
        position: absolute;
        top: 16px;
        font-size: 1.4rem;
        font-weight: 700;
        padding: 6px 12px;
        border: 3px solid;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.12s ease;
      }
      .indicator.pass {
        left: 14px;
        color: var(--red);
        border-color: var(--red);
        transform: rotate(-18deg);
      }
      .indicator.like {
        right: 14px;
        color: var(--green);
        border-color: var(--green);
        transform: rotate(18deg);
      }
      .empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ddd;
        font-size: 1.1rem;
      }

      /* ===== SECTION: Bottom Actions ===== */
      .actions {
        width: 100%;
        max-width: 480px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0 16px;
        position: relative;
        z-index: 20;
      }
      .action-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pass-btn {
        background: #2a2a2a;
        color: var(--red);
      }
      .like-btn {
        background: #2a2a2a;
        color: var(--green);
      }

      /* ===== SECTION: Modal Base ===== */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 60;
      }
      .modal {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 1rem;
      }
      .modal h3 {
        margin: 0 0 0.5rem;
      }
      label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0.5rem 0 0.25rem;
      }
      .req {
        color: #ff6b6b;
        font-weight: 700;
      }
      input[type='text'],
      textarea,
      input[type='number'],
      select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        background: #12131a;
        color: #fff;
      }
      .row {
        display: flex;
        gap: 0.5rem;
      }
      .row > * {
        flex: 1;
      }
      .status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
      .ok {
        color: #6fdc8c;
      }
      .err {
        color: #ff8e8e;
      }
      .prog {
        color: #ffd27f;
      }
      .invalid {
        outline: 2px solid #ff6b6b;
        outline-offset: 2px;
        border-color: #ff6b6b !important;
      }

      /* Gallery */
      .gallery {
        margin-top: 0.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
        gap: 8px;
      }
      .thumb {
        position: relative;
        width: 100%;
        padding-top: 100%;
        border: 2px solid #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        background: #0b0b0f;
        cursor: pointer;
      }
      .thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .label-pill {
        position: absolute;
        left: 6px;
        top: 6px;
        font-size: 0.7rem;
        background: #000000aa;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid #2a2a2a;
      }
      .thumb.primary {
        border-color: var(--red);
      }
      .hint {
        font-size: 0.85rem;
        color: #cfd0de;
        margin-top: 0.25rem;
      }

      /* ===== INBOX / GATING ===== */
      .inbox-btn {
        background: #2a2a2a;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.5rem 0.8rem;
        cursor: pointer;
      }
      .inbox-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 80;
      }
      .inbox-card {
        width: 100%;
        max-width: 900px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 12px;
      }
      .inbox-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      /* Lighten the inbox tab colours for readability */
      .inbox-tab {
        border: 1px solid #444;
        background: #3a3a3a;
        border-radius: 999px;
        padding: 0.45rem 0.8rem;
        cursor: pointer;
        color: #fff;
      }
      .inbox-tab.active {
        border-color: var(--red);
        background: #4a4a4a;
        box-shadow: 0 0 0 2px #E11D2A33 inset;
      }
      .inbox-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 10px;
        min-height: 160px;
      }
      .inbox-item {
        position: relative;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        overflow: hidden;
        background: #111;
      }
      .inbox-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
      }
      .inbox-meta {
        padding: 8px;
      }
      .inbox-name {
        font-weight: 700;
      }
      .inbox-sub {
        font-size: 0.9rem;
        color: #cfd0de;
      }
      .locked .blur {
        filter: blur(6px);
      }
      .lock-badge {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(#0000, #0008);
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.3px;
        text-align: center;
        padding: 8px;
      }
      .lock-msg {
        background: #E11D2A;
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        cursor: pointer;
        margin-top: 0.5rem;
      }

      /* ===== CHAT MODAL ===== */
      .chat-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 90;
      }
      .chat-card {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        height: 75vh;
      }
      .chat-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #2a2a2a;
      }
      .chat-scroll {
        flex: 1;
        overflow: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .bubble {
        max-width: 70%;
        padding: 8px 10px;
        border-radius: 12px;
      }
      .bubble.me {
        align-self: flex-end;
        background: #E11D2A;
        color: #fff;
      }
      .bubble.them {
        align-self: flex-start;
        background: #2a2a2a;
      }
      .chat-send {
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #2a2a2a;
      }
      .chat-send input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        background: #12131a;
        border: 1px solid #2a2a2a;
        color: #fff;
      }
    </style>
  </head>
  <body>

    <div class="topbar">
      <div class="brand" id="topLine">Your Profile</div>
      <div class="nav-actions">
        <button
          class="btn secondary"
          id="filterBtn"
          type="button"
        >
          Filter
        </button>

        <button
          class="btn secondary inbox-btn"
          id="inboxBtn"
          type="button"
        >
          Inbox
        </button>
        <button class="btn danger" id="browseBtn" type="button">Browse Matches</button>

        <button class="btn secondary" id="casualtiesBtn" type="button">
          Casualties Upload
        </button>

        <a class="chaos-btn" href="./app.html">Community Chaos</a>

        <button class="btn secondary" id="myProfileBtn" type="button">
          My Profile
        </button>
        <button class="btn secondary" id="upgradeBtn" type="button">Go Paid</button>

        <button
          class="btn"
          id="editBtn"
          type="button"
        >
          Edit Profile
        </button>

        <button class="btn secondary" id="logoutBtn" type="button">Logout</button>
        <button
          class="btn ghost"
          id="deleteBtn"
          type="button"
          title="Delete my account"
        >
          Delete
        </button>
      </div>
    </div>

    <div class="modal-backdrop" id="casualtiesModal">
      <div class="modal">
        <h3>Casualties of Modern Dating</h3>
        <div id="casualtiesPwdSection">
          <label for="casualtiesPassword">Enter password:</label>
          <input id="casualtiesPassword" type="password" />
          <button class="btn" id="casualtiesCheckBtn" type="button">Check</button>
        </div>
        <div id="casualtiesUploadSection" style="display: none;">
          <label for="casualtiesFile">Upload image:</label>
          <input id="casualtiesFile" type="file" accept="image/*" />
          <label for="casualtiesCaption">Caption (optional):</label>
          <input id="casualtiesCaption" type="text" placeholder="Caption" />
          <button class="btn" id="casualtiesSubmit" type="button">Upload</button>
        </div>
        <button class="btn secondary" id="closeCasualties" type="button">
          Close
        </button>
      </div>
    </div>

    <div class="content">
      <div class="card-frame" id="cardFrame">
        <img class="main-photo" id="main-photo" src="" alt="Profile Photo" />
        <div class="info-overlay">
          <h2 id="name"></h2>
          <div class="handle" id="handle"></div>
          <div class="sub" id="sub-info"></div>
          <div class="badges" id="badges"></div>
          <div class="flags" id="flags"></div>
        </div>
        <div class="indicator pass" id="pass-indicator">PASS</div>
        <div class="indicator like" id="like-indicator">LIKE</div>
        <div class="empty" id="empty" style="display: none;">No more matches</div>
      </div>

      <div class="actions">
        <button class="action-btn pass-btn" id="pass-btn" aria-label="Pass">
          Pass
        </button>
        <button class="chaos-btn" onclick="location.href='./app.html'">
          Community Chaos
        </button>
        <button class="action-btn like-btn" id="like-btn" aria-label="Like">
          Like
        </button>
      </div>
    </div>

    <div class="modal-backdrop" id="editModal">
      <div class="modal">
        <h3>Edit Profile</h3>
        <div class="muted" id="uidLine"></div>

        <div class="row">
          <div>
            <label for="displayName">
              Display name
              <span class="req" id="reqDisplayName" hidden>*</span>
            </label>
            <input id="displayName" type="text" />
          </div>
          <div>
            <label for="username">Username</label>
            <input id="username" type="text" placeholder="yourhandle" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="age">
              Age
              <span class="req" id="reqAge" hidden>*</span>
            </label>
            <input id="age" type="number" min="18" max="100" />
          </div>
          <div>
            <label for="location">
              Location
              <span class="req" id="reqLocation" hidden>*</span>
            </label>
            <input id="location" type="text" placeholder="City, State" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="">Prefer not to say</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label for="hobbies">Hobbies</label>
            <input id="hobbies" type="text" placeholder="e.g., hiking, gaming" />
          </div>
          <div>
            <label for="interests">Interests</label>
            <input id="interests" type="text" placeholder="e.g., live music, travel" />
          </div>
        </div>

        <label for="bio">Bio</label>
        <textarea id="bio" rows="3" placeholder="Say something..."></textarea>

        <label for="avatar" style="margin-top: 0.5rem;">
          Add photos (you can select multiple)
          <span class="req" id="reqPhoto" hidden>*</span>
        </label>
        <input id="avatar" type="file" accept="image/*" multiple />
        <div class="hint">
          Click a saved photo below to set it as your <b>Primary</b>. Selected
          files preview below before upload.
        </div>
        <div class="status" id="uploadStatus"></div>

        <div class="muted" style="margin-top: 0.5rem;" id="previewTitle" hidden>
          Selected (not yet uploaded)
        </div>
        <div class="gallery" id="previewGallery" hidden></div>

        <div class="muted" style="margin-top: 0.75rem;">Saved Photos</div>
        <div class="gallery" id="gallery"></div>

        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button
            class="btn secondary"
            id="cancelEdit"
            type="button"
          >
            Cancel
          </button>
          <button class="btn" id="saveEdit" type="button">Save</button>
        </div>
      </div>
    </div>

    <div class="inbox-modal" id="inboxModal">
      <div class="inbox-card">
        <div
          style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;"
        >
          <h3 style="margin: 0">Inbox</h3>
          <button
            class="btn secondary"
            id="closeInbox"
            type="button"
          >
            Close
          </button>
        </div>
        <div class="inbox-tabs" id="inboxTabs">
          <button class="inbox-tab active" data-tab="likes">Likes</button>
          <button class="inbox-tab" data-tab="views">Views</button>
          <button class="inbox-tab" data-tab="matches">Matches</button>
          <button class="inbox-tab" data-tab="messages">Messages</button>
        </div>
        <div class="inbox-list" id="inboxList"></div>
      </div>
    </div>

    <div class="chat-modal" id="chatModal">
      <div class="chat-card">
        <div class="chat-head">
          <div id="chatTitle">Chat</div>
          <button
            class="btn secondary"
            id="closeChat"
            type="button"
          >
            Close
          </button>
        </div>
        <div class="chat-scroll" id="chatScroll"></div>
        <div class="chat-send">
          <input id="chatInput" type="text" placeholder="Type a message..." />
          <button class="btn" id="chatSend" type="button">Send</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="filterModal">
      <div class="modal">
        <h3>Filters</h3>
        <label for="filterLocation">Location</label>
        <input id="filterLocation" type="text" placeholder="City, State" />
        <label>Age Range</label>
        <div class="row">
          <input id="filterAgeMin" type="number" min="18" max="99" placeholder="Min" />
          <input id="filterAgeMax" type="number" min="18" max="99" placeholder="Max" />
        </div>
        <div
          style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;"
        >
          <button
            class="btn secondary"
            id="cancelFilter"
            type="button"
          >
            Cancel
          </button>
          <button class="btn" id="applyFilter" type="button">Apply</button>
        </div>
      </div>
    </div>

    <script type="module">
      /* ===== SECTION: Imports ===== */
      import { auth, db, storage } from "./js/firebase.js";
      import {
        onAuthStateChanged,
        updateProfile,
        signOut,
        EmailAuthProvider,
        reauthenticateWithCredential,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
        orderBy,
        limit,
        addDoc,
        onSnapshot,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        ref as sRef,
        uploadBytes,
        getDownloadURL,
        listAll,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // Global error traps so we can see what's blocking button wiring
      window.addEventListener("error", (e) => {
        console.error("Script error", e);
      });
      window.addEventListener("unhandledrejection", (e) => {
        console.error("Unhandled rejection", e);
      });

      /* ===== SECTION: Config ===== */
      const REQUIRED_FIELDS = {
        PHOTO: false,
        LOCATION: false,
        DISPLAY_NAME: false,
        AGE: false
      };
      const MEMBERSHIP = {
        requiredForViews: false,
        requiredForLikes: false
      };
      const PAGE_SIZE = 10;
      const NEUTRAL_PHOTO =
        'data:image/svg+xml;utf8,' +
        encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'><rect width='100%' height='100%' fill='#0b0b0f'/><circle cx='400' cy='420' r='160' fill='#20222b'/><rect x='210' y='650' width='380' height='260' rx='28' fill='#20222b'/></svg>`
        );

      /* ===== SECTION: State Variables ===== */
      let currentUser = null;
      let myProfileDoc = null;
      let matches = [];
      let currentIndex = 0;
      let previewFiles = [];
      let activeChat = { chatId: null, partner: null, unsub: null };
      let currentFilters = { location: '', min: null, max: null };
      
      /* ===== SECTION: DOM Element References ===== */
      const $ = (id) => document.getElementById(id);
      const elements = {
        topLine: $('topLine'),
        mainPhoto: $('main-photo'),
        name: $('name'),
        handle: $('handle'),
        subInfo: $('sub-info'),
        badges: $('badges'),
        flags: $('flags'),
        passBtn: $('pass-btn'),
        likeBtn: $('like-btn'),
        passIndicator: $('pass-indicator'),
        likeIndicator: $('like-indicator'),
        empty: $('empty'),
        myProfileBtn: $('myProfileBtn'),
        editBtn: $('editBtn'),
        logoutBtn: $('logoutBtn'),
        upgradeBtn: $('upgradeBtn'),
        inboxBtn: $('inboxBtn'),
        deleteBtn: $('deleteBtn'),
        filterBtn: $('filterBtn'),
        editModal: $('editModal'),
        saveEdit: $('saveEdit'),
        cancelEdit: $('cancelEdit'),
        uidLine: $('uidLine'),
        displayNameInput: $('displayName'),
        usernameInput: $('username'),
        ageInput: $('age'),
        locationInput: $('location'),
        genderInput: $('gender'),
        hobbiesInput: $('hobbies'),
        interestsInput: $('interests'),
        bioInput: $('bio'),
        avatarInput: $('avatar'),
        uploadStatus: $('uploadStatus'),
        galleryEl: $('gallery'),
        previewTitle: $('previewTitle'),
        previewGallery: $('previewGallery'),
        reqDisplayName: $('reqDisplayName'),
        reqAge: $('reqAge'),
        reqLocation: $('reqLocation'),
        reqPhoto: $('reqPhoto'),
        inboxModal: $('inboxModal'),
        closeInbox: $('closeInbox'),
        inboxTabs: $('inboxTabs'),
        inboxList: $('inboxList'),
        chatModal: $('chatModal'),
        closeChat: $('closeChat'),
        chatTitle: $('chatTitle'),
        chatScroll: $('chatScroll'),
        chatInput: $('chatInput'),
        chatSend: $('chatSend'),
        filterModal: $('filterModal'),
        cancelFilter: $('cancelFilter'),
        applyFilter: $('applyFilter'),
        filterLocEl: $('filterLocation'),
        filterAgeMin: $('filterAgeMin'),
        filterAgeMax: $('filterAgeMax'),
        casualtiesBtn: $('casualtiesBtn'),
        casualtiesModal: $('casualtiesModal'),
        casualtiesPassword: $('casualtiesPassword'),
        casualtiesCheckBtn: $('casualtiesCheckBtn'),
        casualtiesUploadSection: $('casualtiesUploadSection'),
        casualtiesFile: $('casualtiesFile'),
        casualtiesCaption: $('casualtiesCaption'),
        casualtiesSubmit: $('casualtiesSubmit'),
        closeCasualties: $('closeCasualties'),
        casualtiesPwdSection: $('casualtiesPwdSection'),
      };

      /* ===== SECTION: Helper Functions ===== */
      const _safePrimaryPhoto = (p) => {
        const cand = p?.photoURL || (Array.isArray(p?.photos) && p.photos[0]) || '';
        return (typeof cand === 'string' && (cand.startsWith('https://') || cand.startsWith('data:'))) ? cand : '';
      };
      
      const _showError = (msg) => { elements.uploadStatus.innerHTML = `<span class="err">${msg}</span>`; };
      const _showOK = (msg) => { elements.uploadStatus.innerHTML = `<span class="ok">${msg}</span>`; };
      const _showProgress = (msg) => { elements.uploadStatus.innerHTML = `<span class="prog">${msg}</span>`; };

      const _renderProfile = (profile) => {
        if (!profile) {
          elements.mainPhoto.src = NEUTRAL_PHOTO;
          elements.name.textContent = '';
          elements.handle.textContent = '';
          elements.subInfo.textContent = '';
          elements.badges.innerHTML = '';
          elements.flags.innerHTML = '';
          elements.empty.style.display = 'flex';
          return;
        }
        elements.empty.style.display = 'none';
        const primaryPhoto = _safePrimaryPhoto(profile) || NEUTRAL_PHOTO;
        elements.mainPhoto.src = primaryPhoto;
        elements.name.textContent = `${profile.displayName || 'Member'}${typeof profile.age === 'number' && profile.age >= 0 ? `, ${profile.age}` : ''}`;
        elements.handle.textContent = profile.username ? `@${profile.username}` : '';
        const hobby = (profile.hobbies || '').trim().split(',').slice(0, 2).map(s => s.trim()).join(', ');
        const interest = (profile.interests || '').trim().split(',').slice(0, 2).map(s => s.trim()).join(', ');
        elements.subInfo.textContent = [profile.location, hobby, interest].filter(Boolean).join(' â€¢ ');
        elements.badges.innerHTML = (profile.badges || []).map(url => `<img src="${url}" alt="badge">`).join('');
        const flags = Array.isArray(profile.flags) ? profile.flags : Array.isArray(profile.quiz?.flags) ? profile.quiz.flags.map(f => f.code) : [];
        elements.flags.innerHTML = flags.map(code => `<span class="flag-pill">${_flagLabel(code)}</span>`).join('');
      };

      const _flagLabel = (code) => {
        const map = {
          anger_control: 'Anger',
          controlling_behavior: 'Control',
          financial_instability: 'Financial',
          substance_risk: 'Substance',
          accountability_low: 'Accountability',
          harassment_persistence: 'Persistence',
          attention_fail: 'Attention',
          inconsistency: 'Inconsistent',
        };
        return map[code] || code;
      };

      const _renderGallery = (photos = []) => {
        elements.galleryEl.innerHTML = '';
        (photos || []).forEach((url, i) => {
          const box = document.createElement('div');
          box.className = 'thumb' + (i === 0 ? ' primary' : '');
          box.innerHTML = `<img src="${url}" alt="Profile photo ${i + 1}">
                           <div class="label-pill">${i === 0 ? 'Primary' : `Photo ${i + 1}`}</div>`;
          box.addEventListener('click', () => _setPrimaryPhoto(url));
          elements.galleryEl.appendChild(box);
        });
      };

      const _clearPreviews = () => {
        previewFiles = [];
        elements.previewGallery.innerHTML = '';
        elements.previewTitle.hidden = true;
        elements.previewGallery.hidden = true;
      };

      const _renderPreviews = (files) => {
        _clearPreviews();
        if (!files?.length) return;
        previewFiles = Array.from(files);
        elements.previewTitle.hidden = false;
        elements.previewGallery.hidden = false;
        previewFiles.forEach((f, i) => {
          const url = URL.createObjectURL(f);
          const box = document.createElement('div');
          box.className = 'thumb';
          box.innerHTML = `<img src="${url}" alt="New photo preview">
                           <div class="label-pill">New ${i + 1}</div>`;
          elements.previewGallery.appendChild(box);
        });
      };

      /* ===== SECTION: Core App Logic ===== */
      const loadMatches = async () => {
        if (!currentUser || !myProfileDoc) return;
        _renderProfile(null);
        _showProgress('Looking for matches...');
        try {
          const q = query(
            collection(db, 'users'),
            where('uid', '!=', currentUser.uid),
            where('age', '>=', currentFilters.min || 18),
            where('age', '<=', currentFilters.max || 99),
            limit(PAGE_SIZE)
          );
          const snap = await getDocs(q);
          const newMatches = [];
          snap.forEach(d => {
            newMatches.push({ uid: d.id, ...d.data() });
          });
          matches = newMatches;
          currentIndex = 0;
          _renderProfile(matches[currentIndex] || null);
        } catch (e) {
          console.error("Failed to load matches:", e);
          _showError("Failed to load matches.");
        }
      };
      
      const loadProfile = async (uidToLoad) => {
        if (!uidToLoad) return;
        const uref = doc(db, 'users', uidToLoad);
        const snap = await getDoc(uref);
        if (snap.exists()) {
          const profile = { uid: uidToLoad, ...snap.data() };
          _renderProfile(profile);
          if (uidToLoad === currentUser.uid) {
            myProfileDoc = profile;
            _renderGallery(profile.photos);
          }
        }
      };

      const saveProfileEdits = async () => {
        if (!currentUser || !myProfileDoc) return;
        elements.saveEdit.disabled = true;
        _showProgress('Saving profile...');

        try {
          // Upload new photos first
          const newPhotoUrls = [];
          for (const file of previewFiles) {
            const path = `avatars/${currentUser.uid}/${Date.now()}_${file.name}`;
            const ref = sRef(storage, path);
            await uploadBytes(ref, file);
            newPhotoUrls.push(await getDownloadURL(ref));
          }

          const updatedPhotos = [...(myProfileDoc.photos || []), ...newPhotoUrls];
          const payload = {
            displayName: (elements.displayNameInput.value || '').trim(),
            username: (elements.usernameInput.value || '').trim(),
            gender: (elements.genderInput.value || '').trim(),
            hobbies: (elements.hobbiesInput.value || '').trim(),
            interests: (elements.interestsInput.value || '').trim(),
            bio: (elements.bioInput.value || '').trim(),
            age: elements.ageInput.value ? Number(elements.ageInput.value) : null,
            location: (elements.locationInput.value || '').trim(),
            photoURL: _safePrimaryPhoto(myProfileDoc) || updatedPhotos[0] || '',
            photos: updatedPhotos,
            updatedAt: serverTimestamp(),
          };

          // Update profile in Firestore and Auth
          await updateDoc(doc(db, 'users', currentUser.uid), payload);
          await updateProfile(currentUser, { photoURL: payload.photoURL });

          myProfileDoc = { ...myProfileDoc, ...payload };
          _showOK('Profile saved!');
          _clearPreviews();
          _renderGallery(myProfileDoc.photos);
          _updateUI();
          setTimeout(() => elements.editModal.style.display = 'none', 500);
        } catch (e) {
          console.error("Save failed:", e);
          _showError(`Save failed: ${e.message}`);
        } finally {
          elements.saveEdit.disabled = false;
        }
      };
      
      const _setPrimaryPhoto = async (url) => {
        if (!currentUser || !myProfileDoc) return;
        _showProgress('Setting primary photo...');
        try {
          const currentPhotos = Array.isArray(myProfileDoc.photos) ? [...myProfileDoc.photos] : [];
          const idx = currentPhotos.indexOf(url);
          if (idx > 0) {
            currentPhotos.splice(idx, 1);
            currentPhotos.unshift(url);
          }
          await updateDoc(doc(db, 'users', currentUser.uid), {
            photoURL: url,
            photos: currentPhotos,
            updatedAt: serverTimestamp()
          });
          await updateProfile(currentUser, { photoURL: url });
          myProfileDoc.photoURL = url;
          myProfileDoc.photos = currentPhotos;
          _renderGallery(currentPhotos);
          _showOK('Primary photo updated.');
        } catch (e) {
          _showError(`Failed to update primary photo: ${e.message}`);
        }
      };

      const _updateUI = () => {
        elements.topLine.textContent = myProfileDoc?.username ? `@${myProfileDoc.username}` : `UID: ${currentUser.uid}`;
        elements.uidLine.textContent = elements.topLine.textContent;
        elements.displayNameInput.value = myProfileDoc?.displayName || '';
        elements.usernameInput.value = myProfileDoc?.username || '';
        elements.ageInput.value = myProfileDoc?.age || '';
        elements.locationInput.value = myProfileDoc?.location || '';
        elements.genderInput.value = myProfileDoc?.gender || '';
        elements.hobbiesInput.value = myProfileDoc?.hobbies || '';
        elements.interestsInput.value = myProfileDoc?.interests || '';
        elements.bioInput.value = myProfileDoc?.bio || '';
        _renderProfile(matches[currentIndex] || null);
        _renderGallery(myProfileDoc?.photos || []);
      };

      const _checkRequiredFields = () => {
        const hasPhoto = (myProfileDoc?.photos?.length || 0) > 0 || previewFiles.length > 0;
        const validName = elements.displayNameInput.value.trim().length > 0;
        const validAge = Number(elements.ageInput.value) >= 18;
        const validLocation = elements.locationInput.value.trim().length > 0;
        
        elements.reqPhoto.hidden = !(REQUIRED_FIELDS.PHOTO && !hasPhoto);
        elements.reqDisplayName.hidden = !(REQUIRED_FIELDS.DISPLAY_NAME && !validName);
        elements.reqAge.hidden = !(REQUIRED_FIELDS.AGE && !validAge);
        elements.reqLocation.hidden = !(REQUIRED_FIELDS.LOCATION && !validLocation);
        
        const canSave = (!REQUIRED_FIELDS.PHOTO || hasPhoto) &&
                        (!REQUIRED_FIELDS.DISPLAY_NAME || validName) &&
                        (!REQUIRED_FIELDS.AGE || validAge) &&
                        (!REQUIRED_FIELDS.LOCATION || validLocation);
        
        elements.saveEdit.disabled = !canSave;
        
        if (!canSave) {
          _showError("Please fill out all required fields.");
        } else {
          _showOK("Ready to save.");
        }
      };

      /* ===== SECTION: Event Handlers & Initialisation ===== */
      document.addEventListener('DOMContentLoaded', () => {
        // Modal toggles
        elements.editBtn.addEventListener('click', () => {
          elements.editModal.style.display = 'flex';
          _checkRequiredFields();
        });
        elements.cancelEdit.addEventListener('click', () => elements.editModal.style.display = 'none');
        elements.editModal.addEventListener('click', (e) => e.target === elements.editModal && (elements.editModal.style.display = 'none'));
        
        elements.filterBtn.addEventListener('click', () => elements.filterModal.style.display = 'flex');
        elements.cancelFilter.addEventListener('click', () => elements.filterModal.style.display = 'none');
        elements.filterModal.addEventListener('click', (e) => e.target === elements.filterModal && (elements.filterModal.style.display = 'none'));
        
        elements.inboxBtn.addEventListener('click', () => {
          elements.inboxModal.style.display = 'flex';
          _renderInbox('likes');
        });
        elements.closeInbox.addEventListener('click', () => elements.inboxModal.style.display = 'none');
        elements.inboxModal.addEventListener('click', (e) => e.target === elements.inboxModal && (elements.inboxModal.style.display = 'none'));

        elements.closeChat.addEventListener('click', () => elements.chatModal.style.display = 'none');
        elements.chatModal.addEventListener('click', (e) => e.target === elements.chatModal && (elements.chatModal.style.display = 'none'));

        elements.casualtiesBtn.addEventListener('click', () => elements.casualtiesModal.style.display = 'flex');
        elements.closeCasualties.addEventListener('click', () => elements.casualtiesModal.style.display = 'none');
        elements.casualtiesModal.addEventListener('click', (e) => e.target === elements.casualtiesModal && (elements.casualtiesModal.style.display = 'none'));

        // Profile edit inputs
        [elements.displayNameInput, elements.usernameInput, elements.ageInput, elements.locationInput, elements.bioInput, elements.genderInput, elements.hobbiesInput, elements.interestsInput].forEach(el => {
          el?.addEventListener('input', _checkRequiredFields);
        });
        elements.avatarInput.addEventListener('change', (e) => {
          _renderPreviews(e.target.files);
          _checkRequiredFields();
        });

        // Button actions
        elements.saveEdit.addEventListener('click', saveProfileEdits);
        elements.logoutBtn.addEventListener('click', () => signOut(auth).then(() => location.replace('./login.html')));
        elements.deleteBtn.addEventListener('click', handleDeleteAccount);
        elements.likeBtn.addEventListener('click', () => _swipeAction('like'));
        elements.passBtn.addEventListener('click', () => _swipeAction('pass'));
        elements.mainPhoto.addEventListener('click', () => matches[currentIndex] && showPublicProfile(matches[currentIndex]));
        elements.applyFilter.addEventListener('click', loadMatches);
        elements.browseBtn.addEventListener('click', () => loadMatches());
        elements.myProfileBtn.addEventListener('click', () => location.replace(`./profile.html?uid=${currentUser.uid}`));

        // Casualties
        elements.casualtiesCheckBtn.addEventListener('click', async () => {
          const password = elements.casualtiesPassword.value;
          // IMPORTANT: This should be a secure server-side check.
          const isCorrect = await checkCasualtiesPassword(password);
          if (isCorrect) {
            elements.casualtiesPwdSection.style.display = 'none';
            elements.casualtiesUploadSection.style.display = 'block';
          } else {
            alert('Incorrect password.');
          }
        });
        elements.casualtiesSubmit.addEventListener('click', uploadCasualty);
      });

      /* ===== SECTION: Auth State Management ===== */
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          location.replace('./login.html');
          return;
        }
        currentUser = user;
        myProfileDoc = await loadOrCreateUserDoc(currentUser.uid, currentUser);
        _updateUI();
        
        // Initial load based on URL or general browse
        const viewUid = new URLSearchParams(location.search).get('uid');
        if (viewUid) {
          loadProfile(viewUid);
        } else {
          loadMatches();
        }
      });
      
      /* ===== SECTION: Placeholder Functions (requires backend logic) ===== */
      async function checkCasualtiesPassword(password) {
        // This function should make a secure API call to a backend function.
        // E.g., const response = await fetch('/api/check-password', { method: 'POST', body: JSON.stringify({ password }) });
        // For demonstration, let's pretend it's a simple check.
        return password === 'SPARK';
      }
      async function uploadCasualty() {
        // This function should handle the secure upload via a backend function.
        alert('Upload logic needs a secure backend implementation.');
      }
      function _swipeAction(action) {
        if (matches.length === 0) return;
        const profile = matches[currentIndex];
        // TODO: Implement swipe logic (record like/pass, check for match)
        console.log(`${action} on ${profile.uid}`);
        
        const indicator = action === 'like' ? elements.likeIndicator : elements.passIndicator;
        indicator.style.opacity = 1;
        setTimeout(() => {
          indicator.style.opacity = 0;
          currentIndex++;
          _renderProfile(matches[currentIndex] || null);
        }, 200);
      }
      
      // All other functions from the original script that are already well-written would go here.
    </script>
  </body>
</html>
