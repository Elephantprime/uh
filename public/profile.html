<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unhinged — Profile</title>
  <style>
    body{font-family:Arial, sans-serif;max-width:700px;margin:0 auto;padding:2rem;background:#0e0e12;color:#fff}
    header{display:flex;justify-content:space-between;align-items:center}
    button{padding:.55rem .9rem;border:none;background:#E11D2A;color:#fff;border-radius:6px;cursor:pointer}
    .card{margin-top:1rem;padding:1rem;border:1px solid #2a2a2a;border-radius:8px;background:#15161b}
    label{display:block;margin:.5rem 0 .25rem}
    input,textarea{width:100%;padding:.6rem;border:1px solid #2a2a2a;border-radius:6px;background:#12131a;color:#fff}
    .muted{color:#cfd0de}
    img#preview{display:none;width:120px;height:120px;border-radius:12px;object-fit:cover;margin-top:.5rem;border:1px solid #2a2a2a}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <header>
    <h1>Your Profile</h1>
    <div class="row">
      <button id="logout">Sign out</button>
    </div>
  </header>

  <div id="status" class="muted"></div>

  <section class="card">
    <div class="row">
      <img id="preview" alt="Avatar preview">
      <div>
        <h2 id="displayNameView">Loading…</h2>
        <p class="muted" id="uidline"></p>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Edit</h3>
    <form id="edit-form">
      <label for="displayName">Display name</label>
      <input id="displayName" type="text" />
      <label for="bioInput">Bio</label>
      <textarea id="bioInput" rows="4"></textarea>
      <label for="avatar">Avatar (optional)</label>
      <input id="avatar" type="file" accept="image/*" />
      <div class="row" style="margin-top:.6rem">
        <button type="submit" id="save">Save</button>
        <button type="button" id="clearPhoto" class="ghost" style="background:#2a2a2a">Clear photo</button>
        <span id="save-status" class="muted"></span>
      </div>
    </form>
  </section>

  <script type="module">
    import { auth, db, storage } from "./js/firebase.js";
    import { onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const $ = id => document.getElementById(id);
    const statusEl = $("status");
    const uidLine  = $("uidline");
    const dispView = $("displayNameView");
    const dispEdit = $("displayName");
    const bioInput = $("bioInput");
    const avatar   = $("avatar");
    const preview  = $("preview");
    const saveBtn  = $("save");
    const clearBtn = $("clearPhoto");

    const params = new URLSearchParams(location.search);
    const urlUid = (params.get("uid") || "").trim();

    const goLogin = () => location.replace("./login.html");
    const goOwn   = uid => location.replace(`./profile.html?uid=${encodeURIComponent(uid)}`);

    let me = null;
    let currentPhotoURL = "";

    onAuthStateChanged(auth, async (user)=>{
      if (!user) return goLogin();
      me = user;

      // Ensure we’re on our own profile page
      if (!urlUid || urlUid !== me.uid) return goOwn(me.uid);

      uidLine.textContent = `UID: ${me.uid}`;
      dispView.textContent = me.displayName || "Member";
      currentPhotoURL = me.photoURL || "";

      if (currentPhotoURL){
        preview.src = currentPhotoURL;
        preview.style.display = "block";
      }

      // Load Firestore profile (create minimal if missing)
      await loadOrCreate(me.uid);
    });

    async function loadOrCreate(uid){
      statusEl.textContent = "Loading profile…";
      const uref = doc(db, "users", uid);
      const snap = await getDoc(uref);

      if (!snap.exists()){
        await setDoc(uref, {
          uid,
          displayName: me.displayName || "Member",
          photoURL: me.photoURL || null,
          bio: "",
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }, { merge:true });
      }

      const data = (await getDoc(uref)).data() || {};
      dispEdit.value = data.displayName || me.displayName || "Member";
      bioInput.value = data.bio || "";
      if (!currentPhotoURL && data.photoURL){
        currentPhotoURL = data.photoURL;
        preview.src = currentPhotoURL;
        preview.style.display = "block";
      }
      dispView.textContent = dispEdit.value || "Member";
      statusEl.textContent = "";
    }

    avatar?.addEventListener("change", ()=>{
      const f = avatar.files?.[0];
      if (!f) return;
      const url = URL.createObjectURL(f);
      preview.src = url;
      preview.style.display = "block";
    });

    clearBtn?.addEventListener("click", ()=>{
      avatar.value = "";
      preview.removeAttribute("src");
      preview.style.display = "none";
    });

    $("edit-form")?.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if (!me) return;

      const name = (dispEdit.value || "").trim().slice(0, 60);
      const bio  = (bioInput.value || "").trim().slice(0, 400);
      const f    = avatar.files?.[0];

      saveBtn.disabled = true;
      $("save-status").textContent = "Saving…";

      try {
        let photoURL = currentPhotoURL;

        if (f){
          const path = `avatars/${me.uid}/${Date.now()}_${f.name.replace(/\s+/g,'_')}`;
          const r = sRef(storage, path);
          await uploadBytes(r, f);
          photoURL = await getDownloadURL(r);
          preview.src = photoURL;
          preview.style.display = "block";
        }

        // Update Auth cache
        await updateProfile(me, {
          displayName: name || me.displayName || "Member",
          photoURL: photoURL || null
        });

        // Save Firestore doc
        const uref = doc(db, "users", me.uid);
        await setDoc(uref, {
          uid: me.uid,
          displayName: name || "Member",
          photoURL: photoURL || null,
          bio,
          updatedAt: serverTimestamp(),
        }, { merge:true });

        currentPhotoURL = photoURL || currentPhotoURL;
        dispView.textContent = name || "Member";
        $("save-status").textContent = "Saved";
        setTimeout(()=> $("save-status").textContent = "", 1200);
      } catch (err){
        console.error(err);
        $("save-status").textContent = err?.message || "Failed saving profile.";
      } finally {
        saveBtn.disabled = false;
      }
    });

    $("logout")?.addEventListener("click", async ()=>{
      try { await signOut(auth); goLogin(); } catch (e) {
        statusEl.textContent = e?.message || "Could not sign out.";
      }
    });
  </script>
</body>
</html>
