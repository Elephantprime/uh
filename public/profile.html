<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Unhinged â€” Profile</title>
  <style>
    :root { --bg:#0e0e12; --panel:#15161b; --muted:#cfd0de; --red:#E11D2A; --green:#4CAF50; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:#fff;min-height:100vh;display:flex;flex-direction:column}

    .btn{border:none;background:var(--red);color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;text-decoration:none}
    .btn.secondary{background:#3a3a3a}
    .btn.ghost{background:transparent;border:1px solid #444}
    .btn.small{padding:.35rem .7rem;font-size:.9rem}

    .topbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:var(--panel);border-bottom:1px solid #2a2a2a}
    .brand{font-weight:700}
    .nav-actions{display:flex;gap:.5rem;flex-wrap:wrap}

    .content{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px;width:100%}
    .card-frame{position:relative;width:92%;max-width:420px;height:72vh;border:2px solid #2a2a2a;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 8px 24px rgba(0,0,0,.4);touch-action:pan-y}
    .main-photo{width:100%;height:100%;object-fit:cover;user-select:none;-webkit-user-drag:none;cursor:pointer}
    .info-overlay{position:absolute;left:0;right:0;bottom:0;padding:14px 16px;background:linear-gradient(transparent, rgba(0,0,0,.78));pointer-events:none}
    .info-overlay h2{margin:0;font-size:1.4rem}
    .handle{font-size:.95rem;color:#cfd0de;margin-top:2px}
    .sub{font-size:.9rem;color:#ddd;margin-top:2px}
    .badges,.flags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .flags .flag-pill{font-size:.75rem;border:1px solid #3a3b44;border-radius:999px;padding:2px 8px;background:#14151a}
    .indicator{position:absolute;top:16px;font-size:1.4rem;font-weight:700;padding:6px 12px;border:3px solid;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .12s ease}
    .indicator.pass{left:14px;color:var(--red);border-color:var(--red);transform:rotate(-18deg)}
    .indicator.like{right:14px;color:var(--green);border-color:var(--green);transform:rotate(18deg)}
    .empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:1.1rem}

    .actions{width:100%;max-width:480px;display:flex;justify-content:space-around;align-items:center;padding:8px 0 16px}
    .action-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:1.1rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .pass-btn{background:#2a2a2a;color:var(--red)}
    .like-btn{background:#2a2a2a;color:var(--green)}

    .inbox-modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:12px;z-index:80}
    .inbox-card{width:100%;max-width:900px;background:var(--panel);border:1px solid #2a2a2a;border-radius:12px;padding:12px}
    .inbox-tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
    .inbox-tab{border:1px solid #444;background:#3a3a3a;border-radius:999px;padding:.45rem .8rem;cursor:pointer;color:#fff}
    .inbox-tab.active{border-color:var(--red);background:#4a4a4a;box-shadow:0 0 0 2px #E11D2A33 inset}
    .inbox-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;min-height:160px}
    .inbox-item{position:relative;border:1px solid #2a2a2a;border-radius:10px;overflow:hidden;background:#111}
    .inbox-item img{width:100%;height:160px;object-fit:cover;display:block}
    .inbox-meta{padding:8px}
    .inbox-name{font-weight:700}
    .inbox-sub{font-size:.9rem;color:#cfd0de}

    /* Modal Profile (bigger & readable) */
    .profile-modal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;padding:12px;z-index:120}
    .profile-card{width:100%;max-width:820px;background:var(--panel);border:1px solid #2a2a2a;border-radius:14px;display:grid;grid-template-columns:1.2fr .9fr;gap:12px;padding:12px}
    .profile-main{display:flex;flex-direction:column;gap:8px}
    .profile-photo-wrap{display:flex;align-items:center;gap:8px}
    .profile-photo{flex:1;max-height:520px;min-height:320px;object-fit:cover;border-radius:10px}
    .profile-photo-nav{background:#0000;border:1px solid #444;border-radius:8px;padding:.35rem .6rem;cursor:pointer}
    .profile-thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .profile-thumbs img{width:78px;height:78px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
    .profile-thumbs img.active{border-color:var(--red)}
    .profile-side h2{margin:.25rem 0 0}
    .muted{color:var(--muted)}
    .close-row{display:flex;justify-content:flex-end}
    .close-row .btn.secondary{background:#444}

    @media (max-width:860px){
      .profile-card{grid-template-columns:1fr;max-width:480px}
      .profile-photo{max-height:420px}
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand" id="topLine">Your Profile</div>
    <div class="nav-actions">
      <button class="btn secondary" id="inboxBtn" type="button">Inbox</button>
      <button class="btn secondary" id="browseBtn" type="button">Browse Matches</button>
      <button class="btn" id="editBtn" type="button">Edit Profile</button>
      <button class="btn secondary" id="logoutBtn" type="button">Logout</button>
    </div>
  </div>

  <div class="content">
    <div class="card-frame" id="cardFrame">
      <img class="main-photo" id="main-photo" src="" alt="Profile Photo"/>
      <div class="info-overlay">
        <h2 id="name"></h2>
        <div class="handle" id="handle"></div>
        <div class="sub" id="sub-info"></div>
      </div>
      <div class="indicator pass" id="pass-indicator">PASS</div>
      <div class="indicator like" id="like-indicator">LIKE</div>
      <div class="empty" id="empty" style="display:none;">No more matches</div>
    </div>

    <div class="actions">
      <button class="action-btn pass-btn" id="pass-btn" aria-label="Pass">Pass</button>
      <button class="action-btn like-btn" id="like-btn" aria-label="Like">Like</button>
    </div>
  </div>

  <!-- Inbox (kept minimal for the demo) -->
  <div class="inbox-modal" id="inboxModal">
    <div class="inbox-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">Inbox</h3>
        <button class="btn secondary" id="closeInbox" type="button">Close</button>
      </div>
      <div class="inbox-tabs" id="inboxTabs">
        <button class="inbox-tab active" data-tab="likes">Likes</button>
        <button class="inbox-tab" data-tab="views">Views</button>
        <button class="inbox-tab" data-tab="matches">Matches</button>
        <button class="inbox-tab" data-tab="messages">Messages</button>
      </div>
      <div class="inbox-list" id="inboxList"></div>
    </div>
  </div>

  <script type="module">
    import { auth, db, storage } from "./js/firebase.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, getDocs, doc, getDoc, setDoc, serverTimestamp,
      query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const mainPhoto = document.getElementById("main-photo");
    const nameEl = document.getElementById("name");
    const handleEl = document.getElementById("handle");
    const subInfo = document.getElementById("sub-info");
    const inboxBtn = document.getElementById("inboxBtn");
    const browseBtn = document.getElementById("browseBtn");
    const inboxModal = document.getElementById("inboxModal");
    const closeInbox = document.getElementById("closeInbox");
    const inboxTabs = document.getElementById("inboxTabs");
    const inboxList = document.getElementById("inboxList");
    const passBtn = document.getElementById("pass-btn");
    const likeBtn = document.getElementById("like-btn");
    const passIndicator = document.getElementById("pass-indicator");
    const likeIndicator = document.getElementById("like-indicator");
    const emptyEl = document.getElementById("empty");

    const NEUTRAL_PHOTO = "data:image/svg+xml;utf8," + encodeURIComponent(
      `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'><rect width='100%' height='100%' fill='#0b0b0f'/><circle cx='400' cy='420' r='160' fill='#20222b'/><rect x='210' y='650' width='380' height='260' rx='28' fill='#20222b'/></svg>`
    );

    const REQUIRED = { PHOTO:false, LOCATION:false, DISPLAY_NAME:false, AGE:false };

    let me=null, myDoc=null, allUsers=[], matches=[], currentIndex=0;

    function isMember(userDoc){ return (userDoc?.membership?.tier || "free") !== "free"; }

    function safePrimaryPhoto(p){
      const cand = p?.photoURL || (Array.isArray(p?.photos) && p.photos[0]) || "";
      if (typeof cand !== "string") return "";
      if (/^https?:\/\//i.test(cand)) return cand;
      if (cand.startsWith("data:image/")) return cand;
      return "";
    }

    // ===== BIGGER PROFILE MODAL with gallery =====
    function showProfileModal(user){
      const name = user.displayName || user.name || "Member";
      const ageText = (typeof user.age === "number") ? `${user.age}` : (user.age || "");
      const location = user.location || user.city || "";

      const list = Array.isArray(user.photos) ? user.photos.slice() : [];
      const primary = safePrimaryPhoto(user) || list[0] || NEUTRAL_PHOTO;
      if (!list.length || list[0] !== primary) list.unshift(primary);

      const wrap = document.createElement("div");
      wrap.className = "profile-modal";

      const card = document.createElement("div");
      card.className = "profile-card";

      card.innerHTML = `
        <div class="profile-main">
          <div class="profile-photo-wrap">
            <button class="profile-photo-nav" data-prev aria-label="Previous photo">â€¹</button>
            <img class="profile-photo" id="pmain" src="${primary}" alt="Profile photo"/>
            <button class="profile-photo-nav" data-next aria-label="Next photo">â€º</button>
          </div>
          <div class="profile-thumbs" id="pthumbs"></div>
        </div>
        <div class="profile-side">
          <div class="close-row"><button class="btn secondary" data-close>Close</button></div>
          <h2>${name}</h2>
          <div class="muted">${[ageText && `Age ${ageText}`, location].filter(Boolean).join(" â€¢ ")}</div>
        </div>
      `;
      wrap.appendChild(card);
      document.body.appendChild(wrap);

      const pmain = card.querySelector("#pmain");
      const pthumbs = card.querySelector("#pthumbs");
      let idx = 0;

      // Build thumbs
      list.forEach((url, i) => {
        const t = document.createElement("img");
        t.src = url;
        t.alt = "Photo " + (i+1);
        t.className = i===0 ? "active" : "";
        t.addEventListener("click", () => {
          idx = i;
          pmain.src = list[idx];
          [...pthumbs.children].forEach(ch => ch.classList.remove("active"));
          t.classList.add("active");
        });
        pthumbs.appendChild(t);
      });

      const nav = (d) => {
        if (!list.length) return;
        idx = (idx + d + list.length) % list.length;
        pmain.src = list[idx];
        [...pthumbs.children].forEach(ch => ch.classList.remove("active"));
        if (pthumbs.children[idx]) pthumbs.children[idx].classList.add("active");
      };
      card.querySelector("[data-prev]").addEventListener("click", () => nav(-1));
      card.querySelector("[data-next]").addEventListener("click", () => nav(1));
      wrap.addEventListener("click", (e) => { if (e.target === wrap) document.body.removeChild(wrap); });
      card.querySelector("[data-close]").addEventListener("click", () => document.body.removeChild(wrap));
    }

    function renderProfile(p){
      if(!p){ mainPhoto.src=NEUTRAL_PHOTO; nameEl.textContent=""; handleEl.textContent=""; subInfo.textContent=""; emptyEl.style.display="flex"; return; }
      emptyEl.style.display="none";
      const primary = safePrimaryPhoto(p) || NEUTRAL_PHOTO;
      mainPhoto.src = primary;

      const name = p.displayName || p.name || "Member";
      const age  = (typeof p.age === "number" && p.age >= 0) ? `, ${p.age}` : (typeof p.age === "string" && p.age ? `, ${p.age}` : "");
      nameEl.textContent = `${name}${age}`;
      handleEl.textContent = p.username ? `@${p.username}` : "";
      subInfo.textContent = p.location || "";
    }

    // click on the big card image -> show modal
    mainPhoto.addEventListener("click", () => {
      const p = matches[currentIndex];
      if (p) showProfileModal(p);
    });

    function showIndicator(t){ passIndicator.style.opacity = t==="pass"?1:0; likeIndicator.style.opacity = t==="like"?1:0; }
    function nextProfile(){ currentIndex++; renderProfile(matches[currentIndex]||null); }
    passBtn.addEventListener("click", ()=>{ showIndicator("pass"); setTimeout(()=>{ showIndicator(null); nextProfile(); }, 120); });
    likeBtn.addEventListener("click", ()=>{ showIndicator("like"); setTimeout(()=>{ showIndicator(null); nextProfile(); }, 120); });

    function openInbox(){ inboxModal.style.display = "flex"; }
    function closeInboxModal(){ inboxModal.style.display = "none"; }
    inboxBtn.addEventListener("click", ()=>{ openInbox(); renderInbox("likes"); });
    closeInbox.addEventListener("click", closeInboxModal);
    inboxModal.addEventListener("click", (e)=>{ if(e.target===inboxModal) closeInboxModal(); });

    inboxTabs.addEventListener("click", (e)=>{
      const b = e.target.closest(".inbox-tab");
      if (b) renderInbox(b.dataset.tab);
    });

    async function fetchUsersByIds(ids){
      if (!ids?.length) return [];
      const out=[];
      for(const uid of ids){
        const snap = await getDoc(doc(db,"users",uid));
        if (snap.exists()) out.push({ uid, ...snap.data() });
      }
      return out;
    }
    async function getLikesForMe(uid){
      const qy = query(collection(db,"likes"), where("toUid","==",uid), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(qy); const ids=[]; snap.forEach(d=>ids.push(d.data().fromUid)); return fetchUsersByIds(ids);
    }
    async function getViewsForMe(uid){
      const qy = query(collection(db,"views"), where("viewedUid","==",uid), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(qy); const ids=[]; snap.forEach(d=>ids.push(d.data().viewerUid)); return fetchUsersByIds(ids);
    }
    async function getMatchesForMe(uid){
      const qy = query(collection(db,"matches"), where("uids","array-contains",uid), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(qy);
      const partnerIds=[]; snap.forEach(d=>{ const arr=d.data().uids||[]; const other=arr.find(x=>x!==uid); if (other) partnerIds.push(other); });
      return fetchUsersByIds(partnerIds);
    }
    const TAB_FUNCS = { likes:getLikesForMe, views:getViewsForMe, matches:getMatchesForMe, messages:getMatchesForMe };

    async function renderInbox(tab){
      if (!me || !myDoc) return;
      [...inboxTabs.querySelectorAll(".inbox-tab")].forEach(b=>b.classList.toggle("active", b.dataset.tab===tab));
      inboxList.innerHTML = "<div class='muted'>Loadingâ€¦</div>";

      let items=[]; try{ items = await TAB_FUNCS[tab](me.uid); } catch(e){ console.error(e); inboxList.innerHTML="<div class='muted'>Could not load.</div>"; return; }
      inboxList.innerHTML="";
      if (!items.length){ inboxList.innerHTML="<div class='muted'>Nothing here yet.</div>"; return; }

      for (const u of items){
        const primary = safePrimaryPhoto(u) || NEUTRAL_PHOTO;
        const name = u.displayName || u.name || "Member";
        const age  = (typeof u.age === "number") ? `, ${u.age}` : (typeof u.age === "string" && u.age ? `, ${u.age}` : "");
        const loc  = u.location || "";
        const item = document.createElement("div");
        item.className = "inbox-item";
        item.innerHTML = `
          <img src="${primary}" alt="">
          <div class="inbox-meta">
            <div class="inbox-name">${name}${age}</div>
            <div class="inbox-sub">${loc}</div>
            <div style="margin-top:6px"><button class="btn small" data-view>View</button></div>
          </div>
        `;
        item.querySelector("[data-view]").addEventListener("click", ()=> showProfileModal(u));
        item.querySelector("img").addEventListener("click", ()=> showProfileModal(u));
        inboxList.appendChild(item);
      }
    }

    // Browse = load matches list and show first profile
    browseBtn.addEventListener("click", async ()=>{
      if (!me || !myDoc) return;
      try{
        const list = await getMatchesForMe(me.uid);
        matches = list.length ? list : allUsers;
        currentIndex = 0;
        renderProfile(matches[currentIndex] || null);
      }catch(e){ console.error(e); }
    });

    async function loadOrCreateUserDoc(uid, userObj){
      const uref = doc(db,"users",uid);
      const snap = await getDoc(uref);
      if(!snap.exists()){
        const seed = {
          uid, displayName:userObj.displayName||"Member", username:"",
          photoURL:userObj.photoURL||"", photos:userObj.photoURL?[userObj.photoURL]:[],
          bio:"", age:null, location:"", membership:{ tier:"free" },
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        };
        await setDoc(uref, seed); return seed;
      }
      return snap.data();
    }

    onAuthStateChanged(auth, async (user)=>{
      if(!user){ location.replace("./login.html"); return; }
      me = user;
      myDoc = await loadOrCreateUserDoc(me.uid, me);

      // Load others (exclude me)
      try{
        const snap = await getDocs(collection(db,"users"));
        allUsers = [];
        snap.forEach(d => { if (d.id !== me.uid) allUsers.push({ uid:d.id, ...d.data() }); });
      }catch{ allUsers = []; }

      matches = allUsers.length ? allUsers : [myDoc];
      currentIndex = 0;
      renderProfile(matches[currentIndex] || null);
    });

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", async ()=>{
      try{ await signOut(auth); location.replace("./login.html"); } catch(e){ console.error(e); }
    });
  </script>
</body>
</html>
