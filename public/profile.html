<script type="module">
  /* ===== SECTION: Imports ===== */
  import { auth, db, storage } from "./js/firebase.js";
  import { onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  /* ===== SECTION: Config (Requirements & Membership) ===== */
  const REQUIRED = { PHOTO: true, LOCATION: true, DISPLAY_NAME: false, AGE: false };
  // Member-gating (free users can swipe matches; only members can see "who viewed/liked you")
  const MEMBERSHIP = { requiredForViews: true, requiredForLikes: true };

  /* ===== SECTION: DOM Refs ===== */
  // Top bar
  const topLine = document.getElementById("topLine");
  const filterBtn = document.getElementById("filterBtn");      // optional (if you added filters)
  const myProfileBtn = document.getElementById("myProfileBtn");
  const editBtn = document.getElementById("editBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const upgradeBtn = document.getElementById("upgradeBtn");     // <-- Go Paid

  // Swipe card
  const cardFrame = document.getElementById("cardFrame");
  const mainPhoto = document.getElementById("main-photo");
  const nameEl = document.getElementById("name");
  const handleEl = document.getElementById("handle");
  const subInfo = document.getElementById("sub-info");
  const badgesEl = document.getElementById("badges");
  const flagsEl = document.getElementById("flags");
  const passBtn = document.getElementById("pass-btn");
  const likeBtn = document.getElementById("like-btn");
  const passIndicator = document.getElementById("pass-indicator");
  const likeIndicator = document.getElementById("like-indicator");
  const emptyEl = document.getElementById("empty");

  // Filter modal (optional; if present in your HTML)
  const filterModal = document.getElementById("filterModal");
  const fLocation = document.getElementById("fLocation");
  const fGender = document.getElementById("fGender");
  const fAgeMin = document.getElementById("fAgeMin");
  const fAgeMax = document.getElementById("fAgeMax");
  const filterApply = document.getElementById("filterApply");
  const filterCancel = document.getElementById("filterCancel");

  // Edit modal
  const editModal = document.getElementById("editModal");
  const saveEdit = document.getElementById("saveEdit");
  const cancelEdit = document.getElementById("cancelEdit");
  const uidLine = document.getElementById("uidLine");
  const displayNameInput = document.getElementById("displayName");
  const usernameInput = document.getElementById("username");
  const ageInput = document.getElementById("age");
  const locationInput = document.getElementById("location");
  const genderInput = document.getElementById("gender");        // optional if you added gender
  const hobbiesInput = document.getElementById("hobbies");      // <-- NEW
  const interestsInput = document.getElementById("interests");  // <-- NEW
  const bioInput = document.getElementById("bio");
  const avatarInput = document.getElementById("avatar");
  const uploadStatus = document.getElementById("uploadStatus");
  const galleryEl = document.getElementById("gallery");
  const previewTitle = document.getElementById("previewTitle");
  const previewGallery = document.getElementById("previewGallery");
  const reqDisplayName = document.getElementById("reqDisplayName");
  const reqAge = document.getElementById("reqAge");
  const reqLocation = document.getElementById("reqLocation");
  const reqPhoto = document.getElementById("reqPhoto");

  /* ===== SECTION: State ===== */
  let me = null;
  let myDocCached = null;
  let allUsers = [];     // other user docs
  let matches = [];      // filtered list / swipe list
  let currentIndex = 0;
  let previewURLs = [];
  let _profileNavGuard = false;
  const FILTERS = { location:"", gender:"any", ageMin:null, ageMax:null }; // if you use filters

  /* ===== SECTION: Required Markers ===== */
  reqDisplayName.hidden = !REQUIRED.DISPLAY_NAME;
  reqAge.hidden = !REQUIRED.AGE;
  reqLocation.hidden = !REQUIRED.LOCATION;
  reqPhoto.hidden = !REQUIRED.PHOTO;

  /* ===== SECTION: Helper – UI Feedback ===== */
  function showError(msg){ uploadStatus.innerHTML = `<span class="err">${msg}</span>`; }
  function showOK(msg){ uploadStatus.innerHTML = `<span class="ok">${msg}</span>`; }

  /* ===== SECTION: Helper – Renderers ===== */
  function renderBadges(badges=[]) {
    badgesEl.innerHTML = "";
    badges.forEach(url => { const img = document.createElement("img"); img.src=url; img.alt="badge"; badgesEl.appendChild(img); });
  }
  function renderFlags(flags=[]) {
    flagsEl.innerHTML = "";
    flags.forEach(()=>{ const img=document.createElement("img"); img.src="https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_icon_red.svg"; img.alt="flag"; flagsEl.appendChild(img); });
  }
  function renderProfile(p) {
    if (!p) {
      mainPhoto.src=""; nameEl.textContent=""; handleEl.textContent=""; subInfo.textContent="";
      renderBadges([]); renderFlags([]); emptyEl.style.display="flex"; return;
    }
    emptyEl.style.display="none";
    const primary = p.photoURL || (Array.isArray(p.photos)&&p.photos[0]) || "https://via.placeholder.com/800x1200";
    mainPhoto.src = primary;
    const name = p.displayName || "Member";
    const age  = p.age ? `, ${p.age}` : "";
    nameEl.textContent = `${name}${age}`;
    handleEl.textContent = p.username ? `@${p.username}` : "";
    // Show location + a hint of hobbies/interests if set
    const hobbyHint = (p.hobbies && p.hobbies.trim()) ? ` • ${p.hobbies.trim().slice(0,20)}${p.hobbies.trim().length>20?'…':''}` : "";
    const interestHint = (p.interests && p.interests.trim()) ? ` • ${p.interests.trim().slice(0,20)}${p.interests.trim().length>20?'…':''}` : "";
    subInfo.textContent = (p.location || "") + hobbyHint + interestHint;
    renderBadges(p.badges||[]);
    renderFlags(p.flags||[]);
  }
  function renderGallery(photos=[]) {
    galleryEl.innerHTML = "";
    (photos||[]).forEach((url,i)=>{
      const box=document.createElement("div"); box.className="thumb"+(i===0?" primary":"");
      const img=document.createElement("img"); img.src=url;
      const lbl=document.createElement("div"); lbl.className="label-pill"; lbl.textContent = i===0?"Primary":`Photo ${i+1}`;
      box.appendChild(img); box.appendChild(lbl);
      box.addEventListener("click", async ()=>{
        try{
          if(!me) return;
          const uref = doc(db,"users",me.uid);
          const snap = await getDoc(uref); const current = snap.data()||{};
          let photosNow = Array.isArray(current.photos)?[...current.photos]:[];
          const idx = photosNow.indexOf(url); if (idx>0){ photosNow.splice(idx,1); photosNow.unshift(url); }
          await updateProfile(me,{ photoURL:url });
          await setDoc(uref,{ photoURL:url, photos:photosNow, updatedAt:serverTimestamp() },{ merge:true });
          myDocCached = { ...(myDocCached||{}), photoURL:url, photos:photosNow };
          renderGallery(photosNow); if(!matches.length) renderProfile(myDocCached);
          showOK("Primary photo updated.");
        }catch(e){ showError(`Could not set primary: ${e?.message||'error'}`); }
      });
      galleryEl.appendChild(box);
    });
  }
  function clearPreviews(){ previewURLs.forEach(u=>URL.revokeObjectURL(u)); previewURLs=[]; previewGallery.innerHTML=""; previewTitle.hidden=true; previewGallery.hidden=true; }
  function renderPreviews(files){ clearPreviews(); if(!files?.length) return; previewTitle.hidden=false; previewGallery.hidden=false;
    [...files].forEach((f,i)=>{ const url=URL.createObjectURL(f); previewURLs.push(url);
      const box=document.createElement("div"); box.className="thumb";
      const img=document.createElement("img"); img.src=url;
      const lbl=document.createElement("div"); lbl.className="label-pill"; lbl.textContent=`New ${i+1}`;
      box.appendChild(img); box.appendChild(lbl); previewGallery.appendChild(box);
    });
  }

  /* ===== SECTION: Validation ===== */
  function validateBeforeSave(currentDoc, filesPending){
    const pending = (filesPending&&filesPending.length)||0;
    const saved = Array.isArray(currentDoc?.photos)?currentDoc.photos:[];
    const hasPhoto = saved.length>0 || pending>0 || !!currentDoc?.photoURL;
    if(REQUIRED.PHOTO && !hasPhoto) return {ok:false, message:"Add at least one photo before saving.", focus:"photo"};
    const loc=(locationInput.value||"").trim(); if(REQUIRED.LOCATION && !loc) return {ok:false, message:"Please enter your location before saving.", focus:"location"};
    const dn=(displayNameInput.value||"").trim(); if(REQUIRED.DISPLAY_NAME && !dn) return {ok:false, message:"Please enter your display name before saving.", focus:"displayName"};
    if(REQUIRED.AGE){ const a=Number(ageInput.value); if(!Number.isFinite(a)||a<18||a>100) return {ok:false, message:"Please enter a valid age (18–100).", focus:"age"} }
    return {ok:true};
  }
  function refreshSaveButtonState(currentDoc){
    const res = validateBeforeSave(currentDoc, avatarInput.files);
    saveEdit.disabled = !res.ok;
    if(!res.ok) uploadStatus.innerHTML = `<span class="prog">${res.message}</span>`; else uploadStatus.textContent="";
  }
  function focusInvalid(key){
    if(key==="location"){ locationInput.classList.add("invalid"); locationInput.scrollIntoView({behavior:"smooth",block:"center"}); locationInput.focus(); }
    if(key==="displayName"){ displayNameInput.classList.add("invalid"); displayNameInput.scrollIntoView({behavior:"smooth",block:"center"}); displayNameInput.focus(); }
    if(key==="age"){ ageInput.classList.add("invalid"); ageInput.scrollIntoView({behavior:"smooth",block:"center"}); ageInput.focus(); }
    if(key==="photo"){ avatarInput.scrollIntoView({behavior:"smooth",block:"center"}); }
  }

  // Live validation & previews
  [displayNameInput, usernameInput, ageInput, locationInput, bioInput].forEach(el=>el?.addEventListener("input",()=>refreshSaveButtonState(myDocCached)));
  genderInput?.addEventListener("input",()=>refreshSaveButtonState(myDocCached));
  hobbiesInput?.addEventListener("input",()=>refreshSaveButtonState(myDocCached));
  interestsInput?.addEventListener("input",()=>refreshSaveButtonState(myDocCached));
  avatarInput.addEventListener("change",(e)=>{ renderPreviews(e.target.files); refreshSaveButtonState(myDocCached); });

  /* ===== SECTION: Swipe (Touch/Buttons) ===== */
  function nextProfile(){ currentIndex++; renderProfile(matches[currentIndex]||null); }
  function showIndicator(t){ passIndicator.style.opacity = t==="pass"?1:0; likeIndicator.style.opacity = t==="like"?1:0; }
  let startX=0, dx=0, dragging=false;
  cardFrame.addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; dragging=true; });
  cardFrame.addEventListener("touchmove", e=>{
    if(!dragging)return; dx=e.touches[0].clientX-startX;
    if(dx>50)showIndicator("like"); else if(dx<-50)showIndicator("pass"); else showIndicator(null);
  });
  cardFrame.addEventListener("touchend", ()=>{ if(!dragging)return; if(Math.abs(dx)>100) nextProfile(); showIndicator(null); dragging=false; dx=0; });
  passBtn.addEventListener("click", nextProfile);
  likeBtn.addEventListener("click", nextProfile);

  /* ===== SECTION: Modal (Open/Close) ===== */
  editBtn.addEventListener("click", ()=>{
    uploadStatus.textContent="";
    ["invalid"].forEach(c=>{displayNameInput.classList.remove(c); ageInput.classList.remove(c); locationInput.classList.remove(c);});
    editModal.style.display="flex";
    refreshSaveButtonState(myDocCached);
  });
  cancelEdit.addEventListener("click", ()=>{
    editModal.style.display="none"; clearPreviews();
    ["invalid"].forEach(c=>{displayNameInput.classList.remove(c); ageInput.classList.remove(c); locationInput.classList.remove(c);});
  });

  /* ===== SECTION: Data Layer (Load/Create/Save) ===== */
  async function loadOrCreateUserDoc(uid, userObj){
    const uref = doc(db,"users",uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      const seed = {
        uid,
        displayName:userObj.displayName||"Member",
        username:"",
        gender:"",
        hobbies:"",          // NEW
        interests:"",        // NEW
        photoURL:userObj.photoURL||"",
        photos:userObj.photoURL?[userObj.photoURL]:[],
        bio:"", age:null, location:"",
        badges:[], flags:[],
        membership:{ tier:"free" },
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      };
      await setDoc(uref, seed);
      return seed;
    }
    return snap.data();
  }

  async function saveEdits(){
    if(!me) return;
    saveEdit.disabled = true; uploadStatus.innerHTML = `<span class="prog">Saving…</span>`;
    try{
      const uref = doc(db,"users",me.uid);
      const pre = await getDoc(uref); const currentDoc = pre.data()||{};
      const files = Array.from(avatarInput.files||[]);
      const check = validateBeforeSave(currentDoc, files);
      if(!check.ok){ showError(check.message); focusInvalid(check.focus); saveEdit.disabled=false; return; }

      let photos = Array.isArray(currentDoc.photos)?[...currentDoc.photos]:[];
      if(files.length){ uploadStatus.innerHTML = `<span class="prog">Uploading ${files.length} photo(s)…</span>`; }
      for(const f of files){ const path=`avatars/${me.uid}/${Date.now()}_${f.name}`; const r=sRef(storage,path); await uploadBytes(r,f); const url=await getDownloadURL(r); photos.push(url); }

      let photoURL = currentDoc.photoURL || photos[0] || "";
      if(!currentDoc.photoURL && photos[0]){ await updateProfile(me,{ photoURL:photos[0] }); photoURL = photos[0]; }

      const payload = {
        displayName: (displayNameInput.value||"").trim(),
        username: (usernameInput.value||"").trim(),
        gender: (genderInput?.value||"").trim(),
        hobbies: (hobbiesInput?.value||"").trim(),       // NEW
        interests: (interestsInput?.value||"").trim(),   // NEW
        bio: (bioInput.value||"").trim(),
        age: ageInput.value ? Number(ageInput.value) : null,
        location: (locationInput.value||"").trim(),
        photoURL, photos, updatedAt: serverTimestamp()
      };
      await setDoc(uref, payload, { merge:true });
      myDocCached = { ...(myDocCached||{}), ...payload };

      topLine.textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
      handleEl.textContent = myDocCached.username ? `@${myDocCached.username}` : "";

      renderGallery(photos); if(!matches.length) renderProfile(myDocCached);

      avatarInput.value=""; clearPreviews();
      showOK("Profile saved."); setTimeout(()=>{ editModal.style.display="none"; }, 500);

      // if you’re using client-side filters, re-apply after edits
      rebuildMatches?.();
    }catch(e){ showError(`Save failed: ${e?.message||'error'}`); }
    finally{ saveEdit.disabled=false; }
  }
  saveEdit.addEventListener("click", saveEdits);

  /* ===== SECTION: Filters (Optional) ===== */
  function applyFilters(list){
    if (!list) return [];
    // Only used if your filter modal exists in HTML
    const locFilter = (FILTERS.location||"").toLowerCase();
    return list.filter(u=>{
      if (locFilter && !(u.location||"").toLowerCase().includes(locFilter)) return false;
      if (FILTERS.gender && FILTERS.gender!=="any") {
        const g = (u.gender||"").toLowerCase();
        if (g !== FILTERS.gender) return false;
      }
      const age = typeof u.age==="number" ? u.age : null;
      if (FILTERS.ageMin!=null && (age==null || age < FILTERS.ageMin)) return false;
      if (FILTERS.ageMax!=null && (age==null || age > FILTERS.ageMax)) return false;
      return true;
    });
  }
  function rebuildMatches(){
    const filtered = applyFilters(allUsers);
    matches = filtered.length ? filtered : (myDocCached ? [myDocCached] : []);
    currentIndex = 0;
    renderProfile(matches[currentIndex] || null);
  }

  // Wire filter modal only if present
  if (filterBtn && filterModal) {
    filterBtn.addEventListener("click", ()=>{
      filterModal.style.display="flex";
      fLocation.value = FILTERS.location || "";
      fGender.value = FILTERS.gender || "any";
      fAgeMin.value = FILTERS.ageMin ?? "";
      fAgeMax.value = FILTERS.ageMax ?? "";
    });
    filterCancel?.addEventListener("click", ()=>{ filterModal.style.display="none"; });
    filterApply?.addEventListener("click", ()=>{
      FILTERS.location = (fLocation.value||"").trim();
      FILTERS.gender = fGender.value || "any";
      FILTERS.ageMin = fAgeMin.value ? Number(fAgeMin.value) : null;
      FILTERS.ageMax = fAgeMax.value ? Number(fAgeMax.value) : null;
      filterModal.style.display="none";
      rebuildMatches();
    });
  }

  /* ===== SECTION: Membership Gating Stubs ===== */
  function isMember(userDoc){
    const tier = userDoc?.membership?.tier || "free";
    return tier !== "free";
  }
  // Example hooks (plug into UI buttons if/when you add them)
  async function openLikesList(){
    if (MEMBERSHIP.requiredForLikes && !isMember(myDocCached)) {
      alert("Upgrade to a member to see who liked you.");
      return;
    }
    // TODO: render likes
  }
  async function openViewsList(){
    if (MEMBERSHIP.requiredForViews && !isMember(myDocCached)) {
      alert("Upgrade to a member to see who viewed your profile.");
      return;
    }
    // TODO: render views
  }

  /* ===== SECTION: Auth / Init (No Loops) ===== */
  myProfileBtn.addEventListener("click", ()=>{ if(me){ location.replace(`./profile.html?uid=${encodeURIComponent(me.uid)}`); } });
  logoutBtn.addEventListener("click", async ()=>{ try{ await signOut(auth); location.replace("./login.html"); }catch(e){ console.error("Logout error:", e); } });

  // ---- Go Paid (Square checkout) ----
  if (upgradeBtn) {
    upgradeBtn.addEventListener("click", async () => {
      if (!me) return;
      try {
        const resp = await fetch("/api/create-checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ uid: me.uid, email: me.email }),
        });
        const data = await resp.json();
        if (data.checkoutUrl) {
          location.href = data.checkoutUrl;
        } else {
          alert("Could not start checkout.");
        }
      } catch (e) {
        console.error(e);
        alert("Checkout error");
      }
    });
  }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      if(!_profileNavGuard){ _profileNavGuard=true; location.replace("./login.html"); }
      return;
    }
    me = user;

    // Load/create user doc and hydrate UI
    myDocCached = await loadOrCreateUserDoc(me.uid, me);
    displayNameInput.value = myDocCached.displayName || "";
    usernameInput.value   = myDocCached.username || "";
    genderInput && (genderInput.value = myDocCached.gender || "");
    hobbiesInput && (hobbiesInput.value = myDocCached.hobbies || "");       // NEW
    interestsInput && (interestsInput.value = myDocCached.interests || ""); // NEW
    bioInput.value        = myDocCached.bio || "";
    ageInput.value        = myDocCached.age || "";
    locationInput.value   = myDocCached.location || "";
    renderGallery(myDocCached.photos || []);
    topLine.textContent   = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
    uidLine.textContent   = topLine.textContent;

    // Load others (exclude me)
    const snap = await getDocs(collection(db,"users"));
    allUsers = [];
    snap.forEach(d=>{ if(d.id!==me.uid) allUsers.push(d.data()); });

    rebuildMatches(); // applies current FILTERS (or falls back to me)
    refreshSaveButtonState(myDocCached);
  });
</script>
