<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unhinged — Profile Swipe</title>
<style>
  :root { --bg:#0e0e12; --panel:#15161b; --muted:#cfd0de; --red:#E11D2A; --green:#4CAF50; }
  * { box-sizing:border-box; }
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:#fff;min-height:100vh;display:flex;flex-direction:column}

  /* ===== Top Bar (SECTION) ===== */
  .section-label{font-size:.8rem;letter-spacing:.12em;text-transform:uppercase;color:#9aa0ab;margin:10px 0 0 0}
  .divider{height:1px;background:#2a2a2a;margin:8px 0 12px 0;border:0}
  .topbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:var(--panel);border-bottom:1px solid #2a2a2a}
  .brand{font-weight:700}
  .nav-actions{display:flex;gap:.5rem}
  .btn,.linkbtn{border:none;background:var(--red);color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
  .btn.secondary{background:#2a2a2a;color:#fff}
  .btn.ghost{background:transparent;border:1px solid #2a2a2a;color:#fff}

  /* Content wrapper */
  .content{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px;width:100%}

  /* ===== Matches Swipe Card (SECTION) ===== */
  .card-frame{position:relative;width:92%;max-width:420px;height:72vh;border:2px solid #2a2a2a;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 8px 24px rgba(0,0,0,.4);touch-action:pan-y}
  .main-photo{width:100%;height:100%;object-fit:cover;user-select:none;-webkit-user-drag:none}
  .info-overlay{position:absolute;left:0;right:0;bottom:0;padding:14px 16px;background:linear-gradient(transparent, rgba(0,0,0,.78));pointer-events:none}
  .info-overlay h2{margin:0;font-size:1.4rem}
  .handle{font-size:.95rem;color:#cfd0de;margin-top:2px}
  .sub{font-size:.9rem;color:#ddd;margin-top:2px}
  .badges,.flags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .badges img{width:28px;height:28px;border-radius:50%;border:1px solid #4cafef;background:#2a2a3a;padding:2px}
  .flags img{width:24px;height:24px;border-radius:50%;border:1px solid var(--red);background:#3a2a2a;padding:2px}
  .indicator{position:absolute;top:16px;font-size:1.4rem;font-weight:700;padding:6px 12px;border:3px solid;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .12s ease}
  .indicator.pass{left:14px;color:var(--red);border-color:var(--red);transform:rotate(-18deg)}
  .indicator.like{right:14px;color:var(--green);border-color:var(--green);transform:rotate(18deg)}
  .empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:1.1rem}

  /* ===== Bottom Actions (SECTION) ===== */
  .actions{width:100%;max-width:480px;display:flex;justify-content:space-around;align-items:center;padding:8px 0 16px}
  .action-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .pass-btn{background:#2a2a2a;color:var(--red)}
  .like-btn{background:#2a2a2a;color:var(--green)}
  .chaos-btn{background:var(--red);color:#fff;border:none;border-radius:16px;padding:8px 16px;cursor:pointer}

  /* ===== Edit Profile (SECTION) ===== */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:1rem}
  .modal{width:100%;max-width:680px;background:var(--panel);border:1px solid #2a2a2a;border-radius:12px;padding:1rem}
  .modal h3{margin:0 0 .5rem}
  label{display:block;margin:.5rem 0 .25rem;color:#fff}
  input[type="text"],textarea,input[type="number"]{width:100%;padding:.6rem;border:1px solid #2a2a2a;border-radius:8px;background:#12131a;color:#fff}
  .row{display:flex;gap:.5rem}
  .row>*{flex:1}
  .muted{color:var(--muted);font-size:.9rem}

  /* Subsections visual headers inside modal */
  .subhead{margin-top:10px;font-size:.8rem;letter-spacing:.12em;text-transform:uppercase;color:#9aa0ab}
  .subdiv{height:1px;background:#2a2a2a;margin:6px 0 10px 0;border:0}

  /* Gallery */
  .gallery{margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:8px}
  .thumb{position:relative;width:100%;padding-top:100%;border:2px solid #2a2a2a;border-radius:8px;overflow:hidden;background:#0b0b0f;cursor:pointer}
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .label-pill{position:absolute;left:6px;top:6px;font-size:.7rem;background:#000000aa;padding:2px 6px;border-radius:999px;border:1px solid #2a2a2a}
  .thumb.primary{border-color:var(--red)}
  .hint{font-size:.85rem;color:#cfd0de;margin-top:.25rem}

  /* Upload status */
  .status{margin-top:.5rem;font-size:.9rem}
  .ok{color:#6fdc8c}
  .err{color:#ff8e8e}
  .prog{color:#ffd27f}
</style>
</head>
<body>

<!-- ===== Top Bar (SECTION) ===== -->
<div class="topbar">
  <div>
    <div class="section-label">Section</div>
    <div class="brand">Top Bar</div>
  </div>
  <div class="nav-actions">
    <a class="btn ghost" href="./app.html">Community Chaos</a>
    <a class="btn secondary" id="myProfileBtn">My Profile</a>
    <button class="btn" id="editBtn">Edit Profile</button>
  </div>
</div>

<div class="content">
  <!-- ===== Matches Swipe Card (SECTION) ===== -->
  <div style="width:92%;max-width:420px">
    <div class="section-label">Section</div>
    <div style="font-weight:700;margin-bottom:6px">Matches Swipe Card</div>
    <div class="divider"></div>
  </div>

  <div class="card-frame" id="cardFrame">
    <img class="main-photo" id="main-photo" src="" alt="Profile Photo">
    <div class="info-overlay">
      <h2 id="name"></h2>
      <div class="handle" id="handle"></div>
      <div class="sub" id="sub-info"></div>
      <div class="badges" id="badges"></div>
      <div class="flags" id="flags"></div>
    </div>
    <div class="indicator pass" id="pass-indicator">PASS</div>
    <div class="indicator like" id="like-indicator">LIKE</div>
    <div class="empty" id="empty" style="display:none;">No more matches</div>
  </div>

  <!-- ===== Bottom Actions (SECTION) ===== -->
  <div style="width:92%;max-width:480px">
    <div class="section-label">Section</div>
    <div style="font-weight:700;margin:10px 0 6px">Bottom Actions</div>
    <div class="divider"></div>
  </div>

  <div class="actions">
    <button class="action-btn pass-btn" id="pass-btn">✖</button>
    <button class="chaos-btn" onclick="location.href='./app.html'">Community Chaos</button>
    <button class="action-btn like-btn" id="like-btn">❤</button>
  </div>
</div>

<!-- ===== Edit Profile (SECTION) ===== -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <div class="section-label">Section</div>
    <h3>Edit Profile</h3>
    <div class="divider"></div>
    <div class="muted" id="uidLine"></div>

    <!-- Account subsection -->
    <div class="subhead">Account</div><hr class="subdiv">
    <div class="row">
      <div>
        <label for="displayName">Display name</label>
        <input id="displayName" type="text" />
      </div>
      <div>
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="yourhandle" />
      </div>
    </div>

    <!-- About subsection -->
    <div class="subhead">About</div><hr class="subdiv">
    <div class="row">
      <div>
        <label for="age">Age</label>
        <input id="age" type="number" min="18" max="100" />
      </div>
      <div>
        <label for="location">Location</label>
        <input id="location" type="text" placeholder="City, State" />
      </div>
    </div>
    <label for="bio">Bio</label>
    <textarea id="bio" rows="3" placeholder="Say something…"></textarea>

    <!-- Photos subsection -->
    <div class="subhead">Photos</div><hr class="subdiv">
    <label for="avatar">Add photos (you can select multiple)</label>
    <input id="avatar" type="file" accept="image/*" multiple />
    <div class="hint">Click a saved photo below to set it as your <b>Primary</b>.</div>
    <div class="status" id="uploadStatus"></div>

    <div class="muted" style="margin-top:.5rem;">Saved Photos</div>
    <div class="gallery" id="gallery"></div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn secondary" id="cancelEdit">Cancel</button>
      <button class="btn" id="saveEdit">Save</button>
    </div>
  </div>
</div>

<script type="module">
  /* Firebase imports */
  import { auth, db, storage } from "./js/firebase.js";
  import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  /* Refs */
  const cardFrame = document.getElementById("cardFrame");
  const mainPhoto = document.getElementById("main-photo");
  const nameEl = document.getElementById("name");
  const handleEl = document.getElementById("handle");
  const subInfo = document.getElementById("sub-info");
  const badgesEl = document.getElementById("badges");
  const flagsEl = document.getElementById("flags");
  const passBtn = document.getElementById("pass-btn");
  const likeBtn = document.getElementById("like-btn");
  const passIndicator = document.getElementById("pass-indicator");
  const likeIndicator = document.getElementById("like-indicator");
  const emptyEl = document.getElementById("empty");

  const editBtn = document.getElementById("editBtn");
  const editModal = document.getElementById("editModal");
  const saveEdit = document.getElementById("saveEdit");
  const cancelEdit = document.getElementById("cancelEdit");
  const uidLine = document.getElementById("uidLine");
  const displayNameInput = document.getElementById("displayName");
  const usernameInput = document.getElementById("username");
  const ageInput = document.getElementById("age");
  const locationInput = document.getElementById("location");
  const bioInput = document.getElementById("bio");
  const avatarInput = document.getElementById("avatar");
  const uploadStatus = document.getElementById("uploadStatus");
  const galleryEl = document.getElementById("gallery");
  const myProfileBtn = document.getElementById("myProfileBtn");

  /* State */
  let me = null;
  let matches = [];
  let currentIndex = 0;
  let myDocCached = null;

  /* Helpers */
  function renderBadges(badges=[]) {
    badgesEl.innerHTML = "";
    badges.forEach(url => {
      const img = document.createElement("img");
      img.src = url; img.alt = "badge";
      badgesEl.appendChild(img);
    });
  }
  function renderFlags(flags=[]) {
    flagsEl.innerHTML = "";
    flags.forEach(() => {
      const img = document.createElement("img");
      img.src = "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_icon_red.svg";
      img.alt = "flag";
      badgesEl?.append // no-op to avoid unused warning
      flagsEl.appendChild(img);
    });
  }
  function renderProfile(profile) {
    if (!profile) {
      mainPhoto.src = ""; nameEl.textContent=""; handleEl.textContent=""; subInfo.textContent="";
      renderBadges([]); renderFlags([]); emptyEl.style.display="flex"; return;
    }
    emptyEl.style.display="none";
    const primary = profile.photoURL || (Array.isArray(profile.photos) && profile.photos[0]) || "https://via.placeholder.com/800x1200";
    mainPhoto.src = primary;
    const name = profile.displayName || "Member";
    const age = profile.age ? `, ${profile.age}` : "";
    nameEl.textContent = `${name}${age}`;
    handleEl.textContent = profile.username ? `@${profile.username}` : "";
    subInfo.textContent = profile.location || "";
    renderBadges(profile.badges || []);
    renderFlags(profile.flags || []);
  }
  function renderGallery(photos=[]) {
    galleryEl.innerHTML = "";
    if (!Array.isArray(photos)) photos = [];
    photos.forEach((url, i) => {
      const box = document.createElement("div");
      box.className = "thumb" + (i===0 ? " primary" : "");
      box.dataset.url = url;
      const img = document.createElement("img"); img.src = url;
      const lbl = document.createElement("div"); lbl.className="label-pill"; lbl.textContent = i===0 ? "Primary" : `Photo ${i+1}`;
      box.appendChild(img); box.appendChild(lbl);
      // Set as primary
      box.addEventListener("click", async () => {
        try{
          if (!me) return;
          const uref = doc(db,"users",me.uid);
          const snap = await getDoc(uref);
          const current = snap.data() || {};
          let photosNow = Array.isArray(current.photos) ? [...current.photos] : [];
          const index = photosNow.indexOf(url);
          if (index > 0) { photosNow.splice(index,1); photosNow.unshift(url); }
          await updateProfile(me,{ photoURL:url });
          await setDoc(uref,{ photoURL:url, photos:photosNow, updatedAt:serverTimestamp() },{ merge:true });
          myDocCached = { ...(myDocCached||{}), photoURL:url, photos:photosNow };
          renderGallery(photosNow);
          if (!matches.length) renderProfile(myDocCached);
          uploadStatus.innerHTML = `<span class="ok">Primary photo updated.</span>`;
        }catch(err){
          console.error(err);
          uploadStatus.innerHTML = `<span class="err">Could not set primary: ${err?.message||'error'}</span>`;
        }
      });
      galleryEl.appendChild(box);
    });
  }
  function nextProfile(){ currentIndex++; renderProfile(matches[currentIndex] || null); }
  function showIndicator(type){
    passIndicator.style.opacity = type==="pass" ? 1 : 0;
    likeIndicator.style.opacity = type==="like" ? 1 : 0;
  }

  /* Swipe (touch) */
  let startX=0, deltaX=0, dragging=false;
  cardFrame.addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; dragging=true; });
  cardFrame.addEventListener("touchmove", e=>{
    if(!dragging) return;
    deltaX = e.touches[0].clientX - startX;
    if(deltaX>50) showIndicator("like");
    else if(deltaX<-50) showIndicator("pass");
    else showIndicator(null);
  });
  cardFrame.addEventListener("touchend", ()=>{
    if(!dragging) return;
    if(Math.abs(deltaX)>100) nextProfile();
    showIndicator(null); dragging=false; deltaX=0;
  });

  /* Click actions */
  passBtn.addEventListener("click", nextProfile);
  likeBtn.addEventListener("click", nextProfile);

  /* Modal controls */
  editBtn.addEventListener("click", ()=>{ uploadStatus.textContent=""; editModal.style.display="flex"; });
  cancelEdit.addEventListener("click", ()=>{ editModal.style.display="none"; });

  /* Create user doc if missing */
  async function loadOrCreateUserDoc(uid, userObj){
    const uref = doc(db,"users",uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      const seed = {
        uid, displayName:userObj.displayName||"Member", username:"",
        photoURL:userObj.photoURL||"", photos: userObj.photoURL ? [userObj.photoURL] : [],
        bio:"", age:null, location:"", badges:[], flags:[],
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      };
      await setDoc(uref, seed);
      return seed;
    }
    return snap.data();
  }

  /* Save edits + upload photos (robust status & clearing) */
  saveEdit.addEventListener("click", async ()=>{
    if(!me) return;
    saveEdit.disabled = true;
    uploadStatus.innerHTML = `<span class="prog">Saving…</span>`;
    try{
      const uref = doc(db,"users",me.uid);
      const snap = await getDoc(uref);
      const current = snap.data() || {};
      let photos = Array.isArray(current.photos) ? [...current.photos] : [];

      const files = Array.from(avatarInput.files || []);
      if(files.length){
        uploadStatus.innerHTML = `<span class="prog">Uploading ${files.length} photo(s)…</span>`;
      }
      for (const f of files){
        const path = `avatars/${me.uid}/${Date.now()}_${f.name}`;
        const r = sRef(storage, path);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        photos.push(url);
      }

      // Ensure primary
      let photoURL = current.photoURL || photos[0] || "";
      if(!current.photoURL && photos[0]){
        await updateProfile(me,{ photoURL: photos[0] });
        photoURL = photos[0];
      }

      const payload = {
        displayName: displayNameInput.value.trim(),
        username: usernameInput.value.trim(),
        bio: bioInput.value.trim(),
        age: ageInput.value ? Number(ageInput.value) : null,
        location: locationInput.value.trim(),
        photoURL, photos,
        updatedAt: serverTimestamp()
      };
      await setDoc(uref, payload, { merge:true });
      myDocCached = { ...(myDocCached||{}), ...payload };
      renderGallery(photos);
      if(!matches.length) renderProfile(myDocCached);

      // Reset input so same file can be re-chosen later
      avatarInput.value = "";
      uploadStatus.innerHTML = `<span class="ok">Profile saved.</span>`;
      setTimeout(()=>{ editModal.style.display="none"; }, 500);
    }catch(err){
      console.error(err);
      uploadStatus.innerHTML = `<span class="err">Save failed: ${err?.message||'error'}</span>`;
    }finally{
      saveEdit.disabled = false;
    }
  });

  /* Init */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("./login.html"); return; }
    me = user;
    myProfileBtn.onclick = ()=> location.replace(`./profile.html?uid=${encodeURIComponent(me.uid)}`);
    uidLine.textContent = `UID: ${me.uid}`;

    // Ensure doc & prefill modal
    myDocCached = await loadOrCreateUserDoc(me.uid, me);
    displayNameInput.value = myDocCached.displayName || "";
    usernameInput.value = myDocCached.username || "";
    bioInput.value = myDocCached.bio || "";
    ageInput.value = myDocCached.age || "";
    locationInput.value = myDocCached.location || "";
    renderGallery(myDocCached.photos || []);

    // Load others; fallback to self
    const snap = await getDocs(collection(db,"users"));
    matches = [];
    snap.forEach(d => { if(d.id !== me.uid) matches.push(d.data()); });
    if(!matches.length) matches.push(myDocCached);

    currentIndex = 0;
    renderProfile(matches[currentIndex]);
  });
</script>

</body>
</html>
