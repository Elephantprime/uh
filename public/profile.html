// /public/js/profile.js
import { auth } from './firebase.js';
import {
  onAuthStateChanged,
  signOut,
  updateProfile,
  deleteUser
} from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

const $ = (id) => document.getElementById(id);

const statusEl   = $('status');
const box        = $('profileBox');
const emailEl    = $('email');
const nameInput  = $('displayName');
const saveBtn    = $('save');
const delBtn     = $('deleteAcct');
const logoutBtn  = $('logout');

// Where to send members after they have a display name:
const AFTER_SAVE_URL = './app.html';   // change if your member app is a different file

function setStatus(msg) { if (statusEl) statusEl.textContent = msg; }

onAuthStateChanged(auth, (user) => {
  if (!user) {
    // Not signed in → back to login
    location.replace('./login.html');
    return;
  }

  // Signed in: show profile box and populate fields
  if (box) box.style.display = '';
  setStatus('');

  if (emailEl)   emailEl.textContent = user.email || '—';
  if (nameInput) nameInput.value = user.displayName || '';

  // If user already has a name, you can skip this page automatically.
  // Comment out the next 3 lines if you always want them to see Profile first.
  if (user.displayName && user.displayName.trim().length > 0) {
    location.replace(AFTER_SAVE_URL);
    return;
  }
});

// Save display name
if (saveBtn) {
  saveBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;

    const newName = (nameInput?.value || '').trim();
    if (!newName) { setStatus('Enter a display name first'); return; }

    saveBtn.disabled = true;
    setStatus('Saving…');
    try {
      await updateProfile(user, { displayName: newName });
      setStatus('Saved!');
      // Head into the app
      location.replace(AFTER_SAVE_URL);
    } catch (err) {
      console.error(err);
      setStatus(err?.message || 'Could not save');
    } finally {
      saveBtn.disabled = false;
    }
  });
}

// Delete account
if (delBtn) {
  delBtn.addEventListener('click', async () => {
    const user = auth.currentUser;
    if (!user) return;
    if (!confirm('Delete your account permanently?')) return;

    setStatus('Deleting…');
    try {
      await deleteUser(user);
      location.replace('./index.html'); // back to marketing page
    } catch (err) {
      console.error(err);
      setStatus(err?.message || 'Could not delete account');
    }
  });
}

// Log out
if (logoutBtn) {
  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
    } finally {
      location.replace('./index.html'); // back to marketing page
    }
  });
}
