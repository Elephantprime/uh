<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unhinged — Profile Swipe</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0e0e12;
    color: #fff;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
  }
  .photo-container {
    position: relative;
    flex: 1;
    background: #000;
    overflow: hidden;
    touch-action: pan-y;
  }
  .main-photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    user-select: none;
    -webkit-user-drag: none;
  }
  .info-overlay {
    position: absolute;
    bottom: 80px;
    left: 0;
    right: 0;
    padding: 16px;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    pointer-events: none;
  }
  .info-overlay h2 { margin: 0; font-size: 1.6rem; }
  .info-overlay .sub { font-size: 0.9rem; color: #ddd; margin-top: 4px; }
  .badges, .flags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
  .badges img {
    width: 28px; height: 28px; border-radius: 50%;
    border: 1px solid #4cafef; background: #2a2a3a; padding: 2px;
  }
  .flags img {
    width: 24px; height: 24px; border-radius: 50%;
    border: 1px solid #E11D2A; background: #3a2a2a; padding: 2px;
  }
  .indicator {
    position: absolute;
    top: 40px;
    font-size: 2rem;
    font-weight: bold;
    padding: 10px 20px;
    border: 4px solid;
    border-radius: 8px;
    opacity: 0;
    transform: rotate(-20deg);
    pointer-events: none;
  }
  .indicator.pass {
    left: 20px;
    color: #E11D2A;
    border-color: #E11D2A;
  }
  .indicator.like {
    right: 20px;
    color: #4CAF50;
    border-color: #4CAF50;
    transform: rotate(20deg);
  }
  .actions {
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 12px;
    background: #0e0e12;
  }
  .action-btn {
    width: 56px; height: 56px; border-radius: 50%;
    border: none; font-size: 1.5rem; display: flex;
    align-items: center; justify-content: center; cursor: pointer;
  }
  .pass-btn { background: #2a2a2a; color: #E11D2A; }
  .like-btn { background: #2a2a2a; color: #4CAF50; }
  .chaos-btn {
    background: #E11D2A; color: #fff; font-size: 0.9rem;
    border-radius: 16px; padding: 8px 16px; cursor: pointer; border: none;
  }
</style>
</head>
<body>

<div class="photo-container" id="photo-container">
  <img class="main-photo" id="main-photo" src="" alt="Profile Photo">
  <div class="info-overlay">
    <h2 id="name"></h2>
    <div class="sub" id="sub-info"></div>
    <div class="badges" id="badges"></div>
    <div class="flags" id="flags"></div>
  </div>
  <div class="indicator pass" id="pass-indicator">PASS</div>
  <div class="indicator like" id="like-indicator">LIKE</div>
</div>

<div class="actions">
  <button class="action-btn pass-btn" id="pass-btn">✖</button>
  <button class="chaos-btn" onclick="location.href='./app.html'">Community Chaos</button>
  <button class="action-btn like-btn" id="like-btn">❤</button>
</div>

<script type="module">
  import { auth, db } from "./js/firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const photoContainer = document.getElementById("photo-container");
  const mainPhoto = document.getElementById("main-photo");
  const nameEl = document.getElementById("name");
  const subInfo = document.getElementById("sub-info");
  const badgesEl = document.getElementById("badges");
  const flagsEl = document.getElementById("flags");
  const passBtn = document.getElementById("pass-btn");
  const likeBtn = document.getElementById("like-btn");
  const passIndicator = document.getElementById("pass-indicator");
  const likeIndicator = document.getElementById("like-indicator");

  let matches = [];
  let currentIndex = 0;
  let startX = 0;
  let currentX = 0;
  let isDragging = false;

  function renderProfile(profile) {
    if (!profile) {
      mainPhoto.src = "";
      nameEl.textContent = "No more matches";
      subInfo.textContent = "";
      badgesEl.innerHTML = "";
      flagsEl.innerHTML = "";
      return;
    }
    mainPhoto.src = profile.photoURL || "https://via.placeholder.com/500x800";
    nameEl.textContent = `${profile.displayName || "Member"}, ${profile.age || ""}`;
    subInfo.textContent = `${profile.location || ""}`;

    badgesEl.innerHTML = "";
    (profile.badges || []).forEach(url => {
      const img = document.createElement("img");
      img.src = url;
      badgesEl.appendChild(img);
    });

    flagsEl.innerHTML = "";
    (profile.flags || []).forEach(() => {
      const flagIcon = document.createElement("img");
      flagIcon.src = "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_icon_red.svg";
      flagsEl.appendChild(flagIcon);
    });
  }

  function nextProfile() {
    currentIndex++;
    renderProfile(matches[currentIndex]);
  }

  function showIndicator(type) {
    if (type === "pass") {
      passIndicator.style.opacity = 1;
      likeIndicator.style.opacity = 0;
    } else if (type === "like") {
      likeIndicator.style.opacity = 1;
      passIndicator.style.opacity = 0;
    } else {
      passIndicator.style.opacity = 0;
      likeIndicator.style.opacity = 0;
    }
  }

  // Swipe events
  photoContainer.addEventListener("touchstart", e => {
    startX = e.touches[0].clientX;
    isDragging = true;
  });

  photoContainer.addEventListener("touchmove", e => {
    if (!isDragging) return;
    currentX = e.touches[0].clientX - startX;
    if (currentX > 50) showIndicator("like");
    else if (currentX < -50) showIndicator("pass");
    else showIndicator(null);
  });

  photoContainer.addEventListener("touchend", () => {
    if (!isDragging) return;
    if (currentX > 100) {
      nextProfile();
    } else if (currentX < -100) {
      nextProfile();
    }
    showIndicator(null);
    currentX = 0;
    isDragging = false;
  });

  passBtn.addEventListener("click", nextProfile);
  likeBtn.addEventListener("click", nextProfile);

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      location.replace("./login.html");
      return;
    }
    const snap = await getDocs(collection(db, "users"));
    matches = [];
    snap.forEach(doc => {
      if (doc.id !== user.uid) {
        matches.push(doc.data());
      }
    });
    currentIndex = 0;
    renderProfile(matches[currentIndex]);
  });
</script>

</body>
</html>
