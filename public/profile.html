<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unhinged — Profile Swipe</title>
<style>
  :root { --bg:#0e0e12; --panel:#15161b; --muted:#cfd0de; --red:#E11D2A; --green:#4CAF50; }
  * { box-sizing:border-box; }
  body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:#fff;min-height:100vh;display:flex;flex-direction:column}
  .btn{border:none;background:var(--red);color:#fff;padding:.5rem .9rem;border-radius:8px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
  .btn.secondary{background:#2a2a2a}
  .btn.ghost{background:transparent;border:1px solid #2a2a2a}
  .link{color:#9ecbff;text-decoration:none}
  .muted{color:var(--muted);font-size:.9rem}

  /* Top bar */
  .topbar{display:flex;gap:.5rem;align-items:center;justify-content:space-between;padding:.75rem 1rem;background:var(--panel);border-bottom:1px solid #2a2a2a}
  .brand{font-weight:700}
  .nav-actions{display:flex;gap:.5rem}

  /* Content + card */
  .content{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px;gap:12px;width:100%}
  .card-frame{position:relative;width:92%;max-width:420px;height:72vh;border:2px solid #2a2a2a;border-radius:16px;overflow:hidden;background:#000;box-shadow:0 8px 24px rgba(0,0,0,.4);touch-action:pan-y}
  .main-photo{width:100%;height:100%;object-fit:cover;user-select:none;-webkit-user-drag:none}
  .info-overlay{position:absolute;left:0;right:0;bottom:0;padding:14px 16px;background:linear-gradient(transparent, rgba(0,0,0,.78));pointer-events:none}
  .info-overlay h2{margin:0;font-size:1.4rem}
  .handle{font-size:.95rem;color:#cfd0de;margin-top:2px}
  .sub{font-size:.9rem;color:#ddd;margin-top:2px}
  .badges,.flags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .badges img{width:28px;height:28px;border-radius:50%;border:1px solid #4cafef;background:#2a2a3a;padding:2px}
  .flags img{width:24px;height:24px;border-radius:50%;border:1px solid var(--red);background:#3a2a2a;padding:2px}
  .indicator{position:absolute;top:16px;font-size:1.4rem;font-weight:700;padding:6px 12px;border:3px solid;border-radius:8px;opacity:0;pointer-events:none;transition:opacity .12s ease}
  .indicator.pass{left:14px;color:var(--red);border-color:var(--red);transform:rotate(-18deg)}
  .indicator.like{right:14px;color:var(--green);border-color:var(--green);transform:rotate(18deg)}
  .empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#ddd;font-size:1.1rem}

  /* Bottom actions */
  .actions{width:100%;max-width:480px;display:flex;justify-content:space-around;align-items:center;padding:8px 0 16px}
  .action-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .pass-btn{background:#2a2a2a;color:var(--red)}
  .like-btn{background:#2a2a2a;color:var(--green)}
  .chaos-btn{background:var(--red);color:#fff;border:none;border-radius:16px;padding:8px 16px;cursor:pointer}

  /* Modal base */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;padding:1rem;z-index:50}
  .modal{width:100%;max-width:680px;background:var(--panel);border:1px solid #2a2a2a;border-radius:12px;padding:1rem}
  .modal h3{margin:0 0 .5rem}
  label{display:flex;align-items:center;gap:.35rem;margin:.5rem 0 .25rem}
  .req{color:#ff6b6b;font-weight:700}
  input[type="text"],textarea,input[type="number"]{width:100%;padding:.6rem;border:1px solid #2a2a2a;border-radius:8px;background:#12131a;color:#fff}
  .row{display:flex;gap:.5rem}
  .row>*{flex:1}
  .status{margin-top:.5rem;font-size:.9rem}
  .ok{color:#6fdc8c}.err{color:#ff8e8e}.prog{color:#ffd27f}
  .invalid{outline:2px solid #ff6b6b;outline-offset:2px;border-color:#ff6b6b !important}

  /* Gallery */
  .gallery{margin-top:.5rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:8px}
  .thumb{position:relative;width:100%;padding-top:100%;border:2px solid #2a2a2a;border-radius:8px;overflow:hidden;background:#0b0b0f;cursor:pointer}
  .thumb img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .label-pill{position:absolute;left:6px;top:6px;font-size:.7rem;background:#000000aa;padding:2px 6px;border-radius:999px;border:1px solid #2a2a2a}
  .thumb.primary{border-color:var(--red)}
  .hint{font-size:.85rem;color:#cfd0de;margin-top:.25rem}

  /* Quiz modal (full-screen gate) */
  .quiz-backdrop{position:fixed;inset:0;background:#0e0e12;display:none;align-items:center;justify-content:center;padding:1rem;z-index:60}
  .quiz{width:100%;max-width:720px;background:var(--panel);border:1px solid #2a2a2a;border-radius:14px;padding:1rem 1rem 1.25rem}
  .quiz h2{margin:.2rem 0 0}
  .quiz p{color:#cfd0de}
  .q{margin:12px 0}
  .q label{display:block;margin:.35rem 0;color:#eaeaf2}
  .quiz-actions{display:flex;justify-content:flex-end;gap:.5rem;margin-top:.75rem}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="topbar">
  <div class="brand" id="topLine">Your Profile</div>
  <div class="nav-actions">
    <a class="btn ghost" href="./app.html">Community Chaos</a>
    <a class="btn secondary" id="myProfileBtn">My Profile</a>
    <button class="btn" id="editBtn">Edit Profile</button>
  </div>
</div>

<!-- Main Content -->
<div class="content" id="mainContent" style="visibility:hidden;">
  <div class="card-frame" id="cardFrame">
    <img class="main-photo" id="main-photo" src="" alt="Profile Photo">
    <div class="info-overlay">
      <h2 id="name"></h2>
      <div class="handle" id="handle"></div>
      <div class="sub" id="sub-info"></div>
      <div class="badges" id="badges"></div>
      <div class="flags" id="flags"></div>
    </div>
    <div class="indicator pass" id="pass-indicator">PASS</div>
    <div class="indicator like" id="like-indicator">LIKE</div>
    <div class="empty" id="empty" style="display:none;">No more matches</div>
  </div>

  <div class="actions">
    <button class="action-btn pass-btn" id="pass-btn">✖</button>
    <button class="chaos-btn" onclick="location.href='./app.html'">Community Chaos</button>
    <button class="action-btn like-btn" id="like-btn">❤</button>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal-backdrop" id="editModal">
  <div class="modal">
    <h3>Edit Profile</h3>
    <div class="muted" id="uidLine"></div>

    <div class="row">
      <div>
        <label for="displayName">Display name <span class="req" id="reqDisplayName" hidden>*</span></label>
        <input id="displayName" type="text" />
      </div>
      <div>
        <label for="username">Username</label>
        <input id="username" type="text" placeholder="yourhandle" />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="age">Age <span class="req" id="reqAge" hidden>*</span></label>
        <input id="age" type="number" min="18" max="100" />
      </div>
      <div>
        <label for="location">Location <span class="req" id="reqLocation" hidden>*</span></label>
        <input id="location" type="text" placeholder="City, State" />
      </div>
    </div>

    <label for="bio">Bio</label>
    <textarea id="bio" rows="3" placeholder="Say something…"></textarea>

    <label for="avatar" style="margin-top:.5rem;">Add photos (you can select multiple) <span class="req" id="reqPhoto" hidden>*</span></label>
    <input id="avatar" type="file" accept="image/*" multiple />
    <div class="hint">Click a saved photo below to set it as your <b>Primary</b>. You’ll see selected files below before uploading.</div>
    <div class="status" id="uploadStatus"></div>

    <div class="muted" style="margin-top:.5rem;" id="previewTitle" hidden>Selected (not yet uploaded)</div>
    <div class="gallery" id="previewGallery" hidden></div>

    <div class="muted" style="margin-top:.75rem;">Saved Photos</div>
    <div class="gallery" id="gallery"></div>

    <div style="margin-top:.75rem;display:flex;gap:.5rem;justify-content:flex-end;">
      <button class="btn secondary" id="cancelEdit">Cancel</button>
      <button class="btn" id="saveEdit">Save</button>
    </div>
  </div>
</div>

<!-- QUIZ GATE (full-screen; must complete before using profile) -->
<div class="quiz-backdrop" id="quizGate">
  <div class="quiz">
    <h2>Quick Start Quiz</h2>
    <p class="muted">Tell us a bit so we can personalize your experience. You must complete this to continue.</p>

    <div class="q">
      <strong>1) What are you looking for?</strong>
      <label><input type="radio" name="q1" value="serious"> Something serious</label>
      <label><input type="radio" name="q1" value="casual"> Casual</label>
      <label><input type="radio" name="q1" value="unsure"> Not sure yet</label>
    </div>

    <div class="q">
      <strong>2) Weekend vibe?</strong>
      <label><input type="radio" name="q2" value="outdoor"> Outdoorsy</label>
      <label><input type="radio" name="q2" value="homebody"> Homebody</label>
      <label><input type="radio" name="q2" value="nightlife"> Nightlife</label>
    </div>

    <div class="q">
      <strong>3) Biggest red flag for you?</strong>
      <label><input type="radio" name="q3" value="lateness"> Always late</label>
      <label><input type="radio" name="q3" value="messy"> Messy</label>
      <label><input type="radio" name="q3" value="none"> None of these</label>
    </div>

    <div class="quiz-actions">
      <button class="btn" id="quizSubmit">Finish Quiz</button>
    </div>
    <div class="status" id="quizStatus"></div>
  </div>
</div>

<script type="module">
  /* Firebase */
  import { auth, db, storage } from "./js/firebase.js";
  import { onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { collection, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  /* ---- Requirements (plug & play) ---- */
  const REQUIRED = {
    PHOTO: true,         // require at least 1 saved photo or a pending file
    LOCATION: true,      // require location to be non-empty
    DISPLAY_NAME: false, // flip true if you want this required now/later
    AGE: false           // flip true to require valid age (18–100)
  };

  // Elements
  const topLine = document.getElementById("topLine");
  const mainContent = document.getElementById("mainContent");
  const cardFrame = document.getElementById("cardFrame");
  const mainPhoto = document.getElementById("main-photo");
  const nameEl = document.getElementById("name");
  const handleEl = document.getElementById("handle");
  const subInfo = document.getElementById("sub-info");
  const badgesEl = document.getElementById("badges");
  const flagsEl = document.getElementById("flags");
  const passBtn = document.getElementById("pass-btn");
  const likeBtn = document.getElementById("like-btn");
  const passIndicator = document.getElementById("pass-indicator");
  const likeIndicator = document.getElementById("like-indicator");
  const emptyEl = document.getElementById("empty");
  const editBtn = document.getElementById("editBtn");
  const editModal = document.getElementById("editModal");
  const saveEdit = document.getElementById("saveEdit");
  const cancelEdit = document.getElementById("cancelEdit");
  const uidLine = document.getElementById("uidLine");
  const displayNameInput = document.getElementById("displayName");
  const usernameInput = document.getElementById("username");
  const ageInput = document.getElementById("age");
  const locationInput = document.getElementById("location");
  const bioInput = document.getElementById("bio");
  const avatarInput = document.getElementById("avatar");
  const uploadStatus = document.getElementById("uploadStatus");
  const galleryEl = document.getElementById("gallery");
  const previewTitle = document.getElementById("previewTitle");
  const previewGallery = document.getElementById("previewGallery");
  const myProfileBtn = document.getElementById("myProfileBtn");
  const reqDisplayName = document.getElementById("reqDisplayName");
  const reqAge = document.getElementById("reqAge");
  const reqLocation = document.getElementById("reqLocation");
  const reqPhoto = document.getElementById("reqPhoto");

  // Quiz
  const quizGate = document.getElementById("quizGate");
  const quizSubmit = document.getElementById("quizSubmit");
  const quizStatus = document.getElementById("quizStatus");

  // State
  let me = null;
  let matches = [];
  let currentIndex = 0;
  let myDocCached = null;
  let previewURLs = [];

  // Required markers
  reqDisplayName.hidden = !REQUIRED.DISPLAY_NAME;
  reqAge.hidden = !REQUIRED.AGE;
  reqLocation.hidden = !REQUIRED.LOCATION;
  reqPhoto.hidden = !REQUIRED.PHOTO;

  /* ---- Helpers ---- */
  function showError(msg){ uploadStatus.innerHTML = `<span class="err">${msg}</span>`; }
  function showOK(msg){ uploadStatus.innerHTML = `<span class="ok">${msg}</span>`; }

  function renderBadges(badges=[]) {
    badgesEl.innerHTML = "";
    badges.forEach(url => {
      const img = document.createElement("img");
      img.src = url; img.alt = "badge";
      badgesEl.appendChild(img);
    });
  }
  function renderFlags(flags=[]) {
    flagsEl.innerHTML = "";
    flags.forEach(() => {
      const img = document.createElement("img");
      img.src = "https://upload.wikimedia.org/wikipedia/commons/f/f7/Flag_icon_red.svg";
      img.alt = "flag";
      flagsEl.appendChild(img);
    });
  }
  function renderProfile(profile) {
    if (!profile) {
      mainPhoto.src = ""; nameEl.textContent=""; handleEl.textContent=""; subInfo.textContent="";
      renderBadges([]); renderFlags([]); emptyEl.style.display="flex"; return;
    }
    emptyEl.style.display="none";
    const primary = profile.photoURL || (Array.isArray(profile.photos) && profile.photos[0]) || "https://via.placeholder.com/800x1200";
    mainPhoto.src = primary;
    const name = profile.displayName || "Member";
    const age = profile.age ? `, ${profile.age}` : "";
    nameEl.textContent = `${name}${age}`;
    handleEl.textContent = profile.username ? `@${profile.username}` : "";
    subInfo.textContent = profile.location || "";
    renderBadges(profile.badges || []);
    renderFlags(profile.flags || []);
  }
  function renderGallery(photos=[]) {
    galleryEl.innerHTML = "";
    if (!Array.isArray(photos)) photos = [];
    photos.forEach((url, i) => {
      const box = document.createElement("div");
      box.className = "thumb" + (i===0 ? " primary" : "");
      const img = document.createElement("img"); img.src = url;
      const lbl = document.createElement("div"); lbl.className="label-pill"; lbl.textContent = i===0 ? "Primary" : `Photo ${i+1}`;
      box.appendChild(img); box.appendChild(lbl);
      box.addEventListener("click", async () => {
        try{
          if (!me) return;
          const uref = doc(db,"users",me.uid);
          const snap = await getDoc(uref);
          const current = snap.data() || {};
          let photosNow = Array.isArray(current.photos) ? [...current.photos] : [];
          const index = photosNow.indexOf(url);
          if (index > 0) { photosNow.splice(index,1); photosNow.unshift(url); }
          await updateProfile(me,{ photoURL:url });
          await setDoc(uref,{ photoURL:url, photos:photosNow, updatedAt:serverTimestamp() },{ merge:true });
          myDocCached = { ...(myDocCached||{}), photoURL:url, photos:photosNow };
          renderGallery(photosNow);
          if (!matches.length) renderProfile(myDocCached);
          uploadStatus.innerHTML = `<span class="ok">Primary photo updated.</span>`;
        }catch(err){
          console.error(err);
          uploadStatus.innerHTML = `<span class="err">Could not set primary: ${err?.message||'error'}</span>`;
        }
      });
      galleryEl.appendChild(box);
    });
  }
  function clearPreviews(){
    previewURLs.forEach(u => URL.revokeObjectURL(u));
    previewURLs = [];
    previewGallery.innerHTML = "";
    previewTitle.hidden = true;
    previewGallery.hidden = true;
  }
  function renderPreviews(files){
    clearPreviews();
    if (!files || !files.length) return;
    previewTitle.hidden = false;
    previewGallery.hidden = false;
    [...files].forEach((f,i)=>{
      const url = URL.createObjectURL(f);
      previewURLs.push(url);
      const box = document.createElement("div");
      box.className = "thumb";
      const img = document.createElement("img"); img.src = url;
      const lbl = document.createElement("div"); lbl.className="label-pill"; lbl.textContent = `New ${i+1}`;
      box.appendChild(img); box.appendChild(lbl);
      previewGallery.appendChild(box);
    });
  }

  /* ---- Validation ---- */
  function firstInvalidFocus(el){ if (!el) return; el.classList.add("invalid"); el.scrollIntoView({behavior:"smooth",block:"center"}); el.focus?.(); }
  function clearInvalids(){ [displayNameInput,ageInput,locationInput].forEach(e=>e.classList.remove("invalid")); }

  function validateBeforeSave(currentDoc, filesPending) {
    const pendingCount = (filesPending && filesPending.length) ? filesPending.length : 0;
    const savedPhotos = Array.isArray(currentDoc?.photos) ? currentDoc.photos : [];
    const willHaveAtLeastOnePhoto = savedPhotos.length > 0 || pendingCount > 0 || !!currentDoc?.photoURL;

    if (REQUIRED.PHOTO && !willHaveAtLeastOnePhoto) {
      return { ok:false, message:"Add at least one photo before saving.", focus:"photo" };
    }
    const loc = (locationInput.value || "").trim();
    if (REQUIRED.LOCATION && !loc) {
      return { ok:false, message:"Please enter your location before saving.", focus:"location" };
    }
    const dn = (displayNameInput.value || "").trim();
    if (REQUIRED.DISPLAY_NAME && !dn) {
      return { ok:false, message:"Please enter your display name before saving.", focus:"displayName" };
    }
    if (REQUIRED.AGE) {
      const ageVal = Number(ageInput.value);
      if (!Number.isFinite(ageVal) || ageVal < 18 || ageVal > 100) {
        return { ok:false, message:"Please enter a valid age (18–100).", focus:"age" };
      }
    }
    return { ok:true };
  }
  function refreshSaveButtonState(currentDoc) {
    const filesPending = avatarInput.files;
    const res = validateBeforeSave(currentDoc, filesPending);
    saveEdit.disabled = !res.ok;
    if (!res.ok) uploadStatus.innerHTML = `<span class="prog">${res.message}</span>`;
    else uploadStatus.textContent = "";
  }

  // Live validation
  [displayNameInput, usernameInput, ageInput, locationInput, bioInput].forEach(el => {
    el.addEventListener("input", () => refreshSaveButtonState(myDocCached));
  });
  avatarInput.addEventListener("change", (e)=>{ renderPreviews(e.target.files); refreshSaveButtonState(myDocCached); });

  /* ---- Swipe ---- */
  function nextProfile(){ currentIndex++; renderProfile(matches[currentIndex] || null); }
  function showIndicator(type){
    passIndicator.style.opacity = type==="pass" ? 1 : 0;
    likeIndicator.style.opacity = type==="like" ? 1 : 0;
  }
  let startX=0, deltaX=0, dragging=false;
  cardFrame.addEventListener("touchstart", e=>{ startX=e.touches[0].clientX; dragging=true; });
  cardFrame.addEventListener("touchmove", e=>{
    if(!dragging) return;
    deltaX = e.touches[0].clientX - startX;
    if(deltaX>50) showIndicator("like");
    else if(deltaX<-50) showIndicator("pass");
    else showIndicator(null);
  });
  cardFrame.addEventListener("touchend", ()=>{
    if(!dragging) return;
    if(Math.abs(deltaX)>100) nextProfile();
    showIndicator(null); dragging=false; deltaX=0;
  });
  passBtn.addEventListener("click", nextProfile);
  likeBtn.addEventListener("click", nextProfile);

  /* ---- Modal controls ---- */
  editBtn.addEventListener("click", ()=>{ uploadStatus.textContent=""; clearInvalids(); editModal.style.display="flex"; refreshSaveButtonState(myDocCached); });
  cancelEdit.addEventListener("click", ()=>{ editModal.style.display="none"; clearPreviews(); clearInvalids(); });

  /* ---- Create user doc if missing ---- */
  async function loadOrCreateUserDoc(uid, userObj){
    const uref = doc(db,"users",uid);
    const snap = await getDoc(uref);
    if(!snap.exists()){
      const seed = {
        uid, displayName:userObj.displayName||"Member", username:"",
        photoURL:userObj.photoURL||"", photos: userObj.photoURL ? [userObj.photoURL] : [],
        bio:"", age:null, location:"", badges:[], flags:[],
        quiz: { completed:false }, // gate by default
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      };
      await setDoc(uref, seed);
      return seed;
    }
    return snap.data();
  }

  /* ---- Save edits + upload photos ---- */
  saveEdit.addEventListener("click", async ()=>{
    if(!me) return;
    saveEdit.disabled = true;
    uploadStatus.innerHTML = `<span class="prog">Saving…</span>`;
    clearInvalids();
    try{
      const uref = doc(db,"users",me.uid);
      const preSnap = await getDoc(uref);
      const currentDoc = preSnap.data() || {};

      // Enforce requirements BEFORE any upload
      const filesPending = Array.from(avatarInput.files || []);
      const check = validateBeforeSave(currentDoc, filesPending);
      if (!check.ok) {
        showError(check.message);
        if (check.focus==="photo") { document.getElementById("avatar").scrollIntoView({behavior:"smooth",block:"center"}); }
        if (check.focus==="location") firstInvalidFocus(locationInput);
        if (check.focus==="displayName") firstInvalidFocus(displayNameInput);
        if (check.focus==="age") firstInvalidFocus(ageInput);
        saveEdit.disabled = false;
        return;
      }

      let photos = Array.isArray(currentDoc.photos) ? [...currentDoc.photos] : [];

      // Upload pending files
      if(filesPending.length){
        uploadStatus.innerHTML = `<span class="prog">Uploading ${filesPending.length} photo(s)…</span>`;
      }
      for (const f of filesPending){
        const path = `avatars/${me.uid}/${Date.now()}_${f.name}`;
        const r = sRef(storage, path);
        await uploadBytes(r, f);
        const url = await getDownloadURL(r);
        photos.push(url);
      }

      // Ensure primary
      let photoURL = currentDoc.photoURL || photos[0] || "";
      if(!currentDoc.photoURL && photos[0]){
        await updateProfile(me,{ photoURL: photos[0] });
        photoURL = photos[0];
      }

      const payload = {
        displayName: displayNameInput.value.trim(),
        username: usernameInput.value.trim(),
        bio: bioInput.value.trim(),
        age: ageInput.value ? Number(ageInput.value) : null,
        location: locationInput.value.trim(),
        photoURL, photos,
        updatedAt: serverTimestamp()
      };
      await setDoc(uref, payload, { merge:true });
      myDocCached = { ...(myDocCached||{}), ...payload };

      // Update top & handle instantly
      topLine.textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
      handleEl.textContent = myDocCached.username ? `@${myDocCached.username}` : "";

      renderGallery(photos);
      if(!matches.length) renderProfile(myDocCached);

      avatarInput.value = "";
      clearPreviews();

      showOK("Profile saved.");
      setTimeout(()=>{ editModal.style.display="none"; }, 500);
    }catch(err){
      console.error(err);
      showError(`Save failed: ${err?.message||'error'}`);
    }finally{
      saveEdit.disabled = false;
    }
  });

  /* ---- QUIZ GATE ---- */
  function readQuizAnswers(){
    const get = (name)=> (document.querySelector(`input[name="${name}"]:checked`)?.value || "");
    return { q1:get("q1"), q2:get("q2"), q3:get("q3") };
  }
  function quizValid(ans){ return ans.q1 && ans.q2 && ans.q3; }

  quizSubmit.addEventListener("click", async ()=>{
    if(!me) return;
    const ans = readQuizAnswers();
    if(!quizValid(ans)){
      quizStatus.innerHTML = `<span class="err">Please answer all questions.</span>`;
      return;
    }
    try{
      quizStatus.innerHTML = `<span class="prog">Saving quiz…</span>`;
      const uref = doc(db,"users",me.uid);
      await setDoc(uref, { quiz:{ completed:true, answers:ans, completedAt:serverTimestamp() } }, { merge:true });
      // Optionally: derive starter flags later from answers
      quizGate.style.display = "none";
      mainContent.style.visibility = "visible";
    }catch(err){
      console.error(err);
      quizStatus.innerHTML = `<span class="err">Could not save quiz: ${err?.message||'error'}</span>`;
    }
  });

  /* ---- Init ---- */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.replace("./login.html"); return; }
    me = user;
    document.getElementById("myProfileBtn").onclick = ()=> location.replace(`./profile.html?uid=${encodeURIComponent(me.uid)}`);

    // Ensure doc & prefill
    myDocCached = await loadOrCreateUserDoc(me.uid, me);
    displayNameInput.value = myDocCached.displayName || "";
    usernameInput.value = myDocCached.username || "";
    bioInput.value = myDocCached.bio || "";
    ageInput.value = myDocCached.age || "";
    locationInput.value = myDocCached.location || "";
    renderGallery(myDocCached.photos || []);
    topLine.textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
    uidLine.textContent = topLine.textContent;

    // Quiz gate: block everything until quiz is completed
    const isQuizDone = !!myDocCached?.quiz?.completed;
    if (!isQuizDone) {
      quizGate.style.display = "flex";
      mainContent.style.visibility = "hidden";
    } else {
      quizGate.style.display = "none";
      mainContent.style.visibility = "visible";
    }

    // Load others; fallback to self
    const snap = await getDocs(collection(db,"users"));
    matches = [];
    snap.forEach(d => { if(d.id !== me.uid) matches.push(d.data()); });
    if(!matches.length) matches.push(myDocCached);

    currentIndex = 0;
    renderProfile(matches[currentIndex]);

    // Prime validation state now that we have doc
    refreshSaveButtonState(myDocCached);
  });
</script>

</body>
</html>
