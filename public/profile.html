<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Unhinged - Profile</title>

    <style>
      :root {
        --bg: #0e0e12;
        --panel: #15161b;
        --muted: #cfd0de;
        --red: #e11d2a;
        --green: #4caf50;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Buttons */
      .btn {
        border: none;
        background: var(--red);
        color: #fff;
        padding: 0.5rem 0.9rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      /* Lighten the secondary buttons for better contrast */
      .btn.secondary {
        background: #3a3a3a;
        color: #fff;
      }
      /* Lighten ghost button border for contrast */
      .btn.ghost {
        background: transparent;
        border: 1px solid #444;
      }
      .btn.pill {
        border-radius: 16px;
        padding: 0.55rem 1rem;
      }
      .btn.small {
        padding: 0.35rem 0.7rem;
        font-size: 0.9rem;
      }
      .chaos-btn {
        background: var(--red);
        color: #fff;
        border: none;
        border-radius: 16px;
        padding: 8px 16px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Text helpers */
      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* ===== SECTION: Top Bar ===== */
      .topbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--panel);
        border-bottom: 1px solid #2a2a2a;
      }
      .brand {
        font-weight: 700;
      }
      .nav-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      /* ===== SECTION: Content Wrapper ===== */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        gap: 12px;
        width: 100%;
      }

      /* ===== SECTION: Swipe Card ===== */
      .card-frame {
        position: relative;
        width: 92%;
        max-width: 420px;
        height: 72vh;
        border: 2px solid #2a2a2a;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        touch-action: pan-y;
      }
      .main-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        user-select: none;
        -webkit-user-drag: none;
        cursor: pointer;
      }
      .info-overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 14px 16px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.78));
        pointer-events: none;
      }
      .info-overlay h2 {
        margin: 0;
        font-size: 1.4rem;
      }
      .handle {
        font-size: 0.95rem;
        color: #cfd0de;
        margin-top: 2px;
      }
      .sub {
        font-size: 0.9rem;
        color: #ddd;
        margin-top: 2px;
      }
      .badges,
      .flags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }
      .badges img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #4cafef;
        background: #2a2a3a;
        padding: 2px;
      }
      .flags .flag-pill {
        font-size: 0.75rem;
        border: 1px solid #3a3b44;
        border-radius: 999px;
        padding: 2px 8px;
        background: #14151a;
      }
      .indicator {
        position: absolute;
        top: 16px;
        font-size: 1.4rem;
        font-weight: 700;
        padding: 6px 12px;
        border: 3px solid;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.12s ease;
      }
      .indicator.pass {
        left: 14px;
        color: var(--red);
        border-color: var(--red);
        transform: rotate(-18deg);
      }
      .indicator.like {
        right: 14px;
        color: var(--green);
        border-color: var(--green);
        transform: rotate(18deg);
      }
      .empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ddd;
        font-size: 1.1rem;
      }

      /* ===== SECTION: Bottom Actions ===== */
      .actions {
        width: 100%;
        max-width: 480px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0 16px;
        position: relative;
        z-index: 20;
      }
      .action-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pass-btn {
        background: #2a2a2a;
        color: var(--red);
      }
      .like-btn {
        background: #2a2a2a;
        color: var(--green);
      }

      /* ===== SECTION: Modal Base ===== */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 60;
      }
      .modal {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 1rem;
      }
      /* Scroll fix: allow modal to scroll */
      #editModal .modal {
        max-height: 90vh;
        overflow-y: auto;
      }
      label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0.5rem 0 0.25rem;
      }
      .req {
        color: #ff6b6b;
        font-weight: 700;
      }
      input[type='text'],
      textarea,
      input[type='number'],
      select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        background: #12131a;
        color: #fff;
      }
      .row {
        display: flex;
        gap: 0.5rem;
      }
      .row > * {
        flex: 1;
      }
      .status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
      .ok {
        color: #6fdc8c;
      }
      .err {
        color: #ff8e8e;
      }
      .prog {
        color: #ffd27f;
      }
      .invalid {
        outline: 2px solid #ff6b6b;
        outline-offset: 2px;
        border-color: #ff6b6b !important;
      }

      /* Gallery */
      .gallery {
        margin-top: 0.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
        gap: 8px;
      }
      .thumb {
        position: relative;
        width: 100%;
        padding-top: 100%;
        border: 2px solid #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        background: #0b0b0f;
        cursor: pointer;
      }
      .thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .label-pill {
        position: absolute;
        left: 6px;
        top: 6px;
        font-size: 0.7rem;
        background: #000000aa;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid #2a2a2a;
      }
      .thumb.primary {
        border-color: var(--red);
      }
      .hint {
        font-size: 0.85rem;
        color: #cfd0de;
        margin-top: 0.25rem;
      }

      /* ===== INBOX / GATING ===== */
      .inbox-btn {
        background: #2a2a2a;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.5rem 0.8rem;
        cursor: pointer;
      }
      .inbox-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 80;
      }
      .inbox-card {
        width: 100%;
        max-width: 900px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 12px;
      }
      .inbox-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      /* Lighten the inbox tab colours for readability */
      .inbox-tab {
        border: 1px solid #444;
        background: #3a3a3a;
        border-radius: 999px;
        padding: 0.45rem 0.8rem;
        cursor: pointer;
        color: #fff;
      }
      .inbox-tab.active {
        border-color: var(--red);
        background: #4a4a4a;
        box-shadow: 0 0 0 2px #e11d2a33 inset;
      }
      .inbox-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 10px;
        min-height: 160px;
      }
      .inbox-item {
        position: relative;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        overflow: hidden;
        background: #111;
      }
      .inbox-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
      }
      .inbox-meta {
        padding: 8px;
      }
      .inbox-name {
        font-weight: 700;
      }
      .inbox-sub {
        font-size: 0.9rem;
        color: #cfd0de;
      }
      .locked .blur {
        filter: blur(6px);
      }
      .lock-badge {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(#0000, #0008);
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.3px;
        text-align: center;
        padding: 8px;
      }
      .lock-msg {
        background: #e11d2a;
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        cursor: pointer;
        margin-top: 0.5rem;
      }

      /* ===== CHAT MODAL ===== */
      .chat-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 90;
      }
      .chat-card {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        height: 75vh;
      }
      .chat-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #2a2a2a;
      }
      .chat-scroll {
        flex: 1;
        overflow: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .bubble {
        max-width: 70%;
        padding: 8px 10px;
        border-radius: 12px;
      }
      .bubble.me {
        align-self: flex-end;
        background: #e11d2a;
        color: #fff;
      }
      .bubble.them {
        align-self: flex-start;
        background: #2a2a2a;
      }
      .chat-send {
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #2a2a2a;
      }
      .chat-send input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        background: #12131a;
        border: 1px solid #2a2a2a;
        color: #fff;
      }

      /* ===== FIX: Disable clicks on gated actions ===== */
      [data-gated] .nav-actions .btn:not(#editBtn),
      [data-gated] .nav-actions .chaos-btn,
      [data-gated] .content .actions .action-btn,
      [data-gated] .content .actions .chaos-btn {
        pointer-events: none;
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="topbar" data-gated="true">
      <div class="brand" id="topLine">Your Profile</div>
      <div class="nav-actions">
        <button class="btn secondary" id="filterBtn" type="button" onclick="document.getElementById('filterModal').style.display='flex'">Filter</button>
        <button class="btn secondary inbox-btn" id="inboxBtn" type="button" onclick="document.getElementById('inboxModal').style.display='flex'">Inbox</button>
        <button class="btn danger" id="browseBtn" type="button">Browse Matches</button>
        <button class="btn secondary" id="casualtiesBtn" type="button">Casualties Upload</button>
        <a class="chaos-btn" href="./app.html">Community Chaos</a>
        <button class="btn secondary" id="myProfileBtn" type="button">My Profile</button>
        <button class="btn secondary" id="upgradeBtn" type="button">Go Paid</button>
        <button class="btn" id="editBtn" type="button" onclick="document.getElementById('editModal').style.display='flex'">Edit Profile</button>
        <button class="btn secondary" id="logoutBtn" type="button">Logout</button>
        <button class="btn ghost" id="deleteBtn" type="button" title="Delete my account">Delete</button>
      </div>
    </div>

    <div class="modal-backdrop" id="casualtiesModal">
      <div class="modal">
        <h3>Casualties of Modern Dating</h3>
        <div id="casualtiesPwdSection">
          <label for="casualtiesPassword">Enter password:</label>
          <input id="casualtiesPassword" type="password" />
          <button class="btn" id="casualtiesCheckBtn" type="button">Check</button>
        </div>
        <div id="casualtiesUploadSection" style="display: none;">
          <label for="casualtiesFile">Upload image:</label>
          <input id="casualtiesFile" type="file" accept="image/*" />
          <label for="casualtiesCaption">Caption (optional):</label>
          <input id="casualtiesCaption" type="text" placeholder="Caption" />
          <button class="btn" id="casualtiesSubmit" type="button">Upload</button>
        </div>
        <button class="btn secondary" id="closeCasualties" type="button">Close</button>
      </div>
    </div>

    <div class="content">
      <div class="card-frame" id="cardFrame">
        <img class="main-photo" id="main-photo" src="" alt="Profile Photo" />
        <div class="info-overlay">
          <h2 id="name"></h2>
          <div class="handle" id="handle"></div>
          <div class="sub" id="sub-info"></div>
          <div class="badges" id="badges"></div>
          <div class="flags" id="flags"></div>
        </div>
        <div class="indicator pass" id="pass-indicator">PASS</div>
        <div class="indicator like" id="like-indicator">LIKE</div>
        <div class="empty" id="empty" style="display: none;">No more matches</div>
      </div>

      <div class="actions">
        <button class="action-btn pass-btn" id="pass-btn" aria-label="Pass">Pass</button>
        <button class="chaos-btn" onclick="location.href='./app.html'">Community Chaos</button>
        <button class="action-btn like-btn" id="like-btn" aria-label="Like">Like</button>
      </div>
    </div>

    <div class="modal-backdrop" id="editModal">
      <div class="modal">
        <h3>Edit Profile</h3>
        <div class="muted" id="uidLine"></div>
        <div class="row">
          <div>
            <label for="displayName">Display name <span class="req" id="reqDisplayName" hidden>*</span></label>
            <input id="displayName" type="text" />
          </div>
          <div>
            <label for="username">Username</label>
            <input id="username" type="text" placeholder="yourhandle" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="age">Age <span class="req" id="reqAge" hidden>*</span></label>
            <input id="age" type="number" min="18" max="100" />
          </div>
          <div>
            <label for="location">Location <span class="req" id="reqLocation" hidden>*</span></label>
            <input id="location" type="text" placeholder="City, State" />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="">Prefer not to say</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label for="hobbies">Hobbies</label>
            <input id="hobbies" type="text" placeholder="e.g., hiking, gaming" />
          </div>
          <div>
            <label for="interests">Interests</label>
            <input id="interests" type="text" placeholder="e.g., live music, travel" />
          </div>
        </div>
        <label for="bio">Bio</label>
        <textarea id="bio" rows="3" placeholder="Say something..."></textarea>
        <label for="avatar" style="margin-top: 0.5rem;">Add photos (you can select multiple) <span class="req" id="reqPhoto" hidden>*</span></label>
        <input id="avatar" type="file" accept="image/*" multiple />
        <div class="hint">Click a saved photo below to set it as your <b>Primary</b>. Selected files preview below before upload.</div>
        <div class="status" id="uploadStatus"></div>
        <div class="muted" style="margin-top: 0.5rem;" id="previewTitle" hidden>Selected (not yet uploaded)</div>
        <div class="gallery" id="previewGallery" hidden></div>
        <div class="muted" style="margin-top: 0.75rem;">Saved Photos</div>
        <div class="gallery" id="gallery"></div>
        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn secondary" id="cancelEdit" type="button" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
          <button class="btn" id="saveEdit" type="button">Save</button>
        </div>
      </div>
    </div>

    <div class="inbox-modal" id="inboxModal">
      <div class="inbox-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h3 style="margin: 0">Inbox</h3>
          <button class="btn secondary" id="closeInbox" type="button" onclick="document.getElementById('inboxModal').style.display='none'">Close</button>
        </div>
        <div class="inbox-tabs" id="inboxTabs">
          <button class="inbox-tab active" data-tab="likes">Likes</button>
          <button class="inbox-tab" data-tab="views">Views</button>
          <button class="inbox-tab" data-tab="matches">Matches</button>
          <button class="inbox-tab" data-tab="messages">Messages</button>
        </div>
        <div class="inbox-list" id="inboxList"></div>
      </div>
    </div>

    <div class="chat-modal" id="chatModal">
      <div class="chat-card">
        <div class="chat-head">
          <div id="chatTitle">Chat</div>
          <button class="btn secondary" id="closeChat" type="button" onclick="document.getElementById('chatModal').style.display='none'">Close</button>
        </div>
        <div class="chat-scroll" id="chatScroll"></div>
        <div class="chat-send">
          <input id="chatInput" type="text" placeholder="Type a message..." />
          <button class="btn" id="chatSend" type="button">Send</button>
        </div>
      </div>
    </div>

    <div class="modal-backdrop" id="filterModal">
      <div class="modal">
        <h3>Filters</h3>
        <label for="filterLocation">Location</label>
        <input id="filterLocation" type="text" placeholder="City, State" />
        <label>Age Range</label>
        <div class="row">
          <input id="filterAgeMin" type="number" min="18" max="99" placeholder="Min" />
          <input id="filterAgeMax" type="number" min="18" max="99" placeholder="Max" />
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn secondary" id="cancelFilter" type="button" onclick="document.getElementById('filterModal').style.display='none'">Cancel</button>
          <button class="btn" id="applyFilter" type="button">Apply</button>
        </div>
      </div>
    </div>

    <script type="module">
      /* ===== SECTION: Imports ===== */
      import { auth, db, storage } from "./js/firebase.js";
      import {
        onAuthStateChanged,
        updateProfile,
        signOut,
        EmailAuthProvider,
        reauthenticateWithCredential,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
        orderBy,
        limit,
        addDoc,
        onSnapshot,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        ref as sRef,
        uploadBytes,
        getDownloadURL,
        listAll,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // ===== Global error traps so we can see what's blocking button wiring =====
      window.addEventListener("error", (e) => {
        console.error("Script error", e);
      });
      window.addEventListener("unhandledrejection", (e) => {
        console.error("Unhandled rejection", e);
      });

      /* ===== SECTION: Config (Requirements & Membership) ===== */
      const REQUIRED = { PHOTO: true, LOCATION: true, DISPLAY_NAME: true, AGE: true };
      const MEMBERSHIP = { requiredForViews: false, requiredForLikes: false };

      /* ===== SECTION: Public Profile Modal ===== */
      function showPublicProfile(user) {
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.inset = "0";
        modal.style.background = "rgba(0,0,0,0.65)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "100";

        const card = document.createElement("div");
        card.style.background = "var(--panel)";
        card.style.color = "#fff";
        card.style.padding = "1rem";
        card.style.borderRadius = "10px";
        card.style.maxWidth = "400px";
        card.style.textAlign = "left";

        const name = user.displayName || "Member";
        const username = user.username ? `@${user.username}` : "";
        const ageText = typeof user.age === "number" ? `${user.age} years old` : "";
        const location = user.location || "";

        const photosList = Array.isArray(user.photos) ? user.photos.slice() : [];
        const fallbackPrimary = safePrimaryPhoto(user) || photosList[0] || NEUTRAL_PHOTO;
        if (photosList.length === 0 || photosList[0] !== fallbackPrimary) photosList.unshift(fallbackPrimary);
        let currentPhotoIndex = 0;

        let photoHtml = `<div style="display:flex;align-items:center;gap:6px;margin-bottom:.75rem;">
          <button id="photoPrev" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">&lt;</button>
          <img id="modalPrimaryPhoto" src="${photosList[0]}" style="flex:1;max-height:360px;object-fit:cover;border-radius:8px;" alt="Profile photo">
          <button id="photoNext" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">&gt;</button>
        </div>`;
        if (photosList.length > 1) {
          photoHtml += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:.75rem">`;
          for (let i = 0; i < photosList.length; i++) {
            const url = photosList[i];
            const border = i === 0 ? '2px solid var(--red)' : '2px solid transparent';
            photoHtml += `<img class="modal-photo-thumb" data-index="${i}" src="${encodeURI(url)}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:${border};cursor:pointer;" alt="Photo ${i + 1}">`;
          }
          photoHtml += `</div>`;
        }

        card.innerHTML = `
          ${photoHtml}
          <h2 style="margin-top:0;margin-bottom:0">${name}</h2>
          ${username ? `<div style="font-size:.9rem;color:var(--muted);margin-bottom:.25rem">${username}</div>` : ""}
          ${ageText || location ? `<div style="font-size:.9rem;color:var(--muted);margin-bottom:.25rem">${[ageText, location].filter(Boolean).join(' • ')}</div>` : ""}
          <div style="text-align:center;margin-top:.5rem"><button class="btn small secondary" id="closeMinimalProfile">Close</button></div>
        `;
        modal.appendChild(card);
        document.body.appendChild(modal);

        modal.querySelector("#closeMinimalProfile").addEventListener("click", () => document.body.removeChild(modal));
        modal.addEventListener("click", (ev) => {
          if (ev.target === modal) document.body.removeChild(modal);
        });

        try {
          const modalPrimary = modal.querySelector('#modalPrimaryPhoto');
          const thumbElems = modal.querySelectorAll('.modal-photo-thumb');
          const highlight = (index) => {
            thumbElems.forEach((t) => (t.style.border = '2px solid transparent'));
            const currentThumb = modal.querySelector(`.modal-photo-thumb[data-index="${index}"]`);
            if (currentThumb) currentThumb.style.border = '2px solid var(--red)';
          };
          thumbElems.forEach((imgThumb) => {
            imgThumb.addEventListener('click', () => {
              const idx = Number(imgThumb.dataset.index);
              if (!Number.isNaN(idx)) {
                currentPhotoIndex = idx;
                modalPrimary.src = photosList[idx];
                highlight(idx);
              }
            });
          });
          modal.querySelector('#photoPrev').addEventListener('click', () => {
            if (photosList.length < 2) return;
            currentPhotoIndex = (currentPhotoIndex - 1 + photosList.length) % photosList.length;
            modalPrimary.src = photosList[currentPhotoIndex];
            highlight(currentPhotoIndex);
          });
          modal.querySelector('#photoNext').addEventListener('click', () => {
            if (photosList.length < 2) return;
            currentPhotoIndex = (currentPhotoIndex + 1) % photosList.length;
            modalPrimary.src = photosList[currentPhotoIndex];
            highlight(currentPhotoIndex);
          });
        } catch (err) {
          console.error(err);
        }
      }

      /* ===== SECTION: DOM Refs ===== */
      const topLine = document.getElementById('topLine');
      const myProfileBtn = document.getElementById('myProfileBtn');
      const editBtn = document.getElementById('editBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const upgradeBtn = document.getElementById('upgradeBtn');
      const inboxBtn = document.getElementById('inboxBtn');
      const deleteBtn = document.getElementById('deleteBtn');
      const filterBtn = document.getElementById('filterBtn');

      const cardFrame = document.getElementById('cardFrame');
      const mainPhoto = document.getElementById('main-photo');
      if (mainPhoto) {
        const _neutral =
          'data:image/svg+xml;utf8,' +
          encodeURIComponent(
            "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'><rect width='100%' height='100%' fill='#0b0b0f'/><circle cx='400' cy='420' r='160' fill='#20222b'/><rect x='210' y='650' width='380' height='260' rx='28' fill='#20222b'/></svg>"
          );
        mainPhoto.addEventListener(
          'error',
          () => {
            mainPhoto.src = _neutral;
          },
          { once: true }
        );
      }
      const nameEl = document.getElementById('name');
      const handleEl = document.getElementById('handle');
      const subInfo = document.getElementById('sub-info');
      const badgesEl = document.getElementById('badges');
      const flagsEl = document.getElementById('flags');
      const passBtn = document.getElementById('pass-btn');
      const likeBtn = document.getElementById('like-btn');
      const passIndicator = document.getElementById('pass-indicator');
      const likeIndicator = document.getElementById('like-indicator');
      const emptyEl = document.getElementById('empty');

      const editModal = document.getElementById('editModal');
      const saveEdit = document.getElementById('saveEdit');
      const cancelEdit = document.getElementById('cancelEdit');
      const uidLine = document.getElementById('uidLine');
      const displayNameInput = document.getElementById('displayName');
      const usernameInput = document.getElementById('username');
      const ageInput = document.getElementById('age');
      const locationInput = document.getElementById('location');
      const genderInput = document.getElementById('gender');
      const hobbiesInput = document.getElementById('hobbies');
      const interestsInput = document.getElementById('interests');
      const bioInput = document.getElementById('bio');
      const avatarInput = document.getElementById('avatar');
      const uploadStatus = document.getElementById('uploadStatus');
      const galleryEl = document.getElementById('gallery');
      const previewTitle = document.getElementById('previewTitle');
      const previewGallery = document.getElementById('previewGallery');
      const reqDisplayName = document.getElementById('reqDisplayName');
      const reqAge = document.getElementById('reqAge');
      const reqLocation = document.getElementById('reqLocation');
      const reqPhoto = document.getElementById('reqPhoto');

      const inboxModal = document.getElementById('inboxModal');
      const closeInbox = document.getElementById('closeInbox');
      const inboxTabs = document.getElementById('inboxTabs');
      const inboxList = document.getElementById('inboxList');

      const chatModal = document.getElementById('chatModal');
      const closeChat = document.getElementById('closeChat');
      const chatTitle = document.getElementById('chatTitle');
      const chatScroll = document.getElementById('chatScroll');
      const chatInput = document.getElementById('chatInput');
      const chatSend = document.getElementById('chatSend');

      const filterModal = document.getElementById('filterModal');
      const cancelFilter = document.getElementById('cancelFilter');
      const applyFilter = document.getElementById('applyFilter');
      const filterLocEl = document.getElementById('filterLocation');
      const filterAgeMin = document.getElementById('filterAgeMin');
      const filterAgeMax = document.getElementById('filterAgeMax');

      const casualtiesBtn = document.getElementById('casualtiesBtn');
      const casualtiesModal = document.getElementById('casualtiesModal');
      const casualtiesPassword = document.getElementById('casualtiesPassword');
      const casualtiesCheckBtn = document.getElementById('casualtiesCheckBtn');
      const casualtiesUploadSection = document.getElementById('casualtiesUploadSection');
      const casualtiesFile = document.getElementById('casualtiesFile');
      const casualtiesCaption = document.getElementById('casualtiesCaption');
      const casualtiesSubmit = document.getElementById('casualtiesSubmit');
      const closeCasualties = document.getElementById('closeCasualties');
      const casualtiesPwdSection = document.getElementById('casualtiesPwdSection');

      /* ===== SECTION: State ===== */
      let me = null;
      let myDocCached = null;
      let allUsers = [];
      let matches = [];
      let currentIndex = 0;
      let previewURLs = [];
      let _profileNavGuard = false;
      let activeChat = { chatId: null, partner: null, unsub: null };
      let currentFilters = { location: '', min: null, max: null };
      // Track viewed profiles in current session to avoid duplicate view writes
      let recordedViews = new Set();

      // ===== Added: track profile completeness =====
      let profileComplete = false;

      // ===== Added: Helper to determine if profile is complete =====
      function checkProfileComplete(doc) {
        try {
          const res = validateBeforeSave(doc || myDocCached || {}, []);
          return res.ok;
        } catch (e) {
          console.error(e);
          return false;
        }
      }

      // ===== Added: Enforce gating based on profile completeness =====
      function enforceProfileGate() {
        try {
          profileComplete = checkProfileComplete(myDocCached);
          const gatedEl = document.querySelector('[data-gated]');
          if (!profileComplete) {
            if (gatedEl) gatedEl.setAttribute('data-gated', 'true');
            if (uploadStatus) {
              uploadStatus.innerHTML =
                "<span class='prog'>Please complete your profile before browsing.</span>";
            }
          } else {
            if (gatedEl) gatedEl.setAttribute('data-gated', 'false');
          }
        } catch (e) {
          console.error('enforceProfileGate error:', e);
        }
      }

      /* ===== SECTION: Browse Matches wiring ===== */
      (function () {
        const browseBtn = document.getElementById('browseBtn');
        if (!browseBtn) return;
        browseBtn.addEventListener('click', async () => {
          // ===== Added: gating check for profile completeness =====
          if (!profileComplete) {
            alert('Please complete your profile before browsing.');
            openEdit();
            return;
          }
          try {
            if (!me || !myDocCached) return;
            const list = await getMatchesForMe(me.uid);
            matches = Array.isArray(list) && list.length ? list : [myDocCached];
            currentIndex = 0;
            renderProfile(matches[currentIndex] || null);
            // open the inbox on matches tab so the user can see their matches list
            await renderInbox('matches');
          } catch (err) {
            console.error('Browse Matches handler failed:', err);
          }
        });
      })();

      /* ===== SECTION: View Params ===== */
      const _params = new URLSearchParams(location.search);
      const viewUidParam = _params.get('uid');

      /* Neutral placeholder */
      const NEUTRAL_PHOTO =
        'data:image/svg+xml;utf8,' +
        encodeURIComponent(
          `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 800 1200'><rect width='100%' height='100%' fill='#0b0b0f'/><circle cx='400' cy='420' r='160' fill='#20222b'/><rect x='210' y='650' width='380' height='260' rx='28' fill='#20222b'/></svg>`
        );

      /* ===== SECTION: Required Markers ===== */
      reqDisplayName.hidden = !REQUIRED.DISPLAY_NAME;
      reqAge.hidden = !REQUIRED.AGE;
      reqLocation.hidden = !REQUIRED.LOCATION;
      reqPhoto.hidden = !REQUIRED.PHOTO;

      /* ===== SECTION: Helper – UI Feedback ===== */
      function showError(msg) {
        uploadStatus.innerHTML = `<span class="err">${msg}</span>`;
      }
      function showOK(msg) {
        uploadStatus.innerHTML = `<span class="ok">${msg}</span>`;
      }

      /* ===== SECTION: Helper – Renderers ===== */
      function isMember(userDoc) {
        return (userDoc?.membership?.tier || 'free') !== 'free';
      }
      function safePrimaryPhoto(p) {
        const cand = p?.photoURL || (Array.isArray(p?.photos) && p.photos[0]) || '';
        if (typeof cand !== 'string') return '';
        if (/^https?:\/\//i.test(cand)) return cand;
        if (cand.startsWith('data:image/')) return cand;
        return '';
      }
      function renderBadges(badges = []) {
        badgesEl.innerHTML = '';
        (badges || []).forEach((url) => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = 'badge';
          badgesEl.appendChild(img);
        });
      }
      function renderFlagsList(flags = []) {
        flagsEl.innerHTML = '';
        const list = Array.isArray(flags) ? flags : [];
        list.forEach((code) => {
          const pill = document.createElement('span');
          pill.className = 'flag-pill';
          pill.textContent = flagLabel(code);
          flagsEl.appendChild(pill);
        });
      }
      function flagLabel(code) {
        const map = {
          anger_control: 'Anger',
          controlling_behavior: 'Control',
          financial_instability: 'Financial',
          substance_risk: 'Substance',
          accountability_low: 'Accountability',
          harassment_persistence: 'Persistence',
          attention_fail: 'Attention',
          inconsistency: 'Inconsistent',
        };
        return map[code] || code;
      }

      // ===== New helper: record a view in Firestore =====
      async function recordView(viewedUid) {
        try {
          if (!me || !viewedUid || viewedUid === me.uid) return;
          if (recordedViews.has(viewedUid)) return;
          recordedViews.add(viewedUid);
          await addDoc(collection(db, 'views'), {
            viewerUid: me.uid,
            viewedUid,
            createdAt: serverTimestamp(),
          });
        } catch (e) {
          console.error('recordView failed:', e);
        }
      }

      // ===== New helper: record a like and create match if reciprocal =====
      async function recordLike(likedUid) {
        try {
          if (!me || !likedUid || likedUid === me.uid) return;
          await addDoc(collection(db, 'likes'), {
            fromUid: me.uid,
            toUid: likedUid,
            createdAt: serverTimestamp(),
          });
          // check reciprocal like
          const recip = await getDocs(
            query(
              collection(db, 'likes'),
              where('fromUid', '==', likedUid),
              where('toUid', '==', me.uid)
            )
          );
          let otherLiked = false;
          recip.forEach(() => {
            otherLiked = true;
          });
          if (otherLiked) {
            // check if match already exists
            let exists = false;
            const mine = await getDocs(
              query(collection(db, 'matches'), where('uids', 'array-contains', me.uid))
            );
            mine.forEach((d) => {
              const arr = d.data().uids || [];
              if (arr.includes(likedUid)) exists = true;
            });
            if (!exists) {
              await addDoc(collection(db, 'matches'), {
                uids: [me.uid, likedUid],
                createdAt: serverTimestamp(),
              });
            }
          }
        } catch (e) {
          console.error('recordLike failed:', e);
        }
      }

      function renderProfile(p) {
        if (!p) {
          mainPhoto.src = NEUTRAL_PHOTO;
          nameEl.textContent = '';
          handleEl.textContent = '';
          subInfo.textContent = '';
          renderBadges([]);
          renderFlagsList([]);
          emptyEl.style.display = 'flex';
          return;
        }
        emptyEl.style.display = 'none';
        const primary = safePrimaryPhoto(p) || NEUTRAL_PHOTO;
        mainPhoto.src = primary;
        const name = p.displayName || 'Member';
        const age = typeof p.age === 'number' && p.age >= 0 ? `, ${p.age}` : '';
        nameEl.textContent = `${name}${age}`;
        handleEl.textContent = p.username ? `@${p.username}` : '';
        const hobbyRaw = (p.hobbies || '').trim();
        const interestRaw = (p.interests || '').trim();
        const hobbyHint = hobbyRaw ? ` • ${hobbyRaw.slice(0, 20)}${hobbyRaw.length > 20 ? '...' : ''}` : '';
        const interestHint = interestRaw ? ` • ${interestRaw.slice(0, 20)}${interestRaw.length > 20 ? '...' : ''}` : '';
        subInfo.textContent = (p.location || '') + hobbyHint + interestHint;
        renderBadges(p.badges || []);
        const flags = Array.isArray(p.flags) ? p.flags : Array.isArray(p.quiz?.flags) ? p.quiz.flags.map((f) => f.code) : [];
        renderFlagsList(flags);

        // record view now
        if (p.uid) recordView(p.uid);
      }

      function renderGallery(photos = []) {
        galleryEl.innerHTML = '';
        (photos || []).forEach((url, i) => {
          const box = document.createElement('div');
          box.className = 'thumb' + (i === 0 ? ' primary' : '');
          const img = document.createElement('img');
          img.src = url;
          const lbl = document.createElement('div');
          lbl.className = 'label-pill';
          lbl.textContent = i === 0 ? 'Primary' : `Photo ${i + 1}`;
          box.appendChild(img);
          box.appendChild(lbl);
          box.addEventListener('click', async () => {
            try {
              if (!me) return;
              const uref = doc(db, 'users', me.uid);
              const snap = await getDoc(uref);
              const current = snap.data() || {};
              let photosNow = Array.isArray(current.photos) ? [...current.photos] : [];
              const idx = photosNow.indexOf(url);
              if (idx > 0) {
                photosNow.splice(idx, 1);
                photosNow.unshift(url);
              }
              await updateProfile(me, { photoURL: url });
              await setDoc(
                uref,
                { photoURL: url, photos: photosNow, updatedAt: serverTimestamp() },
                { merge: true }
              );
              myDocCached = { ...(myDocCached || {}), photoURL: url, photos: photosNow };
              renderGallery(photosNow);
              if (!matches.length) renderProfile(myDocCached);
              showOK('Primary photo updated.');
            } catch (e) {
              showError(`Could not set primary: ${e?.message || 'error'}`);
            }
          });
          galleryEl.appendChild(box);
        });
      }
      function clearPreviews() {
        previewURLs.forEach((u) => URL.revokeObjectURL(u));
        previewURLs = [];
        previewGallery.innerHTML = '';
        previewTitle.hidden = true;
        previewGallery.hidden = true;
      }
      function renderPreviews(files) {
        clearPreviews();
        if (!files?.length) return;
        previewTitle.hidden = false;
        previewGallery.hidden = false;
        [...files].forEach((f, i) => {
          const url = URL.createObjectURL(f);
          previewURLs.push(url);
          const box = document.createElement('div');
          box.className = 'thumb';
          const img = document.createElement('img');
          img.src = url;
          const lbl = document.createElement('div');
          lbl.className = 'label-pill';
          lbl.textContent = `New ${i + 1}`;
          box.appendChild(img);
          box.appendChild(lbl);
          previewGallery.appendChild(box);
        });
      }

      /* ===== SECTION: Validation ===== */
      function validateBeforeSave(currentDoc, filesPending) {
        const pending = (filesPending && filesPending.length) || 0;
        const saved = Array.isArray(currentDoc?.photos) ? currentDoc.photos : [];
        const hasPhoto = saved.length > 0 || pending > 0 || !!currentDoc?.photoURL;
        if (REQUIRED.PHOTO && !hasPhoto)
          return { ok: false, message: 'Add at least one photo before saving.', focus: 'photo' };
        const loc = (locationInput.value || '').trim();
        if (REQUIRED.LOCATION && !loc)
          return { ok: false, message: 'Please enter your location before saving.', focus: 'location' };
        const dn = (displayNameInput.value || '').trim();
        if (REQUIRED.DISPLAY_NAME && !dn)
          return { ok: false, message: 'Please enter your display name before saving.', focus: 'displayName' };
        if (REQUIRED.AGE) {
          const a = Number(ageInput.value);
          if (!Number.isFinite(a) || a < 18 || a > 100) return { ok: false, message: 'Please enter a valid age (18-100).', focus: 'age' };
        }
        // Additional required fields: gender, hobbies, interests
        const genderVal = (genderInput?.value || '').trim();
        if (!genderVal) return { ok: false, message: 'Please select your gender.', focus: 'gender' };
        const hobbiesVal = (hobbiesInput?.value || '').trim();
        if (!hobbiesVal) return { ok: false, message: 'Please list your hobbies.', focus: 'hobbies' };
        const interestsVal = (interestsInput?.value || '').trim();
        if (!interestsVal) return { ok: false, message: 'Please list your interests.', focus: 'interests' };
        return { ok: true };
      }
      function refreshSaveButtonState(currentDoc) {
        const res = validateBeforeSave(currentDoc, avatarInput.files);
        saveEdit.disabled = !res.ok;
        if (!res.ok) uploadStatus.innerHTML = `<span class="prog">${res.message}</span>`;
        else uploadStatus.textContent = '';
      }
      function focusInvalid(key) {
        if (key === 'location') {
          locationInput.classList.add('invalid');
          locationInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          locationInput.focus();
        }
        if (key === 'displayName') {
          displayNameInput.classList.add('invalid');
          displayNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          displayNameInput.focus();
        }
        if (key === 'age') {
          ageInput.classList.add('invalid');
          ageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          ageInput.focus();
        }
        if (key === 'gender') {
          genderInput.classList.add('invalid');
          genderInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          genderInput.focus();
        }
        if (key === 'hobbies') {
          hobbiesInput.classList.add('invalid');
          hobbiesInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          hobbiesInput.focus();
        }
        if (key === 'interests') {
          interestsInput.classList.add('invalid');
          interestsInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
          interestsInput.focus();
        }
        if (key === 'photo') {
          avatarInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      [displayNameInput, usernameInput, ageInput, locationInput, bioInput].forEach((el) =>
        el?.addEventListener('input', () => refreshSaveButtonState(myDocCached))
      );
      genderInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      hobbiesInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      interestsInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      avatarInput.addEventListener('change', (e) => {
        renderPreviews(e.target.files);
        refreshSaveButtonState(myDocCached);
      });

      /* ===== SECTION: Swipe (Touch/Buttons) ===== */
      function nextProfile() {
        currentIndex++;
        renderProfile(matches[currentIndex] || null);
      }
      function showIndicator(t) {
        passIndicator.style.opacity = t === 'pass' ? 1 : 0;
        likeIndicator.style.opacity = t === 'like' ? 1 : 0;
      }
      let startX = 0,
        dx = 0,
        dragging = false;
      cardFrame.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        dragging = true;
      });
      cardFrame.addEventListener('touchmove', (e) => {
        if (!dragging) return;
        dx = e.touches[0].clientX - startX;
        if (dx > 50) showIndicator('like');
        else if (dx < -50) showIndicator('pass');
        else showIndicator(null);
      });
      cardFrame.addEventListener('touchend', () => {
        if (!dragging) return;
        if (Math.abs(dx) > 100) {
          if (dx > 0) {
            // like swipe
            const current = matches[currentIndex];
            if (current && current.uid && me && current.uid !== me.uid) {
              recordLike(current.uid);
            }
          }
          nextProfile();
        }
        showIndicator(null);
        dragging = false;
        dx = 0;
      });

      // Clicking the big photo opens the modal profile w/ gallery
      mainPhoto.addEventListener('click', () => {
        try {
          const p = Array.isArray(matches) ? matches[currentIndex] : null;
          if (p) showPublicProfile(p);
        } catch (e) {
          console.error(e);
        }
      });

      /* ===== SECTION: Data Layer (Load/Create/Save) ===== */
      async function loadOrCreateUserDoc(uid, userObj) {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          const seed = {
            uid,
            displayName: userObj.displayName || 'Member',
            username: '',
            gender: '',
            hobbies: '',
            interests: '',
            photoURL: userObj.photoURL || '',
            photos: userObj.photoURL ? [userObj.photoURL] : [],
            bio: '',
            age: null,
            location: '',
            badges: [],
            flags: [],
            membership: { tier: 'free' },
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          };
          await setDoc(uref, seed);
          return seed;
        }
        return snap.data();
      }
      async function saveEdits() {
        if (!me) return;
        saveEdit.disabled = true;
        uploadStatus.innerHTML = `<span class="prog">Saving...</span>`;
        try {
          const uref = doc(db, 'users', me.uid);
          const pre = await getDoc(uref);
          const currentDoc = pre.data() || {};
          const files = Array.from(avatarInput.files || []);
          const check = validateBeforeSave(currentDoc, files);
          if (!check.ok) {
            showError(check.message);
            focusInvalid(check.focus);
            saveEdit.disabled = false;
            return;
          }
          let photos = Array.isArray(currentDoc.photos) ? [...currentDoc.photos] : [];
          if (files.length) {
            uploadStatus.innerHTML = `<span class="prog">Uploading ${files.length} photo(s)...</span>`;
          }
          for (const f of files) {
            const safeName = (f.name || 'photo').replace(/[^\w.\-]+/g, '_');
            const path = `avatars/${me.uid}/${Date.now()}_${safeName}`;
            const r = sRef(storage, path);
            await uploadBytes(r, f);
            const url = await getDownloadURL(r);
            photos.push(url);
          }
          let photoURL = currentDoc.photoURL || photos[0] || '';
          if (!currentDoc.photoURL && photos[0]) {
            try {
              await updateProfile(me, { photoURL: photos[0] });
            } catch {}
            photoURL = photos[0];
          }
          const payload = {
            displayName: (displayNameInput.value || '').trim(),
            username: (usernameInput.value || '').trim(),
            gender: (genderInput?.value || '').trim(),
            hobbies: (hobbiesInput?.value || '').trim(),
            interests: (interestsInput?.value || '').trim(),
            bio: (bioInput.value || '').trim(),
            age: ageInput.value ? Number(ageInput.value) : null,
            location: (locationInput.value || '').trim(),
            photoURL,
            photos,
            updatedAt: serverTimestamp(),
          };
          await setDoc(uref, payload, { merge: true });
          myDocCached = { ...(myDocCached || {}), ...payload };
          topLine.textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
          handleEl.textContent = myDocCached.username ? `@${myDocCached.username}` : '';
          renderGallery(photos);
          if (!matches.length) renderProfile(myDocCached);
          avatarInput.value = '';
          clearPreviews();
          showOK('Profile saved.');
          // ===== Added: after saving, re-enforce profile gate =====
          enforceProfileGate();
          setTimeout(() => {
            editModal.style.display = 'none';
          }, 400);
        } catch (e) {
          showError(`Save failed: ${e?.message || 'error'}`);
        } finally {
          saveEdit.disabled = false;
        }
      }
      saveEdit.addEventListener('click', saveEdits);

      function gateLikesViewsLocked(tab) {
        // Always return false to ensure likes, views, matches are not gated
        return false;
      }
      async function fetchUsersByIds(ids) {
        if (!ids?.length) return [];
        const out = [];
        for (const uid of ids) {
          const snap = await getDoc(doc(db, 'users', uid));
          if (snap.exists()) out.push({ uid, ...snap.data() });
        }
        return out;
      }
      async function getLikesForMe(uid) {
        const qy = query(collection(db, 'likes'), where('toUid', '==', uid));
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach((d) => rows.push(d.data()));
        rows.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
        const ids = rows.map((r) => r.fromUid).filter(Boolean);
        return fetchUsersByIds(ids);
      }
      async function getViewsForMe(uid) {
        const qy = query(collection(db, 'views'), where('viewedUid', '==', uid));
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach((d) => rows.push(d.data()));
        rows.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
        const ids = rows.map((r) => r.viewerUid).filter(Boolean);
        return fetchUsersByIds(ids);
      }
      async function getMatchesForMe(uid) {
        const qy = query(collection(db, 'matches'), where('uids', 'array-contains', uid));
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach((d) => rows.push({ id: d.id, ...d.data() }));
        rows.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
        const partnerIds = [];
        rows.forEach((d) => {
          const arr = d.uids || [];
          const other = arr.find((x) => x !== uid);
          if (other) partnerIds.push(other);
        });
        return fetchUsersByIds(partnerIds);
      }
      async function getThreads(uid) {
        const qy = query(collection(db, 'chats'), where('uids', 'array-contains', uid));
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach((d) => rows.push({ id: d.id, ...d.data() }));
        rows.sort((a, b) => (b.lastMessageAt?.toMillis?.() || 0) - (a.lastMessageAt?.toMillis?.() || 0));
        const map = new Map();
        rows.forEach((d) => {
          const other = (d.uids || []).find((x) => x !== uid);
          if (other && !map.has(other)) map.set(other, { chatId: d.id, ...d });
        });
        const users = await fetchUsersByIds([...map.keys()]);
        return users.map((u) => ({ ...u, chatId: map.get(u.uid)?.chatId || null }));
      }

      /* ===== SECTION: Inbox UI ===== */
      function userCard(u, { locked = false, trailing = null } = {}) {
        const primary = safePrimaryPhoto(u);
        const img = primary || NEUTRAL_PHOTO;
        const name = u.displayName || 'Member';
        const age = typeof u.age === 'number' ? `, ${u.age}` : '';
        const loc = u.location || '';
        const item = document.createElement('div');
        item.className = 'inbox-item' + (locked ? ' locked' : '');
        item.innerHTML = `
          <div class="thumb">
            <img class="${locked ? 'blur' : ''}" src="${img}" alt="">
          </div>
          <div class="inbox-meta">
            <div class="inbox-name">${name}${age}</div>
            <div class="inbox-sub">${loc}</div>
            ${trailing || ''}
          </div>
        `;
        if (locked) {
          const overlay = document.createElement('div');
          overlay.className = 'lock-badge';
          overlay.innerHTML = `
            <div>
              <div>Members Only</div>
              <button class="lock-msg" data-upg>Unlock</button>
            </div>`;
          item.appendChild(overlay);
          overlay.querySelector('[data-upg]').addEventListener('click', () => upgradeBtn?.click());
        }
        return item;
      }
      const TAB_FUNCS = {
        likes: getLikesForMe,
        views: getViewsForMe,
        matches: getMatchesForMe,
        messages: getThreads,
      };
      function openInbox() {
        inboxModal.style.display = 'flex';
      }
      function closeInboxModal() {
        inboxModal.style.display = 'none';
      }
      inboxBtn?.addEventListener('click', () => {
        openInbox();
        renderInbox('likes');
      });
      closeInbox?.addEventListener('click', closeInboxModal);
      inboxModal?.addEventListener('click', (e) => {
        if (e.target === inboxModal) closeInboxModal();
      });
      inboxTabs?.addEventListener('click', (e) => {
        const b = e.target.closest('.inbox-tab');
        if (!b) return;
        renderInbox(b.dataset.tab);
      });
      async function renderInbox(tab) {
        if (!me || !myDocCached) return;
        [...inboxTabs.querySelectorAll('.inbox-tab')].forEach((b) =>
          b.classList.toggle('active', b.dataset.tab === tab)
        );
        inboxList.innerHTML = "<div class='muted'>Loading...</div>";
        let items = [];
        try {
          items = await TAB_FUNCS[tab](me.uid);
        } catch (e) {
          console.error(e);
          inboxList.innerHTML = "<div class='muted'>Could not load. Try again.</div>";
          return;
        }
        const locked = gateLikesViewsLocked(tab);
        inboxList.innerHTML = '';
        if (!items.length) {
          inboxList.innerHTML = "<div class='muted'>Nothing here yet.</div>";
          return;
        }
        for (const u of items) {
          let trailing = '';
          if (tab === 'matches' || tab === 'messages') {
            trailing = `<div style="margin-top:6px;display:flex;gap:6px">
                          <button class="btn small" data-chat="${u.uid}">Message</button>
                          <button class="btn danger small" data-open="${u.uid}">View</button>
                        </div>`;
          }
          const card = userCard(u, { locked, trailing });
          if (!locked) {
            const showProfile = () => {
              try {
                showPublicProfile(u);
              } catch (e) {
                console.error(e);
              }
            };
            card.querySelector('img')?.addEventListener('click', showProfile);
            card.querySelector(`[data-open="${u.uid}"]`)?.addEventListener('click', showProfile);
            card.querySelector(`[data-chat="${u.uid}"]`)?.addEventListener('click', () => openChatWith(u));
          }
          inboxList.appendChild(card);
        }
      }

      /* ===== SECTION: Chat ===== */
      function openChatModal() {
        chatModal.style.display = 'flex';
      }
      function closeChatModal() {
        chatModal.style.display = 'none';
        chatTitle.textContent = 'Chat';
        chatScroll.innerHTML = '';
        chatInput.value = '';
        if (activeChat.unsub) {
          activeChat.unsub();
          activeChat.unsub = null;
        }
        activeChat = { chatId: null, partner: null, unsub: null };
      }
      closeChat?.addEventListener('click', closeChatModal);
      chatModal?.addEventListener('click', (e) => {
        if (e.target === chatModal) closeChatModal();
      });
      async function findOrCreateChat(uidA, uidB) {
        const snap = await getDocs(query(collection(db, 'chats'), where('uids', 'array-contains', uidA)));
        let existing = null;
        snap.forEach((d) => {
          const arr = d.data().uids || [];
          if (arr.includes(uidB)) existing = { id: d.id, ...d.data() };
        });
        if (existing) return existing.id;
        const ref = await addDoc(collection(db, 'chats'), {
          uids: [uidA, uidB],
          createdAt: serverTimestamp(),
          lastMessage: '',
          lastMessageAt: serverTimestamp(),
        });
        return ref.id;
      }
      async function openChatWith(user) {
        if (!me) return;
        const chatId = await findOrCreateChat(me.uid, user.uid);
        activeChat.chatId = chatId;
        activeChat.partner = user;
        chatTitle.textContent = user.displayName ? `Chat with ${user.displayName}` : 'Chat';
        openChatModal();
        const msgCol = collection(db, 'chats', chatId, 'messages');
        activeChat.unsub = onSnapshot(query(msgCol, orderBy('createdAt', 'asc'), limit(200)), (snap) => {
          chatScroll.innerHTML = '';
          snap.forEach((d) => {
            const m = d.data();
            const div = document.createElement('div');
            div.className = 'bubble ' + (m.from === me.uid ? 'me' : 'them');
            div.textContent = m.text || '';
            chatScroll.appendChild(div);
          });
          chatScroll.scrollTop = chatScroll.scrollHeight;
        });
      }
      chatSend?.addEventListener('click', async () => {
        const text = chatInput.value.trim();
        if (!text || !activeChat.chatId || !me) return;
        const msgCol = collection(db, 'chats', activeChat.chatId, 'messages');
        await addDoc(msgCol, { from: me.uid, text, createdAt: serverTimestamp() });
        await updateDoc(doc(db, 'chats', activeChat.chatId), {
          lastMessage: text,
          lastMessageAt: serverTimestamp(),
        });
        chatInput.value = '';
      });

      /* ===== SECTION: Filter Modal Controls ===== */
      function openFilter() {
        filterModal.style.display = 'flex';
      }
      function closeFilter() {
        filterModal.style.display = 'none';
      }
      filterBtn?.addEventListener('click', openFilter);
      cancelFilter?.addEventListener('click', closeFilter);
      filterModal?.addEventListener('click', (e) => {
        if (e.target === filterModal) closeFilter();
      });
      const _norm = (s) => (s || '').toLowerCase().trim();
      function _ageOK(u, min, max) {
        const a = Number(u?.age);
        if (min != null && (!Number.isFinite(a) || a < min)) return false;
        if (max != null && (!Number.isFinite(a) || a > max)) return false;
        return true;
      }
      function _locOK(u, loc) {
        if (!loc) return true;
        return _norm(u?.location).includes(_norm(loc));
      }
      function rebuildMatchesWithFilters() {
        let list = Array.isArray(allUsers) ? allUsers.slice() : [];
        list = list.filter((u) => _ageOK(u, currentFilters.min, currentFilters.max) && _locOK(u, currentFilters.location));
        matches = list.length ? list : [myDocCached];
        currentIndex = 0;
        renderProfile(matches[currentIndex] || null);
      }
      applyFilter?.addEventListener('click', () => {
        currentFilters.location = filterLocEl?.value.trim() || '';
        currentFilters.min = filterAgeMin?.value ? Number(filterAgeMin.value) : null;
        currentFilters.max = filterAgeMax?.value ? Number(filterAgeMax.value) : null;
        rebuildMatchesWithFilters();
        closeFilter();
      });

      /* ===== SECTION: Delete Account ===== */
      async function deleteStorageFolder(prefix) {
        try {
          const folderRef = sRef(storage, prefix);
          const list = await listAll(folderRef);
          for (const f of list.items) {
            await deleteObject(f);
          }
          for (const dir of list.prefixes) {
            await deleteStorageFolder(dir.fullPath);
          }
        } catch (e) {
          console.warn('Storage cleanup warning:', e.message);
        }
      }
      async function deleteRelatedDocs(uid) {
        const collectionsToClean = [
          { name: 'likes', field: 'fromUid' },
          { name: 'likes', field: 'toUid' },
          { name: 'views', field: 'viewerUid' },
          { name: 'views', field: 'viewedUid' },
          { name: 'matches', field: 'uids', array: true },
          { name: 'chats', field: 'uids', array: true },
        ];
        for (const cfg of collectionsToClean) {
          try {
            let qy;
            if (cfg.array) {
              qy = query(collection(db, cfg.name), where(cfg.field, 'array-contains', uid), limit(100));
            } else {
              qy = query(collection(db, cfg.name), where(cfg.field, '==', uid), limit(100));
            }
            const snap = await getDocs(qy);
            const toDelete = [];
            snap.forEach((d) => toDelete.push(d.ref));
            for (const ref of toDelete) {
              await deleteDoc(ref);
            }
          } catch (e) {
            console.warn(`Cleanup ${cfg.name} skip:`, e.message);
          }
        }
      }
      async function handleDeleteAccount() {
        if (!me) return;
        const confirmText = prompt('Type DELETE to permanently remove your account (this cannot be undone).');
        if (confirmText !== 'DELETE') return;
        try {
          const lastSignIn = me.metadata?.lastSignInTime ? new Date(me.metadata.lastSignInTime).getTime() : 0;
          const needsReauth = Date.now() - lastSignIn > 5 * 60 * 1000;
          if (needsReauth && me.providerData.some((p) => p.providerId === 'password')) {
            const email = me.email;
            const pwd = prompt('Re-enter your password to confirm delete:');
            if (!pwd) return alert('Deletion cancelled.');
            const cred = EmailAuthProvider.credential(email, pwd);
            await reauthenticateWithCredential(me, cred);
          }
        } catch (e) {
          alert('Re-auth failed. Cannot delete account.');
          return;
        }
        try {
          await deleteDoc(doc(db, 'users', me.uid));
        } catch (e) {
          console.warn('User doc delete:', e.message);
        }
        try {
          await deleteStorageFolder(`avatars/${me.uid}`);
        } catch (e) {
          console.warn('Storage delete:', e.message);
        }
        try {
          await deleteRelatedDocs(me.uid);
        } catch (e) {
          console.warn('Related cleanup:', e.message);
        }
        try {
          await deleteUser(me);
          alert('Your account has been deleted.');
          location.replace('./signup.html');
        } catch (e) {
          console.warn('Auth delete failed:', e?.code || e?.message);
          alert('Your data has been removed. Please sign in again to fully remove the auth account.');
          try {
            await signOut(auth);
          } catch {}
          location.replace('./login.html');
        }
      }
      deleteBtn?.addEventListener('click', handleDeleteAccount);

      /* ===== SECTION: Modal Controls (Edit/Inbox/Chat) ===== */
      function openEdit() {
        editModal.style.display = 'flex';
      }
      function closeEdit() {
        editModal.style.display = 'none';
      }
      editBtn.addEventListener('click', (e) => {
        e.preventDefault();
        openEdit();
      });
      cancelEdit.addEventListener('click', closeEdit);
      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) closeEdit();
      });

      /* ===== SECTION: Auth / Init ===== */
      myProfileBtn.addEventListener('click', () => {
        if (me) {
          location.replace(`./profile.html?uid=${encodeURIComponent(me.uid)}`);
        } else {
          location.replace('./login.html');
        }
      });
      logoutBtn.addEventListener('click', async () => {
        try {
          await signOut(auth);
          location.replace('./login.html');
        } catch (e) {
          console.error('Logout error:', e);
        }
      });
      upgradeBtn.addEventListener('click', async () => {
        if (!me) return;
        try {
          const resp = await fetch('/api/create-checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: me.uid, email: me.email }),
          });
          if (!resp.ok) {
            const text = await resp.text().catch(() => '');
            console.error('Checkout HTTP error', resp.status, text);
            alert('Unable to start checkout right now.');
            return;
          }
          const data = await resp.json().catch(() => ({}));
          if (data?.checkoutUrl) {
            location.href = data.checkoutUrl;
          } else {
            console.error('Checkout JSON missing checkoutUrl', data);
            alert('Checkout configuration error. Try again soon.');
          }
        } catch (e) {
          console.error('Checkout fetch error', e);
          alert('Network issue starting checkout. Please try again.');
        }
      });

      /* ===== SECTION: Casualties Modal Events ===== */
      casualtiesBtn?.addEventListener('click', () => {
        if (casualtiesModal) casualtiesModal.style.display = 'flex';
        if (casualtiesPassword) casualtiesPassword.value = '';
        if (casualtiesUploadSection) casualtiesUploadSection.style.display = 'none';
        if (casualtiesPwdSection) casualtiesPwdSection.style.display = 'block';
      });
      casualtiesCheckBtn?.addEventListener('click', () => {
        if (!casualtiesPassword || !casualtiesPwdSection || !casualtiesUploadSection) return;
        if (casualtiesPassword.value === 'SPARK') {
          casualtiesPwdSection.style.display = 'none';
          casualtiesUploadSection.style.display = 'block';
        } else {
          alert('Incorrect password.');
        }
      });
      casualtiesSubmit?.addEventListener('click', async () => {
        try {
          const currentUser = typeof auth !== 'undefined' && auth.currentUser ? auth.currentUser : me;
          if (!currentUser) {
            alert('You must be logged in to upload.');
            return;
          }
          const file = casualtiesFile?.files?.[0];
          if (!file) {
            alert('Please select an image.');
            return;
          }
          const safeName = (file.name || 'photo').replace(/[^\w.\-]+/g, '_');
          const path = `casualties/${currentUser.uid}/${Date.now()}_${safeName}`;
          const ref = sRef(storage, path);
          await uploadBytes(ref, file);
          const url = await getDownloadURL(ref);
          const caption = casualtiesCaption?.value || '';
          await addDoc(collection(db, 'casualties'), {
            uid: currentUser.uid,
            url,
            caption,
            createdAt: serverTimestamp(),
          });
          if (casualtiesModal) casualtiesModal.style.display = 'none';
          if (casualtiesFile) casualtiesFile.value = '';
          if (casualtiesCaption) casualtiesCaption.value = '';
          alert('Photo uploaded successfully.');
        } catch (err) {
          console.error(err);
          alert('Upload failed: ' + (err?.message || err));
        }
      });
      closeCasualties?.addEventListener('click', () => {
        if (casualtiesModal) casualtiesModal.style.display = 'none';
      });
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          if (!_profileNavGuard) {
            _profileNavGuard = true;
            location.replace('./login.html');
          }
          return;
        }
        me = user;
        myDocCached = await loadOrCreateUserDoc(me.uid, me);
        displayNameInput.value = myDocCached.displayName || '';
        usernameInput.value = myDocCached.username || '';
        genderInput.value = myDocCached.gender || '';
        hobbiesInput.value = myDocCached.hobbies || '';
        interestsInput.value = myDocCached.interests || '';
        bioInput.value = myDocCached.bio || '';
        ageInput.value = myDocCached.age || '';
        locationInput.value = myDocCached.location || '';
        renderGallery(myDocCached.photos || []);
        topLine.textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
        uidLine.textContent = topLine.textContent;
        if (viewUidParam) {
          try {
            if (viewUidParam === me.uid) {
              matches = [myDocCached];
              currentIndex = 0;
              renderProfile(myDocCached);
              refreshSaveButtonState(myDocCached);
              renderInbox('likes');
              enforceProfileGate();
              return;
            } else {
              const otherSnap = await getDoc(doc(db, 'users', viewUidParam));
              if (otherSnap.exists()) {
                const other = { uid: viewUidParam, ...otherSnap.data() };
                matches = [other];
                currentIndex = 0;
                renderProfile(other);
                refreshSaveButtonState(myDocCached);
                renderInbox('likes');
                enforceProfileGate();
                return;
              }
            }
          } catch (e) {
            console.warn('viewUidParam load failed:', e?.message);
          }
        }
        try {
          const snap = await getDocs(collection(db, 'users'));
          allUsers = [];
          snap.forEach((d) => {
            if (d.id !== me.uid) allUsers.push({ uid: d.id, ...d.data() });
          });
        } catch {
          allUsers = [];
        }
        matches = allUsers.length ? allUsers : [myDocCached];
        currentIndex = 0;
        renderProfile(matches[currentIndex] || null);
        refreshSaveButtonState(myDocCached);
        renderInbox('likes');
        enforceProfileGate();
      });
      /* ===== SECTION: Safety Harness ===== */
      (function () {
        try {
          const $ = (id) => document.getElementById(id);
          const bind = (el, type, fn) => {
            if (el && !el.dataset.bound) {
              // ===== Modified: wrap event with profile-complete check =====
              el.addEventListener(type, (...args) => {
                try {
                  if (!profileComplete && ['browseBtn','like-btn','pass-btn'].includes(el.id)) {
                    alert('Please complete your profile before browsing.');
                    openEdit();
                    return;
                  }
                } catch (e) {
                  console.error(e);
                }
                try {
                  fn(...args);
                } catch (e) {
                  console.error(e);
                }
              });
              el.dataset.bound = '1';
            }
          };
          bind($('inboxBtn'), 'click', () => {
            try {
              renderInbox('likes');
            } catch (e) {
              console.error(e);
            }
          });
          bind($('browseBtn'), 'click', () => {
            try {
              if (!me || !myDocCached) return;
              getMatchesForMe(me.uid)
                .then((list) => {
                  matches = Array.isArray(list) && list.length ? list : [myDocCached];
                  currentIndex = 0;
                  renderProfile(matches[currentIndex] || null);
                  renderInbox('matches');
                })
                .catch((err) => {
                  console.error('Browse Matches handler failed:', err);
                });
            } catch (e) {
              console.error(e);
            }
          });
          bind($('editBtn'), 'click', () => {
            try {
              document.getElementById('editModal').style.display = 'flex';
            } catch (e) {
              console.error(e);
            }
          });
          bind($('logoutBtn'), 'click', async () => {
            try {
              await signOut(auth);
              location.replace('./login.html');
            } catch (e) {
              console.error(e);
            }
          });
          bind($('pass-btn'), 'click', () => {
            try {
              showIndicator('pass');
              setTimeout(() => {
                showIndicator(null);
                nextProfile();
              }, 120);
            } catch (e) {
              console.error(e);
            }
          });
          bind($('like-btn'), 'click', () => {
            try {
              showIndicator('like');
              const current = Array.isArray(matches) ? matches[currentIndex] : null;
              if (current && current.uid && me && current.uid !== me.uid) {
                recordLike(current.uid);
              }
              setTimeout(() => {
                showIndicator(null);
                nextProfile();
              }, 120);
            } catch (e) {
              console.error(e);
            }
          });
          const mainPhotoBound = document.getElementById('main-photo');
          if (mainPhotoBound && !mainPhotoBound.dataset.bound) {
            mainPhotoBound.addEventListener('click', () => {
              try {
                const p = Array.isArray(matches) ? matches[currentIndex] : null;
                if (p) showPublicProfile(p);
              } catch (e) {
                console.error(e);
              }
            });
            mainPhotoBound.dataset.bound = '1';
          }
        } catch (err) {
          console.error('Safety harness failed:', err);
        }
      })();
    </script>
    <script type="module">
      import { waitForAuth } from '/js/firebase.js';
      (async () => {
        const user = await waitForAuth();
        console.log('Current user:', user ? user.uid : null);
        if (!user) {
          console.warn('Not signed in — Storage rules will block uploads (403).');
        }
      })();
    </script>
  </body>
</html>
