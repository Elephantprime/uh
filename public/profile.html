<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- ===== SECTION: Head / Meta ===== -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unhinged - Profile</title>

    <!-- ===== SECTION: Styles (Design System) ===== -->
    <style>
      :root {
        --bg: #0e0e12;
        --panel: #15161b;
        --muted: #cfd0de;
        --red: #E11D2A;
        --green: #4CAF50;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        background: var(--bg);
        color: #fff;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      /* Buttons */
      .btn {
        border: none;
        background: var(--red);
        color: #fff;
        padding: 0.5rem 0.9rem;
        border-radius: 8px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
      }
      .btn.secondary {
        background: #3a3a3a;
        color: #fff;
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid #444;
      }
      .btn.pill {
        border-radius: 16px;
        padding: 0.55rem 1rem;
      }
      .btn.small {
        padding: 0.35rem 0.7rem;
        font-size: 0.9rem;
      }
      .chaos-btn {
        background: var(--red);
        color: #fff;
        border: none;
        border-radius: 16px;
        padding: 8px 16px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      /* Text helpers */
      .muted {
        color: var(--muted);
        font-size: 0.9rem;
      }

      /* ===== SECTION: Top Bar ===== */
      .topbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem 1rem;
        background: var(--panel);
        border-bottom: 1px solid #2a2a2a;
      }
      .brand {
        font-weight: 700;
      }
      .nav-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      /* ===== SECTION: Content Wrapper ===== */
      .content {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px;
        gap: 12px;
        width: 100%;
      }

      /* ===== SECTION: Swipe Card ===== */
      .card-frame {
        position: relative;
        width: 92%;
        max-width: 420px;
        height: 72vh;
        border: 2px solid #2a2a2a;
        border-radius: 16px;
        overflow: hidden;
        background: #000;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
        touch-action: pan-y;
      }
      .main-photo {
        width: 100%;
        height: 100%;
        object-fit: cover;
        user-select: none;
        -webkit-user-drag: none;
        cursor: pointer;
      }
      .info-overlay {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 14px 16px;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.78));
        pointer-events: none;
      }
      .info-overlay h2 {
        margin: 0;
        font-size: 1.4rem;
      }
      .handle {
        font-size: 0.95rem;
        color: #cfd0de;
        margin-top: 2px;
      }
      .sub {
        font-size: 0.9rem;
        color: #ddd;
        margin-top: 2px;
      }
      .badges, .flags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }
      .badges img {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #4cafef;
        background: #2a2a3a;
        padding: 2px;
      }
      .flags .flag-pill {
        font-size: 0.75rem;
        border: 1px solid #3a3b44;
        border-radius: 999px;
        padding: 2px 8px;
        background: #14151a;
      }
      .indicator {
        position: absolute;
        top: 16px;
        font-size: 1.4rem;
        font-weight: 700;
        padding: 6px 12px;
        border: 3px solid;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.12s ease;
      }
      .indicator.pass {
        left: 14px;
        color: var(--red);
        border-color: var(--red);
        transform: rotate(-18deg);
      }
      .indicator.like {
        right: 14px;
        color: var(--green);
        border-color: var(--green);
        transform: rotate(18deg);
      }
      .empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ddd;
        font-size: 1.1rem;
      }

      /* ===== SECTION: Bottom Actions ===== */
      .actions {
        width: 100%;
        max-width: 480px;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0 16px;
        position: relative;
        z-index: 20;
      }
      .action-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        border: none;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }
      .pass-btn {
        background: #2a2a2a;
        color: var(--red);
      }
      .like-btn {
        background: #2a2a2a;
        color: var(--green);
      }

      /* ===== SECTION: Modal Base ===== */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        z-index: 60;
      }
      .modal {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 1rem;
      }
      /* scroll fix: allow modal to scroll */
      #editModal .modal {
        max-height: 90vh;
        overflow-y: auto;
      }

      label {
        display: flex;
        align-items: center;
        gap: 0.35rem;
        margin: 0.5rem 0 0.25rem;
      }
      .req {
        color: #ff6b6b;
        font-weight: 700;
      }
      input[type="text"],
      textarea,
      input[type="number"],
      select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
        background: #12131a;
        color: #fff;
      }
      .row {
        display: flex;
        gap: 0.5rem;
      }
      .row > * {
        flex: 1;
      }
      .status {
        margin-top: 0.5rem;
        font-size: 0.9rem;
      }
      .ok {
        color: #6fdc8c;
      }
      .err {
        color: #ff8e8e;
      }
      .prog {
        color: #ffd27f;
      }
      .invalid {
        outline: 2px solid #ff6b6b;
        outline-offset: 2px;
        border-color: #ff6b6b !important;
      }

      /* Gallery */
      .gallery {
        margin-top: 0.5rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
        gap: 8px;
      }
      .thumb {
        position: relative;
        width: 100%;
        padding-top: 100%;
        border: 2px solid #2a2a2a;
        border-radius: 8px;
        overflow: hidden;
        background: #0b0b0f;
        cursor: pointer;
      }
      .thumb img {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .label-pill {
        position: absolute;
        left: 6px;
        top: 6px;
        font-size: 0.7rem;
        background: #000000aa;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid #2a2a2a;
      }
      .thumb.primary {
        border-color: var(--red);
      }
      .hint {
        font-size: 0.85rem;
        color: #cfd0de;
        margin-top: 0.25rem;
      }

      /* ===== INBOX / GATING ===== */
      .inbox-btn {
        background: #2a2a2a;
        color: #fff;
        border: none;
        border-radius: 10px;
        padding: 0.5rem 0.8rem;
        cursor: pointer;
      }
      .inbox-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 80;
      }
      .inbox-card {
        width: 100%;
        max-width: 900px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        padding: 12px;
      }
      .inbox-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        flex-wrap: wrap;
      }
      .inbox-tab {
        border: 1px solid #444;
        background: #3a3a3a;
        border-radius: 999px;
        padding: 0.45rem 0.8rem;
        cursor: pointer;
        color: #fff;
      }
      .inbox-tab.active {
        border-color: var(--red);
        background: #4a4a4a;
        box-shadow: 0 0 0 2px #E11D2A33 inset;
      }
      .inbox-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(210px, 1fr));
        gap: 10px;
        min-height: 160px;
      }
      .inbox-item {
        position: relative;
        border: 1px solid #2a2a2a;
        border-radius: 10px;
        overflow: hidden;
        background: #111;
      }
      .inbox-item img {
        width: 100%;
        height: 160px;
        object-fit: cover;
        display: block;
      }
      .inbox-meta {
        padding: 8px;
      }
      .inbox-name {
        font-weight: 700;
      }
      .inbox-sub {
        font-size: 0.9rem;
        color: #cfd0de;
      }
      .locked .blur {
        filter: blur(6px);
      }
      .lock-badge {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(#0000, #0008);
        color: #fff;
        font-weight: 700;
        letter-spacing: 0.3px;
        text-align: center;
        padding: 8px;
      }
      .lock-msg {
        background: #E11D2A;
        border: none;
        border-radius: 999px;
        padding: 0.35rem 0.7rem;
        cursor: pointer;
        margin-top: 0.5rem;
      }

      /* ===== CHAT MODAL ===== */
      .chat-modal {
        position: fixed;
        inset: 0;
        background: #0009;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 12px;
        z-index: 90;
      }
      .chat-card {
        width: 100%;
        max-width: 700px;
        background: var(--panel);
        border: 1px solid #2a2a2a;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        height: 75vh;
      }
      .chat-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #2a2a2a;
      }
      .chat-scroll {
        flex: 1;
        overflow: auto;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .bubble {
        max-width: 70%;
        padding: 8px 10px;
        border-radius: 12px;
      }
      .bubble.me {
        align-self: flex-end;
        background: #E11D2A;
        color: #fff;
      }
      .bubble.them {
        align-self: flex-start;
        background: #2a2a2a;
      }
      .chat-send {
        display: flex;
        gap: 8px;
        padding: 10px;
        border-top: 1px solid #2a2a2a;
      }
      .chat-send input {
        flex: 1;
        padding: 10px;
        border-radius: 10px;
        background: #12131a;
        border: 1px solid #2a2a2a;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <!-- ===== SECTION: Top Bar ===== -->
    <div class="topbar">
      <div class="brand" id="topLine">Your Profile</div>
      <div class="nav-actions">
        <button class="btn secondary" id="filterBtn" type="button" onclick="document.getElementById('filterModal').style.display='flex'">Filter</button>
        <button class="btn secondary inbox-btn" id="inboxBtn" type="button" onclick="document.getElementById('inboxModal').style.display='flex'">Inbox</button>
        <button class="btn danger" id="browseBtn" type="button">Browse Matches</button>
        <button class="btn secondary" id="casualtiesBtn" type="button">Casualties Upload</button>
        <a class="chaos-btn" href="./app.html">Community Chaos</a>
        <button class="btn secondary" id="myProfileBtn" type="button">My Profile</button>
        <button class="btn secondary" id="upgradeBtn" type="button">Go Paid</button>
        <button class="btn" id="editBtn" type="button" onclick="document.getElementById('editModal').style.display='flex'">Edit Profile</button>
        <button class="btn secondary" id="logoutBtn" type="button">Logout</button>
        <button class="btn ghost" id="deleteBtn" type="button" title="Delete my account">Delete</button>
      </div>
    </div>

    <!-- ===== CASUALTIES MODAL ===== -->
    <div class="modal-backdrop" id="casualtiesModal">
      <div class="modal">
        <h3>Casualties of Modern Dating</h3>
        <div id="casualtiesPwdSection">
          <label for="casualtiesPassword">Enter password:</label>
          <input id="casualtiesPassword" type="password" />
          <button class="btn" id="casualtiesCheckBtn" type="button">Check</button>
        </div>
        <div id="casualtiesUploadSection" style="display: none;">
          <label for="casualtiesFile">Upload image:</label>
          <input id="casualtiesFile" type="file" accept="image/*" />
          <label for="casualtiesCaption">Caption (optional):</label>
          <input id="casualtiesCaption" type="text" placeholder="Caption" />
          <button class="btn" id="casualtiesSubmit" type="button">Upload</button>
        </div>
        <button class="btn secondary" id="closeCasualties" type="button">Close</button>
      </div>
    </div>

    <!-- ===== SECTION: Content ===== -->
    <div class="content">
      <!-- ===== SECTION: Swipe Card ===== -->
      <div class="card-frame" id="cardFrame">
        <img class="main-photo" id="main-photo" src="" alt="Profile Photo" />
        <div class="info-overlay">
          <h2 id="name"></h2>
          <div class="handle" id="handle"></div>
          <div class="sub" id="sub-info"></div>
          <div class="badges" id="badges"></div>
          <div class="flags" id="flags"></div>
        </div>
        <div class="indicator pass" id="pass-indicator">PASS</div>
        <div class="indicator like" id="like-indicator">LIKE</div>
        <div class="empty" id="empty" style="display: none;">No more matches</div>
      </div>

      <!-- ===== SECTION: Bottom Actions ===== -->
      <div class="actions">
        <button class="action-btn pass-btn" id="pass-btn" aria-label="Pass">Pass</button>
        <button class="chaos-btn" onclick="location.href='./app.html'">Community Chaos</button>
        <button class="action-btn like-btn" id="like-btn" aria-label="Like">Like</button>
      </div>
    </div>

    <!-- ===== SECTION: Edit Profile Modal ===== -->
    <div class="modal-backdrop" id="editModal">
      <div class="modal">
        <h3>Edit Profile</h3>
        <div class="muted" id="uidLine"></div>

        <!-- Subsection: Identity -->
        <div class="row">
          <div>
            <label for="displayName">
              Display name
              <span class="req" id="reqDisplayName" hidden>*</span>
            </label>
            <input id="displayName" type="text" />
          </div>
          <div>
            <label for="username">Username</label>
            <input id="username" type="text" placeholder="yourhandle" />
          </div>
        </div>

        <!-- Subsection: About -->
        <div class="row">
          <div>
            <label for="age">
              Age
              <span class="req" id="reqAge" hidden>*</span>
            </label>
            <input id="age" type="number" min="18" max="100" />
          </div>
          <div>
            <label for="location">
              Location
              <span class="req" id="reqLocation" hidden>*</span>
            </label>
            <input id="location" type="text" placeholder="City, State" />
          </div>
        </div>

        <!-- Subsection: Extra -->
        <div class="row">
          <div>
            <label for="gender">Gender</label>
            <select id="gender">
              <option value="">Prefer not to say</option>
              <option value="female">Female</option>
              <option value="male">Male</option>
            </select>
          </div>
          <div></div>
        </div>
        <div class="row">
          <div>
            <label for="hobbies">Hobbies</label>
            <input id="hobbies" type="text" placeholder="e.g., hiking, gaming" />
          </div>
          <div>
            <label for="interests">Interests</label>
            <input id="interests" type="text" placeholder="e.g., live music, travel" />
          </div>
        </div>

        <label for="bio">Bio</label>
        <textarea id="bio" rows="3" placeholder="Say something..."></textarea>

        <!-- Subsection: Photos -->
        <label for="avatar" style="margin-top: 0.5rem;">
          Add photos (you can select multiple)
          <span class="req" id="reqPhoto" hidden>*</span>
        </label>
        <input id="avatar" type="file" accept="image/*" multiple />
        <div class="hint">
          Click a saved photo below to set it as your <b>Primary</b>. Selected
          files preview below before upload.
        </div>
        <div class="status" id="uploadStatus"></div>

        <!-- Previews (not yet uploaded) -->
        <div class="muted" style="margin-top: 0.5rem;" id="previewTitle" hidden>
          Selected (not yet uploaded)
        </div>
        <div class="gallery" id="previewGallery" hidden></div>

        <!-- Saved photos -->
        <div class="muted" style="margin-top: 0.75rem;">Saved Photos</div>
        <div class="gallery" id="gallery"></div>

        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn secondary" id="cancelEdit" type="button" onclick="document.getElementById('editModal').style.display='none'">Cancel</button>
          <button class="btn" id="saveEdit" type="button">Save</button>
        </div>
      </div>
    </div>

    <!-- ===== INBOX MODAL ===== -->
    <div class="inbox-modal" id="inboxModal">
      <div class="inbox-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
          <h3 style="margin: 0">Inbox</h3>
          <button class="btn secondary" id="closeInbox" type="button" onclick="document.getElementById('inboxModal').style.display='none'">Close</button>
        </div>
        <div class="inbox-tabs" id="inboxTabs">
          <button class="inbox-tab active" data-tab="likes">Likes</button>
          <button class="inbox-tab" data-tab="views">Views</button>
          <button class="inbox-tab" data-tab="matches">Matches</button>
          <button class="inbox-tab" data-tab="messages">Messages</button>
        </div>
        <div class="inbox-list" id="inboxList"></div>
      </div>
    </div>

    <!-- ===== CHAT MODAL ===== -->
    <div class="chat-modal" id="chatModal">
      <div class="chat-card">
        <div class="chat-head">
          <div id="chatTitle">Chat</div>
          <button class="btn secondary" id="closeChat" type="button" onclick="document.getElementById('chatModal').style.display='none'">Close</button>
        </div>
        <div class="chat-scroll" id="chatScroll"></div>
        <div class="chat-send">
          <input id="chatInput" type="text" placeholder="Type a message..." />
          <button class="btn" id="chatSend" type="button">Send</button>
        </div>
      </div>
    </div>

    <!-- ===== FILTER MODAL ===== -->
    <div class="modal-backdrop" id="filterModal">
      <div class="modal">
        <h3>Filters</h3>
        <label for="filterLocation">Location</label>
        <input id="filterLocation" type="text" placeholder="City, State" />
        <label>Age Range</label>
        <div class="row">
          <input id="filterAgeMin" type="number" min="18" max="99" placeholder="Min" />
          <input id="filterAgeMax" type="number" min="18" max="99" placeholder="Max" />
        </div>
        <div style="margin-top: 1rem; display: flex; gap: 0.5rem; justify-content: flex-end;">
          <button class="btn secondary" id="cancelFilter" type="button" onclick="document.getElementById('filterModal').style.display='none'">Cancel</button>
          <button class="btn" id="applyFilter" type="button">Apply</button>
        </div>
      </div>
    </div>

    <!-- ===== SECTION: Scripts ===== -->
    <script type="module">
      /* ===== SECTION: Imports ===== */
      import { auth, db, storage } from "./js/firebase.js";
      import {
        onAuthStateChanged,
        updateProfile,
        signOut,
        EmailAuthProvider,
        reauthenticateWithCredential,
        deleteUser,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        collection,
        getDocs,
        doc,
        getDoc,
        setDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
        orderBy,
        limit,
        addDoc,
        onSnapshot,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      import {
        ref as sRef,
        uploadBytes,
        getDownloadURL,
        listAll,
        deleteObject,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

      // ===== Global error traps =====
      window.addEventListener("error", (e) => {
        console.error("Script error", e);
      });
      window.addEventListener("unhandledrejection", (e) => {
        console.error("Unhandled rejection", e);
      });

      /* ===== SECTION: Config ===== */
      const REQUIRED = { PHOTO: true, LOCATION: true, DISPLAY_NAME: true, AGE: true };
      const MEMBERSHIP = { requiredForViews: false, requiredForLikes: false };

      /* ===== SECTION: Public Profile Modal ===== */
      function showPublicProfile(user) {
        const modal = document.createElement("div");
        modal.style.position = "fixed";
        modal.style.inset = "0";
        modal.style.background = "rgba(0,0,0,0.65)";
        modal.style.display = "flex";
        modal.style.alignItems = "center";
        modal.style.justifyContent = "center";
        modal.style.zIndex = "100";

        const card = document.createElement("div");
        card.style.background = "var(--panel)";
        card.style.color = "#fff";
        card.style.padding = "1rem";
        card.style.borderRadius = "10px";
        card.style.maxWidth = "400px";
        card.style.textAlign = "left";

        const name = user.displayName || "Member";
        const username = user.username ? `@${user.username}` : "";
        const ageText = typeof user.age === "number" ? `${user.age} years old` : "";
        const location = user.location || "";

        const photosList = Array.isArray(user.photos) ? user.photos.slice() : [];
        const fallbackPrimary = safePrimaryPhoto(user) || photosList[0] || NEUTRAL_PHOTO;
        if (photosList.length === 0 || photosList[0] !== fallbackPrimary) photosList.unshift(fallbackPrimary);
        let currentPhotoIndex = 0;

        let photoHtml = `<div style="display:flex;align-items:center;gap:6px;margin-bottom:.75rem;">
          <button id="photoPrev" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">&lt;</button>
          <img id="modalPrimaryPhoto" src="${photosList[0]}" style="flex:1;max-height:360px;object-fit:cover;border-radius:8px;" alt="Profile photo">
          <button id="photoNext" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer">&gt;</button>
        </div>`;
        if (photosList.length > 1) {
          photoHtml += `<div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:.75rem">`;
          for (let i = 0; i < photosList.length; i++) {
            const url = photosList[i];
            const border = i === 0 ? '2px solid var(--red)' : '2px solid transparent';
            photoHtml += `<img class="modal-photo-thumb" data-index="${i}" src="${encodeURI(url)}" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:${border};cursor:pointer;" alt="Photo ${i + 1}">`;
          }
          photoHtml += `</div>`;
        }

        card.innerHTML = `
          ${photoHtml}
          <h2 style="margin-top:0;margin-bottom:0">${name}</h2>
          ${username ? `<div style="font-size:.9rem;color:var(--muted);margin-bottom:.25rem">${username}</div>` : ""}
          ${ageText || location ? `<div style="font-size:.9rem;color:var(--muted);margin-bottom:.25rem">${[ageText, location].filter(Boolean).join(' • ')}</div>` : ""}
          <div style="text-align:center;margin-top:.5rem"><button class="btn small secondary" id="closeMinimalProfile">Close</button></div>
        `;
        modal.appendChild(card);
        document.body.appendChild(modal);

        modal.querySelector("#closeMinimalProfile").addEventListener("click", () => document.body.removeChild(modal));
        modal.addEventListener("click", (ev) => {
          if (ev.target === modal) document.body.removeChild(modal);
        });

        // Gallery interactions
        try {
          const modalPrimary = modal.querySelector('#modalPrimaryPhoto');
          const thumbElems = modal.querySelectorAll('.modal-photo-thumb');
          const highlight = (index) => {
            thumbElems.forEach((t) => (t.style.border = '2px solid transparent'));
            const currentThumb = modal.querySelector(`.modal-photo-thumb[data-index="${index}"]`);
            if (currentThumb) currentThumb.style.border = '2px solid var(--red)';
          };
          thumbElems.forEach((imgThumb) => {
            imgThumb.addEventListener('click', () => {
              const idx = Number(imgThumb.dataset.index);
              if (!Number.isNaN(idx)) {
                currentPhotoIndex = idx;
                modalPrimary.src = photosList[idx];
                highlight(idx);
              }
            });
          });
          modal.querySelector('#photoPrev').addEventListener('click', () => {
            if (photosList.length < 2) return;
            currentPhotoIndex = (currentPhotoIndex - 1 + photosList.length) % photosList.length;
            modalPrimary.src = photosList[currentPhotoIndex];
            highlight(currentPhotoIndex);
          });
          modal.querySelector('#photoNext').addEventListener('click', () => {
            if (photosList.length < 2) return;
            currentPhotoIndex = (currentPhotoIndex + 1) % photosList.length;
            modalPrimary.src = photosList[currentPhotoIndex];
            highlight(currentPhotoIndex);
          });
        } catch (err) {
          console.error(err);
        }
      }

      /* ===== SECTION: DOM Refs ===== */
      const nameEl = document.getElementById('name');
      const handleEl = document.getElementById('handle');
      const subInfo = document.getElementById('sub-info');
      const badgesEl = document.getElementById('badges');
      const flagsEl = document.getElementById('flags');

      /* ===== SECTION: Data Loading ===== */
      let me = null;
      let myDocCached = null;
      let allUsers = [];
      let matches = [];
      let currentIndex = 0;
      let recordedViews = new Set();
      let profileComplete = false;

      /* ===== Utility Functions ===== */
      function showIndicator(type) {
        document.getElementById('pass-indicator').style.opacity = type === 'pass' ? 1 : 0;
        document.getElementById('like-indicator').style.opacity = type === 'like' ? 1 : 0;
      }

      /* ===== Helper to enforce gating ===== */
      function enforceProfileGate() {
        profileComplete = validateBeforeSave(myDocCached || {}, []).ok;
        const btns = ['pass-btn', 'like-btn', 'browseBtn'];
        btns.forEach(id => {
          const el = document.getElementById(id);
          if (el) el.disabled = !profileComplete;
        });
        if (!profileComplete) {
          const uploadStatus = document.getElementById('uploadStatus');
          if (uploadStatus) {
            uploadStatus.innerHTML =
              "<span class='prog'>Please complete your profile before browsing.</span>";
          }
        }
      }

      /* ===== Helper: Render Profile ===== */
      function renderProfile(p) {
        if (!p) {
          document.getElementById('main-photo').src = NEUTRAL_PHOTO;
          nameEl.textContent = '';
          handleEl.textContent = '';
          subInfo.textContent = '';
          renderBadges([]);
          renderFlagsList([]);
          document.getElementById('empty').style.display = 'flex';
          return;
        }
        document.getElementById('empty').style.display = 'none';
        const primary = safePrimaryPhoto(p) || NEUTRAL_PHOTO;
        document.getElementById('main-photo').src = primary;
        const name = p.displayName || 'Member';
        const age = typeof p.age === 'number' && p.age >= 0 ? `, ${p.age}` : '';
        nameEl.textContent = `${name}${age}`;
        handleEl.textContent = p.username ? `@${p.username}` : '';
        const hobbyRaw = (p.hobbies || '').trim();
        const interestRaw = (p.interests || '').trim();
        const hobbyHint = hobbyRaw ? ` • ${hobbyRaw.slice(0, 20)}${hobbyRaw.length > 20 ? '...' : ''}` : '';
        const interestHint = interestRaw ? ` • ${interestRaw.slice(0, 20)}${interestRaw.length > 20 ? '...' : ''}` : '';
        subInfo.textContent = (p.location || '') + hobbyHint + interestHint;
        renderBadges(p.badges || []);
        const flags = Array.isArray(p.flags) ? p.flags : Array.isArray(p.quiz?.flags) ? p.quiz.flags.map((f) => f.code) : [];
        renderFlagsList(flags);
        if (p.uid) recordView(p.uid);
      }

      /* ===== Auth State and Data Load ===== */
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          if (!window._profileNavGuard) {
            window._profileNavGuard = true;
            location.replace('./login.html');
          }
          return;
        }
        me = user;

        // load user doc or create
        myDocCached = await loadOrCreateUserDoc(me.uid, me);

        // fill form
        document.getElementById('displayName').value = myDocCached.displayName || '';
        document.getElementById('username').value = myDocCached.username || '';
        document.getElementById('gender').value = myDocCached.gender || '';
        document.getElementById('hobbies').value = myDocCached.hobbies || '';
        document.getElementById('interests').value = myDocCached.interests || '';
        document.getElementById('bio').value = myDocCached.bio || '';
        document.getElementById('age').value = myDocCached.age || '';
        document.getElementById('location').value = myDocCached.location || '';
        renderGallery(myDocCached.photos || []);

        // update labels
        document.getElementById('topLine').textContent = myDocCached.username ? `@${myDocCached.username}` : `UID: ${me.uid}`;
        document.getElementById('uidLine').textContent = document.getElementById('topLine').textContent;

        // load users
        try {
          const snap = await getDocs(collection(db, 'users'));
          allUsers = [];
          snap.forEach((d) => {
            if (d.id !== me.uid) allUsers.push({ uid: d.id, ...d.data() });
          });
        } catch { allUsers = []; }

        matches = allUsers.length ? allUsers : [myDocCached];
        currentIndex = 0;
        renderProfile(matches[currentIndex] || null);
        enforceProfileGate();
      });

      /* ===== Load or create user document ===== */
      async function loadOrCreateUserDoc(uid, userObj) {
        const uref = doc(db, 'users', uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          const seed = {
            uid,
            displayName: userObj.displayName || 'Member',
            username: '',
            gender: '',
            hobbies: '',
            interests: '',
            photoURL: userObj.photoURL || '',
            photos: userObj.photoURL ? [userObj.photoURL] : [],
            bio: '',
            age: null,
            location: '',
            badges: [],
            flags: [],
            membership: { tier: 'free' },
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          };
          await setDoc(uref, seed);
          return seed;
        }
        return snap.data();
      }

      /* ===== getMatches helper ===== */
      async function getMatchesForMe(uid) {
        const qy = query(collection(db, 'matches'), where('uids', 'array-contains', uid));
        const snap = await getDocs(qy);
        const rows = [];
        snap.forEach((d) => rows.push({ id: d.id, ...d.data() }));
        rows.sort((a, b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
        const partnerIds = [];
        rows.forEach((d) => {
          const arr = d.uids || [];
          const other = arr.find((x) => x !== uid);
          if (other) partnerIds.push(other);
        });
        const out = [];
        for (const uid of partnerIds) {
          const snapUser = await getDoc(doc(db, 'users', uid));
          if (snapUser.exists()) out.push({ uid, ...snapUser.data() });
        }
        return out;
      }

      /* ===== Browse button ===== */
      document.getElementById('browseBtn').addEventListener('click', async () => {
        if (!profileComplete) {
          alert('Please complete your profile before browsing.');
          document.getElementById('editModal').style.display = 'flex';
          return;
        }
        if (!me || !myDocCached) return;
        const list = await getMatchesForMe(me.uid);
        matches = Array.isArray(list) && list.length ? list : [myDocCached];
        currentIndex = 0;
        renderProfile(matches[currentIndex] || null);
        // open matches inbox tab
        await renderInbox('matches');
      });

      /* ===== Swipe and Like / Pass Buttons ===== */
      document.getElementById('pass-btn').addEventListener('click', () => {
        showIndicator('pass');
        setTimeout(() => {
          showIndicator(null);
          currentIndex++;
          renderProfile(matches[currentIndex] || null);
        }, 120);
      });
      document.getElementById('like-btn').addEventListener('click', () => {
        showIndicator('like');
        const current = matches[currentIndex];
        if (current && current.uid && me && current.uid !== me.uid) {
          recordLike(current.uid);
        }
        setTimeout(() => {
          showIndicator(null);
          currentIndex++;
          renderProfile(matches[currentIndex] || null);
        }, 120);
      });

      /* ===== Editing and Saving ===== */
      function validateBeforeSave(currentDoc, filesPending) {
        const pending = (filesPending && filesPending.length) || 0;
        const saved = Array.isArray(currentDoc?.photos) ? currentDoc.photos : [];
        const hasPhoto = saved.length > 0 || pending > 0 || !!currentDoc?.photoURL;
        if (REQUIRED.PHOTO && !hasPhoto)
          return { ok: false, message: 'Add at least one photo before saving.', focus: 'photo' };
        const loc = (locationInput.value || '').trim();
        if (REQUIRED.LOCATION && !loc)
          return { ok: false, message: 'Please enter your location before saving.', focus: 'location' };
        const dn = (displayNameInput.value || '').trim();
        if (REQUIRED.DISPLAY_NAME && !dn)
          return { ok: false, message: 'Please enter your display name before saving.', focus: 'displayName' };
        if (REQUIRED.AGE) {
          const a = Number(ageInput.value);
          if (!Number.isFinite(a) || a < 18 || a > 100) return { ok: false, message: 'Please enter a valid age (18-100).', focus: 'age' };
        }
        const genderVal = (genderInput?.value || '').trim();
        if (!genderVal) return { ok: false, message: 'Please select your gender.', focus: 'gender' };
        const hobbiesVal = (hobbiesInput?.value || '').trim();
        if (!hobbiesVal) return { ok: false, message: 'Please list your hobbies.', focus: 'hobbies' };
        const interestsVal = (interestsInput?.value || '').trim();
        if (!interestsVal) return { ok: false, message: 'Please list your interests.', focus: 'interests' };
        return { ok: true };
      }
      function refreshSaveButtonState(currentDoc) {
        const res = validateBeforeSave(currentDoc, avatarInput.files);
        document.getElementById('saveEdit').disabled = !res.ok;
        if (!res.ok) uploadStatus.innerHTML = `<span class="prog">${res.message}</span>`;
        else uploadStatus.textContent = '';
      }
      function focusInvalid(key) {
        const elMap = {
          location: locationInput,
          displayName: displayNameInput,
          age: ageInput,
          gender: genderInput,
          hobbies: hobbiesInput,
          interests: interestsInput
        };
        const el = elMap[key];
        if (el) {
          el.classList.add('invalid');
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          el.focus();
        }
        if (key === 'photo') {
          avatarInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }
      [displayNameInput, usernameInput, ageInput, locationInput, bioInput].forEach((el) =>
        el?.addEventListener('input', () => refreshSaveButtonState(myDocCached))
      );
      genderInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      hobbiesInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      interestsInput?.addEventListener('input', () => refreshSaveButtonState(myDocCached));
      avatarInput.addEventListener('change', (e) => {
        renderPreviews(e.target.files);
        refreshSaveButtonState(myDocCached);
      });

      /* ===== Inbox UI ===== */
      async function renderInbox(tab) {
        // update tab highlight
        const allTabs = inboxTabs.querySelectorAll('.inbox-tab');
        allTabs.forEach((tabBtn) => tabBtn.classList.toggle('active', tabBtn.dataset.tab === tab));
        inboxList.innerHTML = "<div class='muted'>Loading...</div>";
        let items = [];
        try {
          items = await TAB_FUNCS[tab](me.uid);
        } catch (err) {
          console.error(err);
          inboxList.innerHTML = "<div class='muted'>Could not load. Try again.</div>";
          return;
        }
        // render items
        inboxList.innerHTML = '';
        if (!items.length) {
          inboxList.innerHTML = "<div class='muted'>Nothing here yet.</div>";
          return;
        }
        for (const u of items) {
          let trailing = '';
          if (tab === 'matches' || tab === 'messages') {
            trailing = `<div style="margin-top:6px;display:flex;gap:6px">
                          <button class="btn small" data-chat="${u.uid}">Message</button>
                          <button class="btn danger small" data-open="${u.uid}">View</button>
                        </div>`;
          }
          const card = userCard(u, { locked: false, trailing });
          card.querySelector('img')?.addEventListener('click', () => showPublicProfile(u));
          card.querySelector(`[data-open="${u.uid}"]`)?.addEventListener('click', () => showPublicProfile(u));
          card.querySelector(`[data-chat="${u.uid}"]`)?.addEventListener('click', () => openChatWith(u));
          inboxList.appendChild(card);
        }
      }

      /* ===== Delete Account ===== */
      async function handleDeleteAccount() {
        if (!me) return;
        const confirmText = prompt('Type DELETE to permanently remove your account (this cannot be undone).');
        if (confirmText !== 'DELETE') return;
        try {
          const lastSignIn = me.metadata?.lastSignInTime ? new Date(me.metadata.lastSignInTime).getTime() : 0;
          const needsReauth = Date.now() - lastSignIn > 5 * 60 * 1000;
          if (needsReauth && me.providerData.some((p) => p.providerId === 'password')) {
            const email = me.email;
            const pwd = prompt('Re-enter your password to confirm delete:');
            if (!pwd) return alert('Deletion cancelled.');
            const cred = EmailAuthProvider.credential(email, pwd);
            await reauthenticateWithCredential(me, cred);
          }
        } catch (e) {
          alert('Re-auth failed. Cannot delete account.');
          return;
        }
        try {
          await deleteDoc(doc(db, 'users', me.uid));
        } catch (e) {
          console.warn('User doc delete:', e.message);
        }
        try {
          await deleteStorageFolder(`avatars/${me.uid}`);
        } catch (e) {
          console.warn('Storage delete:', e.message);
        }
        try {
          await deleteRelatedDocs(me.uid);
        } catch (e) {
          console.warn('Related cleanup:', e.message);
        }
        try {
          await deleteUser(me);
          alert('Your account has been deleted.');
          location.replace('./signup.html');
        } catch (e) {
          console.warn('Auth delete failed:', e?.code || e?.message);
          alert('Your data has been removed. Please sign in again to fully remove the auth account.');
          try {
            await signOut(auth);
          } catch {}
          location.replace('./login.html');
        }
      }
      document.getElementById('deleteBtn')?.addEventListener('click', handleDeleteAccount);

    </script>

    <!-- Optional auth status script -->
    <script type="module">
      import { waitForAuth } from '/js/firebase.js';
      (async () => {
        const user = await waitForAuth();
        console.log('Current user:', user ? user.uid : null);
        if (!user) {
          console.warn('Not signed in — Storage rules will block uploads (403).');
        }
      })();
    </script>
  </body>
</html>
