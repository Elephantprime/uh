<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNHINGED â€” App</title>
  <meta name="theme-color" content="#E11D2A" />
  <link rel="icon" href="/favicon.ico" />
  <style>
    :root{ --red:#E11D2A; --panel:#171923; --muted:#b8b9c6; --radius:16px; }
    *{ box-sizing:border-box }
    html,body{ margin:0; background:#0f0f12; color:#fff; font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial }
    a{ color:inherit; text-decoration:none }
    .wrap{ max-width:1280px; margin:0 auto; padding:16px }
    header{ border-bottom:1px solid rgba(255,255,255,.06) }
    .bar{ display:flex; justify-content:space-between; align-items:center; gap:12px }
    .logo{ display:flex; align-items:center; gap:10px }
    .mark{ width:28px; height:28px; background:var(--red); border-radius:8px }
    .word{ font-weight:1000 }
    nav{ display:flex; gap:10px }
    .btn{ display:inline-flex; align-items:center; border:1px solid rgba(255,255,255,.12); padding:10px 14px; border-radius:12px; font-weight:800; background:transparent; cursor:pointer }
    .btn.primary{ background:var(--red); border-color:var(--red); color:#fff }
    .btn.ghost{ background:transparent }
    .card{ background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:var(--radius); overflow:hidden }
    .card h2{ margin:0; padding:14px 14px; border-bottom:1px solid rgba(255,255,255,.06); background:#12131a; position:relative }
    .card-body{ padding:14px }

    /* ===== Promo row (Badges / Flags / Casualties) ===== */
    .promoRow{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:18px }
    .promoLeft{ display:grid; grid-template-rows:1fr 1fr; gap:18px }
    .promoRight{ display:flex; flex-direction:column }
    .promoCardLink{ display:block; text-decoration:none }
    .promoBig{ display:flex; flex-direction:column; height:100% }
    .promoCenter{ flex:1; display:flex; align-items:center; justify-content:center }

    /* Embedded SVGs so there are no path issues */
    .promoBadge{ width:140px; height:140px; border-radius:24px; background:url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20320%20360%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%22g%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%231f2937%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%230f172a%22/%3E%0A%20%20%20%20%3C/linearGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%230b1020%22/%3E%0A%20%20%3Cpath%20d%3D%22M160%2028%20L280%2076%20L260%20242%20Q210%20306%20160%20322%20Q110%20306%2060%20242%20L40%2076%20Z%22%0A%20%20%20%20%20%20%20%20fill%3D%22url%28%23g%29%22%20stroke%3D%22%2394a3b8%22%20stroke-width%3D%226%22/%3E%0A%20%20%3Ccircle%20cx%3D%22160%22%20cy%3D%22150%22%20r%3D%2244%22%20fill%3D%22%230f172a%22%20stroke%3D%22%2338bdf8%22%20stroke-width%3D%226%22/%3E%0A%20%20%3Cpath%20d%3D%22M142%20150%20l12%2012%2024%20-30%22%20fill%3D%22none%22%20stroke%3D%22%2338bdf8%22%20stroke-width%3D%228%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22/%3E%0A%20%20%3Cg%3E%0A%20%20%20%20%3Crect%20x%3D%2270%22%20y%3D%22248%22%20width%3D%22180%22%20height%3D%2248%22%20rx%3D%2224%22%20fill%3D%22%2338bdf8%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%22160%22%20y%3D%22279%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20ui-sans-serif%2C%20system-ui%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%230b1020%22%20letter-spacing%3D%221.5%22%3EBADGES%3C/text%3E%0A%20%20%3C/g%3E%0A%3C/svg%3E') center/contain no-repeat; box-shadow:0 10px 28px rgba(225,29,42,.35) }
    .promoFlag{  width:140px; height:140px; border-radius:24px; background:url('data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20320%20360%22%3E%0A%20%20%3Cdefs%3E%0A%20%20%20%20%3ClinearGradient%20id%3D%22r%22%20x1%3D%220%22%20y1%3D%220%22%20x2%3D%221%22%20y2%3D%221%22%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%220%25%22%20stop-color%3D%22%236b0f1a%22/%3E%0A%20%20%20%20%20%20%3Cstop%20offset%3D%22100%25%22%20stop-color%3D%22%23230006%22/%3E%0A%20%20%20%20%3C/linearGradient%3E%0A%20%20%3C/defs%3E%0A%20%20%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22%230b1020%22/%3E%0A%20%20%3Crect%20x%3D%2280%22%20y%3D%2280%22%20width%3D%2214%22%20height%3D%22200%22%20rx%3D%227%22%20fill%3D%22%2394a3b8%22/%3E%0A%20%20%3Cpolygon%20points%3D%2294%2C110%20260%2C150%2094%2C190%22%20fill%3D%22url%28%23r%29%22%20stroke%3D%22%23E11D2A%22%20stroke-width%3D%226%22/%3E%0A%20%20%3Cg%3E%0A%20%20%20%20%3Crect%20x%3D%2270%22%20y%3D%22248%22%20width%3D%22180%22%20height%3D%2248%22%20rx%3D%2224%22%20fill%3D%22%23E11D2A%22/%3E%0A%20%20%20%20%3Ctext%20x%3D%22160%22%20y%3D%22279%22%20text-anchor%3D%22middle%22%20font-family%3D%22Inter%2C%20ui-sans-serif%2C%20system-ui%22%20font-weight%3D%22900%22%20font-size%3D%2226%22%20fill%3D%22%230b1020%22%20letter-spacing%3D%221.5%22%3EFLAGS%3C/text%3E%0A%20%20%3C/g%3E%0A%3C/svg%3E')  center/contain no-repeat; box-shadow:0 10px 18px rgba(225,29,42,.35) }

    .subtle{ color:var(--muted); font-size:13px }

    /* ===== Main grid ===== */
    .gridTop{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:18px }
    .gridBottom{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:18px }
    .bigPane{ min-height:68vh; display:flex; flex-direction:column }
    .smallPane{ min-height:48vh; display:flex; flex-direction:column }

    /* ===== Live stream ===== */
    .live-box{ height:100%; min-height:52vh; background:#000; border-radius:14px; display:flex; align-items:center; justify-content:center }
    .live-pill{ position:absolute; right:14px; top:12px; display:inline-flex; gap:6px; align-items:center; font-size:12px; border:1px solid rgba(255,255,255,.16); padding:4px 8px; border-radius:999px; background:#1a1b22 }
    .dot{ width:8px; height:8px; border-radius:50%; background:#ff4d5e; animation:blink 1.2s infinite }
    @keyframes blink{ 50%{ opacity:.35 } }

    /* ===== Chat ===== */
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .muted{ color:var(--muted) }
    input,select,textarea{ padding:10px; border-radius:10px; border:1px solid #2a2c3a; background:#12131a; color:#fff }
    .chat-feed{ flex:1; min-height:0; height:100%; max-height:calc(68vh - 160px); overflow:auto; background:#0e0f14; border:1px solid #2a2c39; border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px }
    .bubble{ max-width:78%; padding:10px 12px; border-radius:12px; word-wrap:break-word }
    .me{ align-self:flex-end; background:var(--red) }
    .them{ align-self:flex-start; background:#2a2a36 }
    .chat-send{ display:flex; gap:8px; margin-top:10px }
    .chat-send input{ flex:1 }

    /* ===== Boards ===== */
    .list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:10px }
    .item{ border:1px solid #2a2c39; background:#12131a; border-radius:12px; padding:10px; cursor:pointer }
    .title{ font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .meta{ font-size:12px; color:var(--muted); margin-top:4px }

    /* ===== Modal ===== */
    .modal-backdrop{ position:fixed; inset:0; background:#0009; display:none; align-items:center; justify-content:center; padding:16px; z-index:50 }
    .modal{ width:100%; max-width:520px; background:#171923; border:1px solid #2a2c39; border-radius:14px; padding:14px }
    .modal h3{ margin:0 0 8px }
    .actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px }

    /* ===== Responsive ===== */
    @media (max-width:960px){
      .gridTop, .gridBottom{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header>
    <div class="wrap bar">
      <div class="logo">
        <div class="mark"></div>
        <div class="word">UNHINGED</div>
      </div>
      <nav>
        <a class="btn" href="./profile.html">Profile</a>
        <a class="btn" href="./login.html">Log in</a>
        <a class="btn primary" href="./signup.html">Join</a>
      </nav>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="wrap">

    <!-- ===== Promo Row (left: badges/flags; right: casualties uploader) ===== -->
    <div class="promoRow">

      <!-- Left column: two stacked cards -->
      <div class="promoLeft">
        <!-- Badges (links within /public since app.html sits in /public) -->
        <a class="promoCardLink" href="./badges.html">
          <section class="card promoBig">
            <h2>Badges</h2>
            <div class="card-body promoCenter">
              <div class="promoBadge" aria-hidden="true"></div>
            </div>
            <div class="card-body" style="border-top:1px solid rgba(255,255,255,.06)">
              <div class="subtle">Tap to view all badges</div>
            </div>
          </section>
        </a>

        <!-- Red Flags -->
        <a class="promoCardLink" href="./redflags.html">
          <section class="card promoBig">
            <h2>Red Flags</h2>
            <div class="card-body promoCenter">
              <div class="promoFlag" aria-hidden="true"></div>
            </div>
            <div class="card-body" style="border-top:1px solid rgba(255,255,255,.06)">
              <div class="subtle">Tap to view all flags</div>
            </div>
          </section>
        </a>
      </div>

      <!-- Right column: Casualties of Modern Dating -->
      <section class="card promoRight">
        <h2>Casualties of Modern Dating</h2>
        <div class="card-body" style="display:flex; flex-direction:column; gap:10px; flex:1">
          <div class="muted">Upload a short image or video (preview below).</div>
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <input type="file" id="codVideo" accept="image/*,video/*" />
            <button class="btn primary" id="codUpload" style="padding:6px 10px; font-size:12px">Upload</button>
            <div id="codStatus" class="muted" style="font-size:12px"></div>
          </div>
          <div id="codPreview" style="flex:1; border:1px dashed #2a2c39; border-radius:12px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#0f1016">
            <span style="opacity:.7">Preview area</span>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== Top Row: Live + Chat ===== -->
    <div class="gridTop">

      <!-- Live Stream -->
      <section class="card bigPane">
        <h2>Live Stream <span class="live-pill"><span class="dot"></span> LIVE</span></h2>
        <div class="card-body" style="flex:1; display:flex;">
          <div class="live-box" style="flex:1;"><span style="opacity:.65">[ Embed live stream here ]</span></div>
        </div>
      </section>

      <!-- Chat Room -->
      <section class="card bigPane">
        <h2>Chat Room</h2>
        <div class="card-body" style="display:flex; flex-direction:column; gap:10px; flex:1">

          <!-- Top controls -->
          <div class="row" style="justify-content:space-between">
            <div class="muted" id="meTag">(not in chat)</div>
            <div class="row">
              <button class="btn primary" id="enterChatBtn">Enter Chat</button>
              <button class="btn" id="leaveChatBtn" style="display:none">Leave</button>
            </div>
          </div>

          <!-- Room selector -->
          <div class="row" id="roomBar" style="display:none">
            <label class="muted" for="roomSelect">Room</label>
            <select id="roomSelect"></select>
          </div>

          <!-- Feed -->
          <div class="chat-feed" id="chatFeed" aria-live="polite"></div>

          <!-- Send row -->
          <div class="chat-send" id="sendRow" style="display:none">
            <input id="chatInput" placeholder="Type a messageâ€¦" />
            <button class="btn primary" id="chatSend">Send</button>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== Bottom Row: Boards ===== -->
    <div class="gridBottom">

      <!-- Chaos Board -->
      <section class="card smallPane">
        <h2>Chaos Board</h2>
        <div class="card-body" style="display:flex; flex-direction:column; gap:10px; flex:1">
          <div class="row" style="justify-content:space-between">
            <div></div>
            <button class="btn primary" id="uploadChaos">Submit Chaos Story</button>
          </div>
          <div class="list" id="chaosList"></div>
        </div>
      </section>

      <!-- Review Board -->
      <section class="card smallPane">
        <h2>Review Board</h2>
        <div class="card-body" style="display:flex; flex-direction:column; gap:10px; flex:1">
          <div class="row" style="justify-content:space-between">
            <div></div>
            <button class="btn primary" id="uploadReview">Submit Review</button>
          </div>
          <div class="list" id="reviewList"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- ===== Chaos Submit Modal ===== -->
  <div class="modal-backdrop" id="chaosModal">
    <div class="modal">
      <h3>Submit Chaos Story</h3>
      <label class="muted" for="cTitle">Title (max 60 chars)</label>
      <input id="cTitle" maxlength="60" placeholder="Walked Out on the Check" />
      <label class="muted" for="cAbout" style="margin-top:8px">About (name or @username)</label>
      <input id="cAbout" placeholder="@TheirHandle or Name" />
      <label class="muted" for="cBody" style="margin-top:8px">Story</label>
      <textarea id="cBody" rows="5" placeholder="Tell us what happenedâ€¦"></textarea>
      <div class="actions">
        <button class="btn" id="cCancel">Cancel</button>
        <button class="btn primary" id="cSave">Submit</button>
      </div>
    </div>
  </div>

  <!-- ===== Review Submit Modal ===== -->
  <div class="modal-backdrop" id="reviewModal">
    <div class="modal">
      <h3>Submit Review</h3>
      <label class="muted" for="rTitle">Title (max 60 chars)</label>
      <input id="rTitle" maxlength="60" placeholder="Good Chat, No Show" />
      <label class="muted" for="rAbout" style="margin-top:8px">About (name or @username)</label>
      <input id="rAbout" placeholder="@TheirHandle or Name" />
      <label class="muted" for="rBody" style="margin-top:8px">Review</label>
      <textarea id="rBody" rows="5" placeholder="Keep receipts, keep it realâ€¦"></textarea>
      <div class="actions">
        <button class="btn" id="rCancel">Cancel</button>
        <button class="btn primary" id="rSave">Submit</button>
      </div>
    </div>
  </div>

  <!-- ===== Detail Modal (shared) ===== -->
  <div class="modal-backdrop" id="detailModal">
    <div class="modal">
      <h3 id="detailTitle">Title</h3>
      <div class="muted" id="detailMeta" style="margin-bottom:8px"></div>
      <div id="detailBody" style="white-space:pre-wrap"></div>
      <div class="actions">
        <button class="btn" id="detailClose">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== Scripts ===== -->
  <script type="module">
    /* Firebase imports */
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* Rooms config */
    const ROOMS = [
      { id: "general",      label: "#general" },
      { id: "first-dates",  label: "#first-dates" },
      { id: "gym-rats",     label: "#gym-rats" },
      { id: "chaos-lounge", label: "#chaos-lounge" }
    ];

    /* State */
    let me = null;
    let myDisplayName = "";
    let currentRoom = ROOMS[0].id;
    let unsubFeed = null;

    /* DOM refs */
    const meTag       = document.getElementById("meTag");
    const enterChatBtn= document.getElementById("enterChatBtn");
    const leaveChatBtn= document.getElementById("leaveChatBtn");
    const roomBar     = document.getElementById("roomBar");
    const roomSelect  = document.getElementById("roomSelect");
    const chatFeed    = document.getElementById("chatFeed");
    const sendRow     = document.getElementById("sendRow");
    const chatInput   = document.getElementById("chatInput");
    const chatSend    = document.getElementById("chatSend");

    const chaosList   = document.getElementById("chaosList");
    const reviewList  = document.getElementById("reviewList");
    const chaosModal  = document.getElementById("chaosModal");
    const cTitle      = document.getElementById("cTitle");
    const cAbout      = document.getElementById("cAbout");
    const cBody       = document.getElementById("cBody");
    const cCancel     = document.getElementById("cCancel");
    const cSave       = document.getElementById("cSave");
    const reviewModal = document.getElementById("reviewModal");
    const rTitle      = document.getElementById("rTitle");
    const rAbout      = document.getElementById("rAbout");
    const rBody       = document.getElementById("rBody");
    const rCancel     = document.getElementById("rCancel");
    const rSave       = document.getElementById("rSave");

    const detailModal = document.getElementById("detailModal");
    const detailTitle = document.getElementById("detailTitle");
    const detailMeta  = document.getElementById("detailMeta");
    const detailBody  = document.getElementById("detailBody");
    const detailClose = document.getElementById("detailClose");

    /* Helpers */
    function open(el){ el.style.display = "flex"; }
    function close(el){ el.style.display = "none"; }

    function setSigned(on){
      const label = (ROOMS.find(r => r.id === currentRoom)?.label) || "#general";
      meTag.textContent = on ? `In ${label} as ${myDisplayName}` : "(not in chat)";
      enterChatBtn.style.display = on ? "none" : "inline-flex";
      leaveChatBtn.style.display = on ? "inline-flex" : "none";
      roomBar.style.display = on ? "flex" : "none";
      sendRow.style.display = on ? "flex" : "none";
    }

    function renderRooms(){
      roomSelect.innerHTML = "";
      ROOMS.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r.id;
        opt.textContent = r.label;
        if (r.id === currentRoom) opt.selected = true;
        roomSelect.appendChild(opt);
      });
    }

    function renderMessage(m){
      const b = document.createElement("div");
      b.className = "bubble " + (m.from === myDisplayName ? "me" : "them");
      b.textContent = `${m.from}: ${m.text}`;
      chatFeed.appendChild(b);
    }

    function clearFeed(){ chatFeed.innerHTML = ""; }

    async function bindRoomFeed(){
      if (unsubFeed){ unsubFeed(); unsubFeed = null; }
      clearFeed();
      const col = collection(db, "rooms", currentRoom, "messages");
      const qy = query(col, orderBy("createdAt","asc"), limit(500));
      unsubFeed = onSnapshot(qy, (snap) => {
        clearFeed();
        snap.forEach(d => {
          const m = d.data();
          renderMessage({ from: m.from || "anon", text: m.text || "" });
        });
        chatFeed.scrollTop = chatFeed.scrollHeight;
      });
    }

    async function sendMessage(){
      const text = chatInput.value.trim();
      if (!text) return;
      if (!me){ location.href = "./login.html"; return; }
      if (!myDisplayName){ alert("Your profile needs a username/display name."); return; }
      const col = collection(db, "rooms", currentRoom, "messages");
      await addDoc(col, { from: myDisplayName, text, createdAt: serverTimestamp(), uid: me.uid });
      chatInput.value = "";
    }

    function bestVisibleNameFromDoc(docData){
      const uname = (docData?.username || "").trim();
      const disp  = (docData?.displayName || "").trim();
      if (uname) return uname.startsWith("@") ? uname : "@"+uname;
      if (disp)  return disp;
      return "";
    }

    /* Boards (demo in-memory) */
    const chaosItems = [{
      title: "Walked Out on the Check",
      author: "@Rae25",
      about: "@Jamie27",
      body: "We agreed to split. They â€˜forgotâ€™ their wallet. I left a bigger tip for the server and a smaller chance for a second date."
    }];

    const reviewItems = [{
      title: "Great Banter, Late Arrival",
      author: "@Andre31",
      about: "@Rae25",
      body: "Funny, sharp, showed with coffeeâ€¦ 18 minutes late. Would try againâ€”with a buffer."
    }];

    function escapeHtml(s){
      return (s || "").replace(/[&<>"]/g, c => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", """:"&quot;" }[c]));
    }

    function renderBoard(listEl, items){
      listEl.innerHTML = "";
      items.forEach((it) => {
        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="title" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
          <div class="meta">by ${escapeHtml(it.author)} about ${escapeHtml(it.about)}</div>
        `;
        card.addEventListener("click", () => {
          detailTitle.textContent = it.title;
          detailMeta.textContent  = \`by \${it.author} about \${it.about}\`;
          detailBody.textContent  = it.body;
          open(detailModal);
        });
        listEl.appendChild(card);
      });
    }

    /* Submit handlers */
    document.getElementById("uploadChaos").addEventListener("click", () => open(chaosModal));
    document.getElementById("uploadReview").addEventListener("click", () => open(reviewModal));
    document.getElementById("cCancel").addEventListener("click", () => close(chaosModal));
    document.getElementById("rCancel").addEventListener("click", () => close(reviewModal));
    document.getElementById("detailClose").addEventListener("click", () => close(detailModal));
    chaosModal.addEventListener("click", (e) => { if (e.target === chaosModal) close(chaosModal); });
    reviewModal.addEventListener("click", (e) => { if (e.target === reviewModal) close(reviewModal); });

    document.getElementById("cSave").addEventListener("click", () => {
      const title = (cTitle.value || "").trim().slice(0,60);
      const about = (cAbout.value || "").trim();
      const body  = (cBody.value  || "").trim();
      if (!title || !about || !body) return;
      const author = myDisplayName || "Member";
      chaosItems.unshift({ title, author, about, body });
      renderBoard(chaosList, chaosItems);
      cTitle.value = ""; cAbout.value = ""; cBody.value = "";
      close(chaosModal);
    });

    document.getElementById("rSave").addEventListener("click", () => {
      const title = (rTitle.value || "").trim().slice(0,60);
      const about = (rAbout.value || "").trim();
      const body  = (rBody.value  || "").trim();
      if (!title || !about || !body) return;
      const author = myDisplayName || "Member";
      reviewItems.unshift({ title, author, about, body });
      renderBoard(reviewList, reviewItems);
      rTitle.value = ""; rAbout.value = ""; rBody.value = "";
      close(reviewModal);
    });

    /* Chat controls */
    enterChatBtn.addEventListener("click", async () => {
      if (!me){ location.href = "./login.html"; return; }
      if (!myDisplayName){ alert("Your profile needs a username/display name."); return; }
      setSigned(true);
      renderRooms();
      await bindRoomFeed();
      chatInput.focus();
    });

    leaveChatBtn.addEventListener("click", () => {
      if (unsubFeed){ unsubFeed(); unsubFeed = null; }
      setSigned(false);
    });

    roomSelect.addEventListener("change", async (e) => {
      currentRoom = e.target.value;
      if (leaveChatBtn.style.display !== "none") await bindRoomFeed();
    });

    chatSend.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

    /* Auth: read users/{uid} to get a visible name */
    onAuthStateChanged(auth, async (user) => {
      me = user || null;
      myDisplayName = "";
      if (me){
        try {
          const uref = doc(db, "users", me.uid);
          const snap = await getDoc(uref);
          if (snap.exists()) myDisplayName = bestVisibleNameFromDoc(snap.data());
          if (!myDisplayName){
            const emailName = (me.email || "").split("@")[0];
            myDisplayName = emailName || "Member";
          }
        } catch (e){
          const emailName = (me?.email || "").split("@")[0];
          myDisplayName = emailName || "Member";
        }
      }
      setSigned(false);
    });

    /* Casualties preview */
    const codVideo  = document.getElementById("codVideo");
    const codUpload = document.getElementById("codUpload");
    const codStatus = document.getElementById("codStatus");
    const codPreview= document.getElementById("codPreview");

    function showPreview(file){
      if (!file) return;
      codPreview.innerHTML = "";
      const url = URL.createObjectURL(file);
      let el;
      if (file.type.startsWith("image/")){
        el = document.createElement("img");
        el.src = url;
        el.alt = "Preview";
        el.style.maxWidth = "100%";
        el.style.maxHeight = "100%";
        el.style.objectFit = "contain";
      } else if (file.type.startsWith("video/")){
        el = document.createElement("video");
        el.src = url;
        el.controls = true;
        el.playsInline = true;
        el.style.maxWidth = "100%";
        el.style.maxHeight = "100%";
        el.style.objectFit = "contain";
      } else {
        const t = document.createElement("div");
        t.textContent = "Unsupported file type.";
        t.style.opacity = "0.8";
        el = t;
      }
      codPreview.appendChild(el);
      codStatus.textContent = `Ready: ${file.name}`;
    }

    codVideo?.addEventListener("change", (e) => {
      const f = e.target.files?.[0];
      showPreview(f);
    });

    codUpload?.addEventListener("click", () => {
      const f = codVideo.files?.[0];
      if (!f){ codStatus.textContent = "Select a file first."; return; }
      showPreview(f);
    });

    /* Init */
    (function init(){
      renderRooms();
      renderBoard(chaosList, chaosItems);
      renderBoard(reviewList, reviewItems);
    })();
  </script>
</body>
</html>
