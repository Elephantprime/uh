<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNHINGED — App</title>
  <meta name="theme-color" content="#E11D2A" />

  <!-- STYLES -->
  <style>
    :root{
      --red:#E11D2A; --ink:#0F0F12; --charcoal:#141418; --panel:#171923;
      --muted:#b8b9c6; --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#0e0e12,#141418);color:#fff;font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}

    /* Header */
    header{border-bottom:1px solid rgba(255,255,255,.06);}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .mark{width:28px;height:28px;background:conic-gradient(from 180deg at 50% 50%, var(--red) 0 75%, #8b0e16 75% 100%);border-radius:8px;box-shadow:0 6px 22px rgba(225,29,42,.35)}
    .word{font-weight:1000;letter-spacing:.02em}
    nav{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-weight:800;background:transparent}
    .btn.primary{background:var(--red);border-color:var(--red)}
    .btn.small{padding:8px 10px;font-size:14px}

    /* Layout: 2 big panes */
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06);background:#12131a}
    .card-body{padding:12px}

    /* Live stream */
    .stream-wrap{display:flex;flex-direction:column;gap:10px}
    .ratio{position:relative;width:100%;padding-top:56.25%;background:#0b0c12;border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
    .ratio iframe,.ratio video{position:absolute;inset:0;width:100%;height:100%;border:0}
    .stream-controls{display:flex;gap:8px;flex-wrap:wrap}
    input[type="text"],select{background:#11131b;color:#fff;border:1px solid #272938;border-radius:10px;padding:10px}

    /* Chat */
    .chat-shell{display:grid;grid-template-rows:auto 1fr auto;gap:10px;height:70vh;min-height:540px}
    .chat-top{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:#1b1d29;border:1px solid #2b2d3a;border-radius:999px;padding:6px 10px;font-size:13px}
    .chat-feed{background:#0f111a;border:1px solid #2a2c39;border-radius:12px;overflow:auto;padding:10px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:76%;padding:8px 10px;border-radius:12px;word-wrap:break-word}
    .me{align-self:flex-end;background:#E11D2A}
    .them{align-self:flex-start;background:#232538}
    .chat-send{display:flex;gap:8px}
    .chat-send input{flex:1;background:#11131b;color:#fff;border:1px solid #272938;border-radius:10px;padding:10px}
    .chat-join{display:grid;gap:10px}
    .help{color:var(--muted);font-size:13px}

    /* Drawer */
    .drawer{position:fixed;top:0;right:0;bottom:0;width:320px;background:#0e1018;border-left:1px solid #2a2b36;box-shadow:-12px 0 28px rgba(0,0,0,.4);transform:translateX(100%);transition:transform .18s ease;z-index:80;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawer-header{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #242636}
    .drawer-body{padding:12px;overflow:auto;display:grid;gap:10px}
    .list{display:grid;gap:8px}
    .rowx{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#181a25;border:1px solid #2a2c3a;border-radius:999px;padding:6px 10px}

    @media (max-width:980px){ .grid2{grid-template-columns:1fr} .chat-shell{height:65vh} }
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="logo">
        <div class="mark"></div>
        <div class="word">UNHINGED</div>
      </div>
      <nav>
        <a class="btn" href="./profile.html">Profile</a>
        <a class="btn" href="./login.html">Log in</a>
        <a class="btn primary" href="./signup.html">Join</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="grid2">

      <!-- ===== START: LIVE STREAM ===== -->
      <section class="card" id="liveStreamPane">
        <h2>Live Stream</h2>
        <div class="card-body stream-wrap">
          <div class="ratio" id="streamFrame">
            <!-- placeholder iframe; you can paste any embeddable URL below -->
            <iframe id="streamIframe" src="" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
          </div>
          <div class="stream-controls">
            <select id="streamType">
              <option value="yt">YouTube</option>
              <option value="twitch">Twitch</option>
              <option value="custom">Custom embed</option>
            </select>
            <input id="streamInput" type="text" placeholder="Paste video/stream URL…" />
            <button class="btn small" id="applyStream">Load</button>
            <span class="help">Tip: paste a YouTube link or Twitch channel URL.</span>
          </div>
        </div>
      </section>
      <!-- ===== END: LIVE STREAM ===== -->

      <!-- ===== START: CHAT PANE ===== -->
      <section class="card" id="chatPane">
        <h2>Chat Room</h2>
        <div class="card-body chat-shell">

          <!-- Join gate -->
          <div id="joinView" class="chat-join">
            <div class="rowx">
              <label class="pill">Room
                <select id="roomSelect" style="margin-left:8px;background:#11131b;color:#fff;border:1px solid #272938;border-radius:8px;padding:6px 8px">
                  <option value="General">General</option>
                  <option value="FirstDates">FirstDates</option>
                  <option value="GymRats">GymRats</option>
                  <option value="ChaosConfessions">ChaosConfessions</option>
                </select>
              </label>
              <span class="help">Pick a room</span>
            </div>
            <input id="nameInput" type="text" placeholder="Enter a display name…" />
            <button class="btn primary" id="enterBtn">Enter Chat</button>
            <div class="help" id="joinHelp"></div>
          </div>

          <!-- Live chat -->
          <div id="chatView" style="display:none">
            <div class="chat-top">
              <div class="chip" id="roomChip">Room: General</div>
              <div class="chip" id="meChip">You: —</div>
              <button class="btn small" id="drawerBtn">Members & Rooms</button>
            </div>
            <div class="chat-feed" id="chatFeed" aria-live="polite" aria-relevant="additions"></div>
            <div class="chat-send">
              <input id="chatInput" type="text" placeholder="Type a message…" />
              <button class="btn primary" id="sendBtn">Send</button>
            </div>
          </div>

        </div>
      </section>
      <!-- ===== END: CHAT PANE ===== -->

    </div>
  </main>

  <!-- Drawer -->
  <aside class="drawer" id="drawer">
    <div class="drawer-header">
      <strong>Room & Members</strong>
      <button class="btn small" id="closeDrawer">Close</button>
    </div>
    <div class="drawer-body">
      <div>
        <div class="rowx" style="margin-bottom:6px">
          <strong>Rooms</strong>
        </div>
        <div class="list" id="roomsList"></div>
      </div>
      <div>
        <div class="rowx" style="margin:10px 0 6px">
          <strong>Online</strong>
          <span class="help" id="onlineCount">0</span>
        </div>
        <div class="list" id="membersList"></div>
      </div>
    </div>
  </aside>

  <!-- SCRIPTS -->
  <script type="module">
    /* ===== Imports ===== */
    import { auth, db } from "./js/firebase.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, doc, setDoc, addDoc, getDoc, onSnapshot,
      serverTimestamp, orderBy, query, limit, updateDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Live Stream minimal loader ===== */
    const streamType = document.getElementById("streamType");
    const streamInput = document.getElementById("streamInput");
    const applyStream = document.getElementById("applyStream");
    const streamIframe = document.getElementById("streamIframe");

    function toEmbedURL(type, raw){
      const url = (raw||"").trim();
      if(!url) return "";
      try{
        if(type==="yt"){
          // supports youtu.be/ID or youtube.com/watch?v=ID
          const u = new URL(url);
          if(u.hostname.includes("youtu.be")) return `https://www.youtube.com/embed/${u.pathname.slice(1)}?rel=0`;
          if(u.hostname.includes("youtube.com")){
            const id = u.searchParams.get("v");
            if(id) return `https://www.youtube.com/embed/${id}?rel=0`;
          }
          return url; // fallback
        }
        if(type==="twitch"){
          // expects https://www.twitch.tv/{channel}
          const u = new URL(url);
          const ch = u.pathname.replace(/\//g,"");
          if(ch) return `https://player.twitch.tv/?channel=${encodeURIComponent(ch)}&parent=${location.hostname}`;
          return url;
        }
        return url; // custom
      }catch{ return url; }
    }
    applyStream.addEventListener("click", ()=>{
      const src = toEmbedURL(streamType.value, streamInput.value);
      streamIframe.src = src;
    });

    /* ===== Chat (Firestore, multi-room) ===== */
    const joinView   = document.getElementById("joinView");
    const chatView   = document.getElementById("chatView");
    const roomSelect = document.getElementById("roomSelect");
    const nameInput  = document.getElementById("nameInput");
    const enterBtn   = document.getElementById("enterBtn");
    const joinHelp   = document.getElementById("joinHelp");

    const roomChip   = document.getElementById("roomChip");
    const meChip     = document.getElementById("meChip");
    const chatFeed   = document.getElementById("chatFeed");
    const chatInput  = document.getElementById("chatInput");
    const sendBtn    = document.getElementById("sendBtn");

    const drawer     = document.getElementById("drawer");
    const drawerBtn  = document.getElementById("drawerBtn");
    const closeDrawer= document.getElementById("closeDrawer");
    const roomsList  = document.getElementById("roomsList");
    const membersList= document.getElementById("membersList");
    const onlineCount= document.getElementById("onlineCount");

    const DEFAULT_ROOMS = ["General","FirstDates","GymRats","ChaosConfessions"];

    // state
    let my = { uid:null, name:"" };
    let currentRoom = "General";
    let unsubMsgs = null;
    let unsubMembers = null;
    let presenceTimer = null;

    // prefill name from auth/users doc if available
    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        // guest id
        const saved = localStorage.getItem("uh_guest_id");
        if(saved){ my.uid = saved; }
        else { my.uid = "guest_"+Math.random().toString(36).slice(2,10); localStorage.setItem("uh_guest_id", my.uid); }
        return;
      }
      my.uid = user.uid;
      // try user document for username/displayName
      try{
        const snap = await getDoc(doc(db,"users", user.uid));
        if(snap.exists()){
          const d = snap.data() || {};
          my.name = d.username || d.displayName || user.displayName || (user.email? user.email.split("@")[0] : "");
          nameInput.placeholder = my.name ? `Enter a display name… (suggested: ${my.name})` : "Enter a display name…";
        }else{
          my.name = user.displayName || (user.email? user.email.split("@")[0] : "");
          nameInput.placeholder = my.name ? `Enter a display name… (suggested: ${my.name})` : "Enter a display name…";
        }
      }catch{}
    });

    // drawer
    drawerBtn?.addEventListener("click", ()=> drawer.classList.add("open"));
    closeDrawer?.addEventListener("click", ()=> drawer.classList.remove("open"));

    function renderRooms(){
      roomsList.innerHTML = "";
      DEFAULT_ROOMS.forEach(r=>{
        const btn = document.createElement("button");
        btn.className = "btn small";
        btn.textContent = r;
        if(r===currentRoom){ btn.classList.add("primary"); }
        btn.addEventListener("click", ()=>{
          if(r!==currentRoom){
            switchRoom(r);
            drawer.classList.remove("open");
          }
        });
        roomsList.appendChild(btn);
      });
    }
    renderRooms();

    function asTime(ts){
      try{ return new Date(ts.seconds*1000).toLocaleTimeString(); }catch{return "";}
    }

    function renderMessage(m){
      const div = document.createElement("div");
      div.className = "bubble " + (m.fromId === my.uid ? "me" : "them");
      const who = m.fromName ? `<strong>${m.fromName}:</strong> ` : "";
      const text = (m.text||"").replace(/\n/g,"<br>");
      div.innerHTML = who + text;
      chatFeed.appendChild(div);
      chatFeed.scrollTop = chatFeed.scrollHeight;
    }

    function attachMessages(room){
      const qy = query(collection(db,"rooms",room,"messages"), orderBy("createdAt","asc"), limit(500));
      unsubMsgs = onSnapshot(qy, (snap)=>{
        chatFeed.innerHTML = "";
        snap.forEach(d=> renderMessage(d.data()));
      });
    }

    function attachMembers(room){
      unsubMembers = onSnapshot(collection(db,"rooms",room,"members"), (snap)=>{
        const now = Date.now();
        membersList.innerHTML = "";
        let count = 0;
        snap.forEach(d=>{
          const m = d.data();
          const last = m.lastSeen && m.lastSeen.seconds ? m.lastSeen.seconds*1000 : 0;
          const active = (now - last) < 90*1000; // seen within 90s
          const row = document.createElement("div");
          row.className = "rowx";
          row.innerHTML = `<span class="pill">${m.name || "Anonymous"}</span><span class="help">${active?"online":"away"}</span>`;
          membersList.appendChild(row);
          if(active) count++;
        });
        onlineCount.textContent = count;
      });
    }

    async function startPresence(room){
      stopPresence();
      const ref = doc(db,"rooms",room,"members", my.uid);
      await setDoc(ref, { name: my.name || "Anonymous", joinedAt: serverTimestamp(), lastSeen: serverTimestamp() }, { merge:true });
      presenceTimer = setInterval(async ()=>{
        try{ await updateDoc(ref, { name: my.name || "Anonymous", lastSeen: serverTimestamp() }); }catch{}
      }, 30000);
      window.addEventListener("beforeunload", ()=>{ try{ updateDoc(ref, { lastSeen: serverTimestamp() }); }catch{} }, { once:true });
    }
    function stopPresence(){
      if(presenceTimer){ clearInterval(presenceTimer); presenceTimer = null; }
      if(unsubMembers){ unsubMembers(); unsubMembers = null; }
    }

    function switchRoom(room){
      // detach old
      if(unsubMsgs){ unsubMsgs(); unsubMsgs = null; }
      stopPresence();
      currentRoom = room;
      roomChip.textContent = `Room: ${room}`;
      attachMessages(room);
      attachMembers(room);
      startPresence(room);
      renderRooms();
    }

    async function joinChat(){
      const desired = (nameInput.value || "").trim();
      my.name = desired || my.name || "Anonymous";
      if(!my.uid){ // ensure guest id exists
        const saved = localStorage.getItem("uh_guest_id");
        if(saved){ my.uid = saved; }
        else { my.uid = "guest_"+Math.random().toString(36).slice(2,10); localStorage.setItem("uh_guest_id", my.uid); }
      }
      const room = roomSelect.value || "General";
      roomChip.textContent = `Room: ${room}`;
      meChip.textContent = `You: ${my.name}`;
      joinView.style.display = "none";
      chatView.style.display = "";
      switchRoom(room);
    }

    function sendMsg(){
      const text = (chatInput.value||"").trim();
      if(!text) return;
      const ref = collection(db,"rooms",currentRoom,"messages");
      addDoc(ref, {
        fromId: my.uid,
        fromName: my.name || "Anonymous",
        text,
        createdAt: serverTimestamp()
      });
      chatInput.value = "";
    }

    enterBtn.addEventListener("click", joinChat);
    sendBtn.addEventListener("click", sendMsg);
    chatInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); } });

    /* Safety: default suggested name if auth available quickly */
    setTimeout(()=>{
      if(!nameInput.value && my.name){
        nameInput.placeholder = `Enter a display name… (suggested: ${my.name})`;
      }
    }, 800);
  </script>
</body>
</html>
```0
