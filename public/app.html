<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNHINGED — App</title>
  <meta name="theme-color" content="#E11D2A" />
  <style>
    :root{ --red:#E11D2A; --panel:#171923; --muted:#b8b9c6; --radius:16px; }
    *{box-sizing:border-box}
    html,body{margin:0;background:#0f0f12;color:#fff;font:500 16px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    header{border-bottom:1px solid rgba(255,255,255,.06)}
    .bar{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px}
    .mark{width:28px;height:28px;background:var(--red);border-radius:8px}
    .word{font-weight:1000}
    nav{display:flex;gap:10px}
    .btn{display:inline-flex;align-items:center;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;font-weight:800;background:transparent;cursor:pointer}
    .btn.primary{background:var(--red);border-color:var(--red);color:#fff}
    .btn.ghost{background:transparent}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);overflow:hidden}
    .card h2{margin:0;padding:14px;border-bottom:1px solid rgba(255,255,255,.06);background:#12131a;position:relative}
    .card-body{padding:14px}

    /* NEW: three-box promo row above Live Stream (2 on left stacked, 1 tall on right) */
    .promoRow{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .promoLeft{display:grid;grid-template-rows:1fr 1fr;gap:18px}
    .promoRight{display:flex;flex-direction:column}
    .promoCardLink{display:block;text-decoration:none}
    .promoBig{display:flex;flex-direction:column;height:100%}
    .promoCenter{flex:1;display:flex;align-items:center;justify-content:center;padding:12px}
    .subtle{color:var(--muted);font-size:13px}

    /* SVG helpers */
    .svgWrap{width:160px;max-width:60%;aspect-ratio:1/1;display:block}

    /* Big 2x2 layout */
    .gridTop{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .gridBottom{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:18px}
    .bigPane{min-height:68vh;display:flex;flex-direction:column}
    .smallPane{min-height:48vh;display:flex;flex-direction:column}

    /* Live stream */
    .live-box{height:100%;min-height:52vh;background:#000;border-radius:14px;display:flex;align-items:center;justify-content:center}
    .live-pill{position:absolute;right:14px;top:12px;display:inline-flex;gap:6px;align-items:center;font-size:12px;border:1px solid rgba(255,255,255,.16);padding:4px 8px;border-radius:999px;background:#1a1b22}
    .dot{width:8px;height:8px;border-radius:50%;background:#ff4d5e;animation:blink 1.2s infinite}
    @keyframes blink{50%{opacity:.35}}

    /* Chat */
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted)}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid #2a2c3a;background:#12131a;color:#fff}
    .chat-feed{flex:1;min-height:0;height:100%;max-height:calc(68vh - 160px);overflow:auto;background:#0e0f14;border:1px solid #2a2c39;border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    .bubble{max-width:78%;padding:10px 12px;border-radius:12px;word-wrap:break-word}
    .me{align-self:flex-end;background:var(--red)}
    .them{align-self:flex-start;background:#2a2a36}
    .chat-send{display:flex;gap:8px;margin-top:10px}
    .chat-send input{flex:1}

    /* Boards list */
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px}
    .item{border:1px solid #2a2c39;background:#12131a;border-radius:12px;padding:10px;cursor:pointer}
    .title{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta{font-size:12px;color:var(--muted);margin-top:4px}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal{width:100%;max-width:520px;background:#171923;border:1px solid #2a2c39;border-radius:14px;padding:14px}
    .modal h3{margin:0 0 8px}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Keep promoRow as 2 columns on mobile (per your request) */
    @media (max-width:960px){
      .gridTop,.gridBottom{grid-template-columns:1fr}
      /* promoRow remains 2 columns */
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap bar">
      <div class="logo"><div class="mark"></div><div class="word">UNHINGED</div></div>
      <nav>
        <a class="btn" href="./profile.html">Profile</a>
        <a class="btn" href="./login.html">Log in</a>
        <a class="btn primary" href="./signup.html">Join</a>
      </nav>
    </div>
  </header>

  <main class="wrap">

    <!-- NEW: THREE-BOX ROW ABOVE LIVE STREAM -->
    <div class="promoRow">
      <!-- Left: two stacked cards -->
      <div class="promoLeft">
        <!-- Badges (clickable to public/badges.html) -->
        <a class="promoCardLink" href="./public/badges.html">
          <section class="card promoBig">
            <h2>Badges</h2>
            <div class="card-body promoCenter">
              <!-- Medal/Badge SVG -->
              <svg class="svgWrap" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <!-- Ribbon -->
                <path d="M30 10h60l-10 30H40z" fill="#e11d2a"/>
                <path d="M40 10h40l-7 22H47z" fill="#b50f1b"/>
                <!-- Medal circle -->
                <circle cx="60" cy="70" r="26" fill="#f6c31c" />
                <circle cx="60" cy="70" r="22" fill="#ffd968" />
                <!-- Star -->
                <path d="M60 55l5.8 10.6 11.9 1.7-8.6 8.4 2 11.8L60 82.9 48.9 87l2-11.8-8.6-8.4 11.9-1.7z" fill="#ffef9c"/>
                <!-- Shine -->
                <circle cx="52" cy="62" r="6" fill="#fff" opacity=".35"/>
              </svg>
            </div>
            <div class="card-body" style="border-top:1px solid rgba(255,255,255,.06)">
              <div class="subtle">Tap to view all badges</div>
            </div>
          </section>
        </a>

        <!-- Red Flags (clickable to public/redflags.html) -->
        <a class="promoCardLink" href="./public/redflags.html">
          <section class="card promoBig">
            <h2>Red Flags</h2>
            <div class="card-body promoCenter">
              <!-- Red flag on pole SVG -->
              <svg class="svgWrap" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <!-- Pole -->
                <rect x="26" y="16" width="6" height="90" fill="#888"/>
                <!-- Flag -->
                <path d="M32 20h54l-10 14 10 14H32z" fill="#e11d2a"/>
                <path d="M32 20h30l-6 8 6 8H32z" fill="#b50f1b"/>
                <!-- Small shadow -->
                <rect x="26" y="16" width="6" height="90" fill="#000" opacity=".15"/>
              </svg>
            </div>
            <div class="card-body" style="border-top:1px solid rgba(255,255,255,.06)">
              <div class="subtle">Tap to view all flags</div>
            </div>
          </section>
        </a>
      </div>

      <!-- Right: tall card (same total height as two left stacked) -->
      <section class="card promoRight">
        <h2 style="text-align:center">
          Casualties of Modern Dating
        </h2>
        <div class="card-body" style="display:flex;flex-direction:column;gap:12px;flex:1">
          <!-- Password gate -->
          <div id="codLock">
            <div class="muted">Owner upload only. Enter password to unlock.</div>
            <div class="row">
              <input id="codPwd" type="password" placeholder="Password" />
              <button class="btn primary" id="codUnlock">Unlock</button>
            </div>
            <div id="codMsg" class="muted"></div>
          </div>

          <!-- Upload area (hidden until unlocked) -->
          <div id="codArea" style="display:none">
            <div class="muted">Upload photo or video</div>
            <input type="file" id="codFile" accept="image/*,video/*" />
            <div class="row">
              <button class="btn primary" id="codUpload">Upload</button>
              <div id="codStatus" class="muted"></div>
            </div>
            <div style="flex:1;border:1px dashed #2a2c39;border-radius:12px;display:flex;align-items:center;justify-content:center;opacity:.7;margin-top:8px">
              <span>Preview area</span>
            </div>
          </div>
        </div>
      </section>
    </div>
    <!-- /NEW: THREE-BOX ROW -->

    <!-- TOP ROW -->
    <div class="gridTop">
      <!-- Live Stream (big) -->
      <section class="card bigPane">
        <h2>Live Stream <span class="live-pill"><span class="dot"></span> LIVE</span></h2>
        <div class="card-body" style="flex:1;display:flex;">
          <div class="live-box" style="flex:1;"><span style="opacity:.65">[ Embed live stream here ]</span></div>
        </div>
      </section>

      <!-- Chat Room (big) -->
      <section class="card bigPane">
        <h2>Chat Room</h2>
        <div class="card-body" style="display:flex;flex-direction:column;gap:10px;flex:1">
          <!-- Top controls -->
          <div class="row" style="justify-content:space-between">
            <div class="muted" id="meTag">(not in chat)</div>
            <div class="row">
              <button class="btn primary" id="enterChatBtn">Enter Chat</button>
              <button class="btn" id="leaveChatBtn" style="display:none">Leave</button>
            </div>
          </div>

          <!-- Room selector -->
          <div class="row" id="roomBar" style="display:none">
            <label class="muted" for="roomSelect">Room</label>
            <select id="roomSelect"></select>
          </div>

          <!-- Feed -->
          <div class="chat-feed" id="chatFeed" aria-live="polite"></div>

          <!-- Send row -->
          <div class="chat-send" id="sendRow" style="display:none">
            <input id="chatInput" placeholder="Type a message…" />
            <button class="btn primary" id="chatSend">Send</button>
          </div>
        </div>
      </section>
    </div>

    <!-- BOTTOM ROW -->
    <div class="gridBottom">
      <!-- Chaos Board -->
      <section class="card smallPane">
        <h2>Chaos Board</h2>
        <div class="card-body" style="display:flex;flex-direction:column;gap:10px;flex:1">
          <div class="row" style="justify-content:space-between">
            <div></div>
            <button class="btn primary" id="uploadChaos">Submit Chaos Story</button>
          </div>
          <div class="list" id="chaosList"></div>
        </div>
      </section>

      <!-- Review Board -->
      <section class="card smallPane">
        <h2>Review Board</h2>
        <div class="card-body" style="display:flex;flex-direction:column;gap:10px;flex:1">
          <div class="row" style="justify-content:space-between">
            <div></div>
            <button class="btn primary" id="uploadReview">Submit Review</button>
          </div>
          <div class="list" id="reviewList"></div>
        </div>
      </section>
    </div>
  </main>

  <!-- Chaos Submit Modal -->
  <div class="modal-backdrop" id="chaosModal">
    <div class="modal">
      <h3>Submit Chaos Story</h3>
      <label class="muted" for="cTitle">Title (max 60 chars)</label>
      <input id="cTitle" maxlength="60" placeholder="Walked Out on the Check" />
      <label class="muted" for="cAbout" style="margin-top:8px">About (name or @username)</label>
      <input id="cAbout" placeholder="@TheirHandle or Name" />
      <label class="muted" for="cBody" style="margin-top:8px">Story</label>
      <textarea id="cBody" rows="5" placeholder="Tell us what happened…"></textarea>
      <div class="actions">
        <button class="btn" id="cCancel">Cancel</button>
        <button class="btn primary" id="cSave">Submit</button>
      </div>
    </div>
  </div>

  <!-- Review Submit Modal -->
  <div class="modal-backdrop" id="reviewModal">
    <div class="modal">
      <h3>Submit Review</h3>
      <label class="muted" for="rTitle">Title (max 60 chars)</label>
      <input id="rTitle" maxlength="60" placeholder="Good Chat, No Show" />
      <label class="muted" for="rAbout" style="margin-top:8px">About (name or @username)</label>
      <input id="rAbout" placeholder="@TheirHandle or Name" />
      <label class="muted" for="rBody" style="margin-top:8px">Review</label>
      <textarea id="rBody" rows="5" placeholder="Keep receipts, keep it real…"></textarea>
      <div class="actions">
        <button class="btn" id="rCancel">Cancel</button>
        <button class="btn primary" id="rSave">Submit</button>
      </div>
    </div>
  </div>

  <!-- Story/Review Detail Modal (shared) -->
  <div class="modal-backdrop" id="detailModal">
    <div class="modal">
      <h3 id="detailTitle">Title</h3>
      <div class="muted" id="detailMeta" style="margin-bottom:8px"></div>
      <div id="detailBody" style="white-space:pre-wrap"></div>
      <div class="actions">
        <button class="btn" id="detailClose">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* ===== Firebase Imports ===== */
    import { auth, db } from "./js/firebase.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, addDoc, serverTimestamp, onSnapshot, query, orderBy, limit, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    /* ===== Chat (Firestore) ===== */
    const ROOMS = [
      { id: "general",      label: "#general" },
      { id: "first-dates",  label: "#first-dates" },
      { id: "gym-rats",     label: "#gym-rats" },
      { id: "chaos-lounge", label: "#chaos-lounge" },
    ];
    let me = null;
    let myDisplayName = ""; // from users/{uid}
    let currentRoom = ROOMS[0].id;
    let unsubFeed = null;

    // DOM: chat
    const meTag = document.getElementById("meTag");
    const enterChatBtn = document.getElementById("enterChatBtn");
    const leaveChatBtn = document.getElementById("leaveChatBtn");
    const roomBar = document.getElementById("roomBar");
    const roomSelect = document.getElementById("roomSelect");
    const chatFeed = document.getElementById("chatFeed");
    const sendRow = document.getElementById("sendRow");
    const chatInput = document.getElementById("chatInput");
    const chatSend = document.getElementById("chatSend");

    // Boards DOM
    const chaosList = document.getElementById("chaosList");
    const reviewList = document.getElementById("reviewList");
    const chaosModal = document.getElementById("chaosModal");
    const cTitle = document.getElementById("cTitle");
    const cAbout = document.getElementById("cAbout");
    const cBody  = document.getElementById("cBody");
    const cCancel= document.getElementById("cCancel");
    const cSave  = document.getElementById("cSave");
    const reviewModal = document.getElementById("reviewModal");
    const rTitle = document.getElementById("rTitle");
    const rAbout = document.getElementById("rAbout");
    const rBody  = document.getElementById("rBody");
    const rCancel= document.getElementById("rCancel");
    const rSave  = document.getElementById("rSave");

    const detailModal = document.getElementById("detailModal");
    const detailTitle = document.getElementById("detailTitle");
    const detailMeta  = document.getElementById("detailMeta");
    const detailBody  = document.getElementById("detailBody");
    const detailClose = document.getElementById("detailClose");

    /* ===== Helpers ===== */
    function open(el){ el.style.display = "flex"; }
    function close(el){ el.style.display = "none"; }
    function setSigned(on){
      const label = (ROOMS.find(r=>r.id===currentRoom)?.label) || "#general";
      meTag.textContent = on ? `In ${label} as ${myDisplayName}` : "(not in chat)";
      enterChatBtn.style.display = on ? "none" : "inline-flex";
      leaveChatBtn.style.display = on ? "inline-flex" : "none";
      roomBar.style.display = on ? "flex" : "none";
      sendRow.style.display = on ? "flex" : "none";
    }
    function renderRooms(){
      roomSelect.innerHTML = "";
      ROOMS.forEach(r=>{
        const opt = document.createElement("option");
        opt.value = r.id; opt.textContent = r.label;
        if (r.id === currentRoom) opt.selected = true;
        roomSelect.appendChild(opt);
      });
    }
    function renderMessage(m){
      const b = document.createElement("div");
      b.className = "bubble " + (m.from === myDisplayName ? "me" : "them");
      b.textContent = `${m.from}: ${m.text}`;
      chatFeed.appendChild(b);
    }
    function clearFeed(){ chatFeed.innerHTML = ""; }

    async function bindRoomFeed(){
      if (unsubFeed) { unsubFeed(); unsubFeed = null; }
      clearFeed();
      const col = collection(db, "rooms", currentRoom, "messages");
      const qy = query(col, orderBy("createdAt","asc"), limit(500));
      unsubFeed = onSnapshot(qy, (snap)=>{
        clearFeed();
        snap.forEach(d => {
          const m = d.data();
          renderMessage({ from: m.from || "anon", text: m.text || "" });
        });
        chatFeed.scrollTop = chatFeed.scrollHeight;
      });
    }

    async function sendMessage(){
      const text = chatInput.value.trim();
      if (!text) return;
      if (!me){ location.href = "./login.html"; return; }
      if (!myDisplayName){ alert("Your profile needs a username/display name."); return; }
      const col = collection(db, "rooms", currentRoom, "messages");
      await addDoc(col, { from: myDisplayName, text, createdAt: serverTimestamp(), uid: me.uid });
      chatInput.value = "";
    }

    function bestVisibleNameFromDoc(docData){
      const uname = (docData?.username || "").trim();
      const disp  = (docData?.displayName || "").trim();
      if (uname) return uname.startsWith("@") ? uname : "@"+uname;
      if (disp)  return disp;
      return "";
    }

    /* ===== Boards (simple in-memory with 1 example each) ===== */
    const chaosItems = [{
      title: "Walked Out on the Check",
      author: "@Rae25",
      about: "@Jamie27",
      body: "We agreed to split. They ‘forgot’ their wallet. I left a bigger tip for the server and a smaller chance for a second date."
    }];
    const reviewItems = [{
      title: "Great Banter, Late Arrival",
      author: "@Andre31",
      about: "@Rae25",
      body: "Funny, sharp, showed with coffee… 18 minutes late. Would try again—with a buffer."
    }];

    function renderBoard(listEl, items){
      listEl.innerHTML = "";
      items.forEach((it)=>{
        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="title" title="${escapeHtml(it.title)}">${escapeHtml(it.title)}</div>
          <div class="meta">by ${escapeHtml(it.author)} about ${escapeHtml(it.about)}</div>
        `;
        card.addEventListener("click", ()=>{
          detailTitle.textContent = it.title;
          detailMeta.textContent = `by ${it.author} about ${it.about}`;
          detailBody.textContent = it.body;
          open(detailModal);
        });
        listEl.appendChild(card);
      });
    }
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    // Submit handlers (still in-memory for now)
    cSave.addEventListener("click", ()=>{
      const title = (cTitle.value||"").trim().slice(0,60);
      const about = (cAbout.value||"").trim();
      const body  = (cBody.value||"").trim();
      if (!title || !about || !body) return;
      const author = myDisplayName || "Member";
      chaosItems.unshift({ title, author, about, body });
      renderBoard(chaosList, chaosItems);
      cTitle.value = ""; cAbout.value = ""; cBody.value = "";
      close(chaosModal);
    });
    rSave.addEventListener("click", ()=>{
      const title = (rTitle.value||"").trim().slice(0,60);
      const about = (rAbout.value||"").trim();
      const body  = (rBody.value||"").trim();
      if (!title || !about || !body) return;
      const author = myDisplayName || "Member";
      reviewItems.unshift({ title, author, about, body });
      renderBoard(reviewList, reviewItems);
      rTitle.value = ""; rAbout.value = ""; rBody.value = "";
      close(reviewModal);
    });

    // Modal toggles (chaos/reviews/details)
    document.getElementById("uploadChaos").addEventListener("click", ()=> open(chaosModal));
    document.getElementById("uploadReview").addEventListener("click", ()=> open(reviewModal));
    document.getElementById("cCancel").addEventListener("click", ()=> close(chaosModal));
    document.getElementById("rCancel").addEventListener("click", ()=> close(reviewModal));
    chaosModal.addEventListener("click", (e)=>{ if(e.target===chaosModal) close(chaosModal); });
    reviewModal.addEventListener("click", (e)=>{ if(e.target===reviewModal) close(reviewModal); });
    document.getElementById("detailClose").addEventListener("click", ()=> close(detailModal));
    detailModal.addEventListener("click", (e)=>{ if(e.target===detailModal) close(detailModal); });

    /* ===== Chat controls (no anonymous) ===== */
    enterChatBtn.addEventListener("click", async ()=>{
      if (!me) { location.href = "./login.html"; return; }
      if (!myDisplayName){ alert("Your profile needs a username/display name."); return; }
      setSigned(true);
      renderRooms();
      await bindRoomFeed();
      chatInput.focus();
    });
    leaveChatBtn.addEventListener("click", ()=>{
      if (unsubFeed) { unsubFeed(); unsubFeed = null; }
      setSigned(false);
    });
    roomSelect.addEventListener("change", async (e)=>{
      currentRoom = e.target.value;
      if (leaveChatBtn.style.display !== "none") await bindRoomFeed();
    });
    chatSend.addEventListener("click", sendMessage);
    chatInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendMessage(); });

    /* ===== Auth: derive visible name from users/{uid} ===== */
    onAuthStateChanged(auth, async (user)=>{
      me = user || null;
      myDisplayName = "";
      if (me) {
        try {
          const uref = doc(db, "users", me.uid);
          const snap = await getDoc(uref);
          if (snap.exists()) myDisplayName = bestVisibleNameFromDoc(snap.data());
          if (!myDisplayName) {
            const emailName = (me.email || "").split("@")[0];
            myDisplayName = emailName || "Member";
          }
        } catch (e) {
          const emailName = (me?.email || "").split("@")[0];
          myDisplayName = emailName || "Member";
        }
      }
      setSigned(false);
    });

    /* ===== Casualties password + upload (placeholder UI only) ===== */
    const codLock   = document.getElementById("codLock");
    const codArea   = document.getElementById("codArea");
    const codPwd    = document.getElementById("codPwd");
    const codUnlock = document.getElementById("codUnlock");
    const codMsg    = document.getElementById("codMsg");
    const codFile   = document.getElementById("codFile");
    const codUpload = document.getElementById("codUpload");
    const codStatus = document.getElementById("codStatus");

    codUnlock?.addEventListener("click", ()=>{
      if ((codPwd.value || "") === "Spark"){
        codLock.style.display = "none";
        codArea.style.display = "block";
        codMsg.textContent = "";
      } else {
        codMsg.textContent = "Wrong password.";
      }
    });

    codUpload?.addEventListener("click", ()=>{
      const f = codFile.files?.[0];
      codStatus.textContent = f ? `Ready: ${f.name}` : "Select a file first.";
    });

    /* ===== Init ===== */
    (function init(){
      renderRooms();
      renderBoard(chaosList, chaosItems);
      renderBoard(reviewList, reviewItems);
    })();
  </script>
</body>
</html>
```0
