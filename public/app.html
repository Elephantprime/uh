<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNHINGED — App</title>
  <meta name="theme-color" content="#E11D2A" />
  <style>
    :root{--bg:#0e0e12;--panel:#15161b;--panel2:#1a1b22;--muted:#cfd0de;--red:#E11D2A;--green:#4CAF50;--br:16px}
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:#fff;font:500 16px/1.5 system-ui,Segoe UI,Roboto,Arial}
    a{color:inherit;text-decoration:none}
    /* Top bar */
    .top{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#101117;border-bottom:1px solid #222}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:14px;height:14px;border-radius:4px;background:var(--red);box-shadow:0 0 18px #e11d2a}
    .word{font-weight:900;letter-spacing:.02em}
    .nav{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:1px solid #2a2a2a;background:#20222b;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--red);border-color:var(--red)}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 10px;font-size:.9rem}
    /* Grid */
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:minmax(360px,auto);gap:16px}
    .card{background:var(--panel);border:1px solid #25262f;border-radius:var(--br);overflow:hidden;display:flex;flex-direction:column}
    .head{padding:14px 16px;border-bottom:1px solid #25262f;font-weight:900;font-size:1.25rem}
    .body{padding:14px 16px;flex:1;min-height:0}
    .subtle{color:var(--muted)}
    /* Live */
    .live-box{height:100%;border-radius:12px;background:linear-gradient(180deg,#0b0b10,#0f1016);border:1px dashed #2a2b36;display:flex;align-items:center;justify-content:center;position:relative}
    .live-ind{position:absolute;top:8px;right:10px;display:flex;align-items:center;gap:6px;font-size:.88rem}
    .led{width:8px;height:8px;border-radius:50%;background:#ff4d4d;box-shadow:0 0 10px #ff4d4d;animation:pulse 1.8s infinite}
    @keyframes pulse{50%{opacity:.55}}
    /* Chat */
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .chat-top{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
    .room{display:flex;gap:8px;align-items:center}
    select, input[type="text"], textarea{background:#12131a;color:#fff;border:1px solid #2a2a2a;border-radius:8px;padding:8px}
    .enter-line{display:flex;gap:8px;align-items:center}
    .chat-log{height:260px;background:var(--panel2);border:1px solid #25262f;border-radius:12px;padding:10px;overflow:auto}
    .msg{margin:6px 0;max-width:78%}
    .me{margin-left:auto;background:#e11d2a;color:#fff;padding:8px 10px;border-radius:12px 12px 4px 12px;display:inline-block}
    .them{background:#2a2b36;color:#fff;padding:8px 10px;border-radius:12px 12px 12px 4px;display:inline-block}
    .sendbar{display:flex;gap:8px;margin-top:8px}
    .sendbar input{flex:1}
    /* Lists (Chaos/Reviews) */
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px}
    .tile{border:1px solid #2a2a2a;border-radius:12px;padding:10px;background:#12131a;cursor:pointer}
    .title{font-weight:800;margin-bottom:4px}
    .meta{font-size:.85rem;color:var(--muted)}
    .search{display:flex;gap:8px;margin-bottom:8px}
    .hint{color:var(--muted);font-size:.9rem;margin-top:6px}
    .modal{position:fixed;inset:0;background:#0008;display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal-card{width:100%;max-width:720px;background:var(--panel);border:1px solid #2a2a2a;border-radius:12px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid #2a2a2a}
    .modal-body{padding:12px 14px}
    .limit{font-size:.85rem;color:#9aa0b3}
    .ghost{opacity:.75}
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="top">
    <div class="brand"><div class="dot"></div><div class="word">UNHINGED</div></div>
    <div class="nav">
      <a class="btn ghost" href="./profile.html">Profile</a>
      <a class="btn ghost" href="./login.html">Log in</a>
      <a class="btn primary" href="./signup.html">Join</a>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Live Stream -->
      <section class="card" id="liveCard">
        <div class="head">Live Stream</div>
        <div class="body">
          <div class="live-box">
            <div class="live-ind"><span class="led"></span><span class="ghost">Live</span></div>
            <div class="subtle">[ Embed live stream here ]</div>
          </div>
        </div>
      </section>

      <!-- Chat Room -->
      <section class="card" id="chatCard">
        <div class="head">Chat Room</div>
        <div class="body">
          <div class="chat-top">
            <div class="room">
              <label class="ghost" for="roomSel">Room</label>
              <select id="roomSel">
                <option value="general">#general</option>
                <option value="firstdates">#first-dates</option>
                <option value="gymrats">#gym-rats</option>
              </select>
            </div>
            <div class="enter-line">
              <span id="whoLine" class="ghost">(not in chat)</span>
              <button class="btn small" id="enterChatBtn">Enter Chat</button>
            </div>
          </div>

          <div class="chat-log" id="chatLog" aria-live="polite"></div>
          <div class="sendbar">
            <input id="chatInput" type="text" placeholder="Type a message…" disabled />
            <button class="btn" id="sendBtn" disabled>Send</button>
          </div>
        </div>
      </section>

      <!-- Chaos Board -->
      <section class="card" id="chaosCard">
        <div class="head">Chaos Board</div>
        <div class="body">
          <div class="search">
            <input id="chaosSearch" type="text" placeholder="Search by name or @username" />
            <button class="btn small" id="chaosSearchBtn">Search</button>
            <button class="btn small ghost" id="chaosClearBtn">Clear</button>
            <button class="btn small" id="newChaosBtn">Submit Chaos Story</button>
          </div>
          <div class="list" id="chaosList"></div>
          <div class="hint">Click a title to read the full story.</div>
        </div>
      </section>

      <!-- Review Board -->
      <section class="card" id="reviewCard">
        <div class="head">Review Board</div>
        <div class="body">
          <div class="search">
            <input id="reviewSearch" type="text" placeholder="Search by name or @username" />
            <button class="btn small" id="reviewSearchBtn">Search</button>
            <button class="btn small ghost" id="reviewClearBtn">Clear</button>
            <button class="btn small" id="newReviewBtn">Submit Review</button>
          </div>
          <div class="list" id="reviewList"></div>
          <div class="hint">Click a title to read the full review.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Story Modal (shared) -->
  <div class="modal" id="storyModal">
    <div class="modal-card">
      <div class="modal-head">
        <div id="storyModalTitle">Title</div>
        <button class="btn small ghost" id="closeStory">Close</button>
      </div>
      <div class="modal-body">
        <div class="meta" id="storyMeta"></div>
        <p id="storyText" style="white-space:pre-wrap;margin-top:8px"></p>
        <div id="storyImages" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
      </div>
    </div>
  </div>

  <!-- New Chaos -->
  <div class="modal" id="newChaosModal">
    <div class="modal-card">
      <div class="modal-head">
        <div>Submit Chaos Story</div>
        <button class="btn small ghost" id="closeNewChaos">Close</button>
      </div>
      <div class="modal-body">
        <label>Title <span class="limit">(max 60 chars)</span></label>
        <input id="chaosTitle" type="text" maxlength="60" placeholder="Walked Out on the Check" />
        <label>Story</label>
        <textarea id="chaosBody" rows="6" placeholder="Tell us the chaos…" ></textarea>
        <label>Optional image(s)</label>
        <input id="chaosFiles" type="file" accept="image/*" multiple />
        <div style="margin-top:10px"><button class="btn" id="saveChaos">Submit</button></div>
      </div>
    </div>
  </div>

  <!-- New Review -->
  <div class="modal" id="newReviewModal">
    <div class="modal-card">
      <div class="modal-head">
        <div>Submit Review</div>
        <button class="btn small ghost" id="closeNewReview">Close</button>
      </div>
      <div class="modal-body">
        <label>Title <span class="limit">(max 60 chars)</span></label>
        <input id="reviewTitle" type="text" maxlength="60" placeholder="Would Text Again (Maybe)" />
        <label>Review</label>
        <textarea id="reviewBody" rows="6" placeholder="Spill (respectfully) the tea…" ></textarea>
        <label>Optional image(s)</label>
        <input id="reviewFiles" type="file" accept="image/*" multiple />
        <div style="margin-top:10px"><button class="btn" id="saveReview">Submit</button></div>
      </div>
    </div>
  </div>

  <script type="module">
    /* ===== Imports ===== */
    import { auth, db, storage } from "./js/firebase.js";
    import {
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, doc, getDoc, setDoc, addDoc, getDocs, query, where,
      orderBy, limit, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import {
      ref as sRef, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* ===== DOM ===== */
    const enterChatBtn = document.getElementById("enterChatBtn");
    const whoLine      = document.getElementById("whoLine");
    const roomSel      = document.getElementById("roomSel");
    const chatLog      = document.getElementById("chatLog");
    const chatInput    = document.getElementById("chatInput");
    const sendBtn      = document.getElementById("sendBtn");

    const storyModal   = document.getElementById("storyModal");
    const closeStory   = document.getElementById("closeStory");
    const storyModalTitle = document.getElementById("storyModalTitle");
    const storyMeta    = document.getElementById("storyMeta");
    const storyText    = document.getElementById("storyText");
    const storyImages  = document.getElementById("storyImages");

    const chaosList = document.getElementById("chaosList");
    const chaosSearch = document.getElementById("chaosSearch");
    document.getElementById("chaosSearchBtn").onclick = ()=> loadChaos(chaosSearch.value.trim());
    document.getElementById("chaosClearBtn").onclick  = ()=> { chaosSearch.value=""; loadChaos(""); };
    const newChaosModal = document.getElementById("newChaosModal");
    document.getElementById("newChaosBtn").onclick = ()=> openModal(newChaosModal);
    document.getElementById("closeNewChaos").onclick = ()=> closeModal(newChaosModal);
    const chaosTitle = document.getElementById("chaosTitle");
    const chaosBody  = document.getElementById("chaosBody");
    const chaosFiles = document.getElementById("chaosFiles");
    document.getElementById("saveChaos").onclick = saveChaos;

    const reviewList = document.getElementById("reviewList");
    const reviewSearch = document.getElementById("reviewSearch");
    document.getElementById("reviewSearchBtn").onclick = ()=> loadReviews(reviewSearch.value.trim());
    document.getElementById("reviewClearBtn").onclick  = ()=> { reviewSearch.value=""; loadReviews(""); };
    const newReviewModal = document.getElementById("newReviewModal");
    document.getElementById("newReviewBtn").onclick = ()=> openModal(newReviewModal);
    document.getElementById("closeNewReview").onclick = ()=> closeModal(newReviewModal);
    const reviewTitle = document.getElementById("reviewTitle");
    const reviewBody  = document.getElementById("reviewBody");
    const reviewFiles = document.getElementById("reviewFiles");
    document.getElementById("saveReview").onclick = saveReview;

    closeStory.onclick = ()=> closeModal(storyModal);
    storyModal.addEventListener("click",(e)=>{ if(e.target===storyModal) closeModal(storyModal); });
    newChaosModal.addEventListener("click",(e)=>{ if(e.target===newChaosModal) closeModal(newChaosModal); });
    newReviewModal.addEventListener("click",(e)=>{ if(e.target===newReviewModal) closeModal(newReviewModal); });

    function openModal(m){ m.style.display="flex"; }
    function closeModal(m){ m.style.display="none"; }

    /* ===== State ===== */
    let me=null, myDoc=null;
    let chatUnsub=null;

    function displayNameFromProfile(){
      const u = myDoc || {};
      return (u.username && u.username.trim())
        ? `@${u.username.trim()}`
        : (u.displayName?.trim() || auth.currentUser?.displayName?.trim() || "Member");
    }

    /* ===== Chat ===== */
    enterChatBtn.onclick = () => {
      if (!me) { alert("Please log in first."); return; }
      whoLine.textContent = displayNameFromProfile() + " in " + roomLabel(roomSel.value);
      chatInput.disabled = false; sendBtn.disabled = false;
      chatInput.focus();
      subscribeRoom(roomSel.value);
    };
    roomSel.onchange = () => {
      if (!me || chatInput.disabled) return; // not entered yet
      subscribeRoom(roomSel.value);
      whoLine.textContent = displayNameFromProfile() + " in " + roomLabel(roomSel.value);
    };
    sendBtn.onclick = async () => {
      const text = chatInput.value.trim();
      if (!text || !me) return;
      const room = roomSel.value;
      await addDoc(collection(db,"rooms",room,"messages"), {
        uid: me.uid,
        name: displayNameFromProfile(),
        text,
        createdAt: serverTimestamp()
      });
      chatInput.value="";
    };
    function roomLabel(v){
      if (v==="firstdates") return "#first-dates";
      if (v==="gymrats")   return "#gym-rats";
      return "#general";
    }
    function subscribeRoom(room){
      if (chatUnsub) { chatUnsub(); chatUnsub=null; }
      chatLog.innerHTML = "<div class='ghost'>Loading…</div>";
      const qy = query(collection(db,"rooms",room,"messages"), orderBy("createdAt","asc"), limit(300));
      chatUnsub = onSnapshot(qy, snap => {
        chatLog.innerHTML = "";
        snap.forEach(d=>{
          const m = d.data();
          const mine = (m.uid===me?.uid);
          const div = document.createElement("div");
          div.className = "msg";
          div.innerHTML = `<div class="${mine?'me':'them'}"><strong style="opacity:.85">${m.name||'Member'}:</strong> ${escapeHtml(m.text||'')}</div>`;
          chatLog.appendChild(div);
        });
        chatLog.scrollTop = chatLog.scrollHeight;
      });
    }

    /* ===== Chaos & Reviews ===== */
    function tile(item, kind){
      const el = document.createElement("div");
      el.className = "tile";
      const who = (item.authorUsername ? "@"+item.authorUsername : (item.authorName||"Member"));
      el.innerHTML = `
        <div class="title">${escapeHtml(item.title||"(untitled)")}</div>
        <div class="meta">${who} · ${new Date(item.createdAt?.seconds?item.createdAt.seconds*1000:Date.now()).toLocaleString()}</div>
      `;
      el.onclick = ()=> openStory(item, kind);
      return el;
    }
    function openStory(item, kind){
      storyModalTitle.textContent = item.title || "(untitled)";
      const who = (item.authorUsername ? "@"+item.authorUsername : (item.authorName||"Member"));
      storyMeta.textContent = `${kind} • ${who} • ${new Date(item.createdAt?.seconds?item.createdAt.seconds*1000:Date.now()).toLocaleString()}`;
      storyText.textContent = item.body || "";
      storyImages.innerHTML = "";
      (item.images||[]).forEach(url=>{
        const img = document.createElement("img");
        img.src = url; img.alt=""; img.style.maxWidth="160px"; img.style.borderRadius="8px";
        storyImages.appendChild(img);
      });
      openModal(storyModal);
    }
    async function saveChaos(){ await saveStory("chaos", chaosTitle.value, chaosBody.value, chaosFiles.files); closeModal(newChaosModal); chaosTitle.value=""; chaosBody.value=""; chaosFiles.value=""; loadChaos(chaosSearch.value.trim()); }
    async function saveReview(){ await saveStory("reviews", reviewTitle.value, reviewBody.value, reviewFiles.files); closeModal(newReviewModal); reviewTitle.value=""; reviewBody.value=""; reviewFiles.value=""; loadReviews(reviewSearch.value.trim()); }
    async function saveStory(kind, title, body, files){
      if (!me) { alert("Please log in first."); return; }
      title = (title||"").slice(0,60);
      const images = [];
      if (files && files.length){
        for (const f of files){
          const safe = (f.name||"img").replace(/[^\w.\-]+/g,"_");
          const path = `${kind}/${me.uid}/${Date.now()}_${safe}`;
          const r = sRef(storage, path);
          await uploadBytes(r, f);
          const url = await getDownloadURL(r);
          images.push(url);
        }
      }
      await addDoc(collection(db, kind), {
        uid: me.uid,
        authorName: myDoc?.displayName || auth.currentUser?.displayName || "Member",
        authorUsername: myDoc?.username || "",
        title, body, images,
        createdAt: serverTimestamp(),
      });
    }
    async function loadChaos(qstr=""){
      const out=[]; // Firestore can't OR two fields easily; fetch latest and filter client-side for now
      const snap = await getDocs(query(collection(db,"chaos"), orderBy("createdAt","desc"), limit(60)));
      snap.forEach(d=> out.push({ id:d.id, ...d.data() }));
      const filtered = qstr ? out.filter(x => matchSearch(x,qstr)) : out;
      chaosList.innerHTML = ""; filtered.forEach(x => chaosList.appendChild(tile(x,"Chaos")));
    }
    async function loadReviews(qstr=""){
      const out=[];
      const snap = await getDocs(query(collection(db,"reviews"), orderBy("createdAt","desc"), limit(60)));
      snap.forEach(d=> out.push({ id:d.id, ...d.data() }));
      const filtered = qstr ? out.filter(x => matchSearch(x,qstr)) : out;
      reviewList.innerHTML = ""; filtered.forEach(x => reviewList.appendChild(tile(x,"Review")));
    }
    function matchSearch(x, q){
      const s = q.toLowerCase();
      return (x.authorUsername && ("@"+x.authorUsername).toLowerCase().includes(s))
          || (x.authorName && x.authorName.toLowerCase().includes(s));
    }

    /* ===== Utils ===== */
    function escapeHtml(str){
      return String(str||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    /* ===== Seed example entries (once per user) ===== */
    async function seedExamplesOnce(){
      if (!me) return;
      const flagDoc = await getDoc(doc(db,"users",me.uid,"_flags","seedExamples"));
      if (flagDoc.exists()) return;
      // chaos
      await addDoc(collection(db,"chaos"), {
        uid: me.uid,
        authorName: myDoc?.displayName || "Member",
        authorUsername: myDoc?.username || "",
        title: "Walked Out on the Check",
        body: "First date. Great banter. When the bill landed, they said they were going to the restroom and… vanished. Waiter was cool; I tipped extra. Lesson learned.",
        images: [],
        createdAt: serverTimestamp()
      });
      // review
      await addDoc(collection(db,"reviews"), {
        uid: me.uid,
        authorName: myDoc?.displayName || "Member",
        authorUsername: myDoc?.username || "",
        title: "Would Text Again (Maybe)",
        body: "Fun, chaotic, disappears for weeks. 7/10 would text again after coffee and a clear plan.",
        images: [],
        createdAt: serverTimestamp()
      });
      await setDoc(doc(db,"users",me.uid,"_flags","seedExamples"), { at: serverTimestamp() });
    }

    /* ===== Auth / Init ===== */
    async function loadMyDoc(uid){
      const s = await getDoc(doc(db,"users",uid));
      return s.exists() ? s.data() : null;
    }
    onAuthStateChanged(auth, async (user)=>{
      me = user || null;
      if (me){
        myDoc = await loadMyDoc(me.uid);
        whoLine.textContent = "(click Enter Chat)";
        await seedExamplesOnce();
      }else{
        whoLine.textContent = "(not in chat)";
      }
      // initial loads
      loadChaos("");
      loadReviews("");
    });
  </script>
</body>
</html>
